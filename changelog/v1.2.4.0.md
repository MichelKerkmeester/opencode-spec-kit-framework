# v1.2.4.0

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**1.2.4.0**] - 2026-02-06

Adds **Context Window Budget (CWB)** system to the orchestrate agent, preventing context overflow when dispatching 5-20 sub-agents in parallel. Four new sections, nine cross-section updates.

> Spec folder: `004-agents/006-orchestrate-context-window` (Level 3+)

---

### New

**Context Window Budget System (§27)**

1. **Budget formula** — `available_budget = context_window - system_overhead - conversation_history - agent_definition` with conservative defaults (~150K tokens available for results)
2. **Scale thresholds** — Four tiers: 1-4 agents (direct/full), 5-9 (summary-only, 30 lines), 10-15 (file-based + waves of 5), 16-20 (file-based + waves of 5)
3. **Pre-dispatch checklist** — Mandatory CWB check for 5+ agent dispatches before any Task tool calls
4. **Enforcement points** — CWB validated at Step 5 (CWB CHECK), Step 6 (DELEGATE), and Step 9 (SYNTHESIZE)

**Result Collection Patterns (§28)**

5. **Pattern A: Direct Collection** — 1-4 agents, full results (up to 8K tokens each), no special handling
6. **Pattern B: Summary-Only** — 5-9 agents, max 30 lines (~500 tokens) per agent, all dispatched at once
7. **Pattern C: File-Based + Wave Batching** — 10-20 agents write to scratchpad files, return 3-line summary, dispatched in waves of 5 with synthesis between waves
8. **Background Agent Variant** — Alternative for Pattern C using `run_in_background: true` for maximum wall-clock parallelism
9. **Wave Synthesis Protocol** — 5-step compression flow between waves (review → extract → compress → release → dispatch next)
10. **"The Context Bomb" anti-pattern** — Documents the exact failure scenario: 10-20 agents complete, all results return simultaneously, context overflow, all work lost

**Anti-Patterns Section (§29)**

11. **Six documented anti-patterns** — Including "Never dispatch 5+ agents without CWB check", "Never accept sub-agent output blindly", "Never let sub-orchestrators return raw sub-agent outputs"

**Related Resources Section (§30)**

12. **Commands, Skills, and Agents reference tables** — Cross-references to all related OpenCode components

---

### Changed

**Core Workflow (§1)**

- Added step 5 **CWB CHECK** between DECOMPOSE and DELEGATE; renumbered steps 5→6 through 9→10
- Updated mermaid diagram with CWB CHECK node (gate styling)

**Sub-Orchestrator Pattern (§5)**

- Added **Context Budget** constraint: sub-orchestrators MUST compress results before returning to parent
- Added **Return Size Rule** subsection with max return sizes by sub-orchestrator scale (2-4K tokens)

**Resource Budgeting (§9)**

- Added **Orchestrator Self-Budget** subsection with budget component table (~25K overhead + ~15K agent def + ~10K history = ~150K available)

**Task Decomposition Format (§11)**

- Added **Output Size** field: `[full | summary-only (30 lines) | minimal (3 lines)]`
- Added **Write To** field: `[file path for detailed findings | "none"]`
- Added CWB Fields explanation block (mandatory for 5+ agent dispatches)

**Parallel vs Sequential (§13)**

- Renamed to "PARALLEL VS SEQUENTIAL ANALYSIS" with "(with CWB Ceiling)" subtitle
- Added **CWB CEILING** paragraph: parallel within waves, sequential between waves
- Added **Agent Count / Parallel Behavior** table

**Circuit Breaker (§17)**

- Added **"Context budget exceeded"** to edge cases: stop dispatching, synthesize current results, report to user
- Added **Context Overflow Protection** subsection with 4-step emergency protocol

**Context Preservation (§21)**

- Added **Agent dispatches (5+)** and **Context pressure** rows to health monitoring table
- Added proactive vs reactive note: CWB should be proactive (pre-dispatch), not reactive (post-overflow)

**Summary (§23)**

- Added Context Window Budget to Advanced Features
- Updated Parallel-First to show CWB ceiling with wave sizes by tier
- Added CWB enforcement to Limits

**Scaling Heuristics (§25)**

- Added **Collection Pattern (§28)** column mapping task types to patterns A/B/C
- Added **Est. Return per Agent** column with token estimates per tier

### Fixed

- **AGENTS.md** — Stale "Gate 4 Option B" → "Gate 3 Option B" in agent routing table; removed duplicate line in skill maintenance section

---

### Dependencies

- `opencode-antigravity-auth` — 1.4.3 → 1.4.5
- `@opencode-ai/plugin` — 1.1.51 → 1.1.53

**Validation:** `validate_document.py` PASSED · DQI 95/100 (EXCELLENT) · 20-agent mental simulation PASSES (~3K tokens vs ~160K old approach)

**Files:** `.opencode/agent/orchestrate.md` · `AGENTS.md` · `opencode.json` · `.opencode/package.json`

---

*For full release history, see the [global CHANGELOG](../CHANGELOG.md).*
