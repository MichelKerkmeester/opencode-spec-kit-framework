---
title: "MCP Server Core Modules"
description: "Central configuration, state management, and module coordination for the Spec Kit Memory MCP server."
trigger_phrases:
  - "core modules"
  - "mcp config"
  - "database state"
importance_tier: "normal"
---

# MCP Server Core Modules

> Central configuration, state management, and module coordination for the Spec Kit Memory MCP server.

---

<!-- ANCHOR:table-of-contents -->
## TABLE OF CONTENTS

- [1. OVERVIEW](#1--overview)
- [2. QUICK START](#2--quick-start)
- [3. STRUCTURE](#3--structure)
- [4. FEATURES](#4--features)
- [5. USAGE EXAMPLES](#5--usage-examples)
- [6. TROUBLESHOOTING](#6--troubleshooting)
- [7. RELATED DOCUMENTS](#7--related-documents)
<!-- /ANCHOR:table-of-contents -->

---

<!-- ANCHOR:overview -->
## 1. üìñ OVERVIEW

### What is this folder?

The `core/` folder contains essential infrastructure modules that provide configuration management, database state tracking, and shared utilities for the Spec Kit Memory MCP server. These modules are imported by all other server components.

### Key Features

| Feature | Description |
|---------|-------------|
| **Centralized Configuration** | Single source of truth for paths, limits, and system constants |
| **Database State Management** | External update detection, connection lifecycle, constitutional cache |
| **Mutex Protection** | HIGH-002 fix: Race condition prevention for concurrent requests |
| **Persistent Rate Limiting** | BUG-005 fix: Rate limit state survives server restarts |
| **Embedding Readiness** | Prevents search before model warmup completes |

### Requirements

| Requirement | Minimum | Purpose |
|-------------|---------|---------|
| Node.js | 18+ | Runtime environment |
| better-sqlite3 | 9.0.0+ | Database operations |
<!-- /ANCHOR:overview -->

---

<!-- ANCHOR:quick-start -->
## 2. üöÄ QUICK START

### Using Core Modules in Your Code

```typescript
// Individual named imports (recommended)
import { DATABASE_PATH, BATCH_SIZE, INDEX_SCAN_COOLDOWN } from './core/config';
import { checkDatabaseUpdated, getLastScanTime } from './core/db-state';

// Barrel import via index (re-exports everything from config + db-state)
import { DATABASE_PATH, checkDatabaseUpdated, init } from './core/index';

// At runtime, these resolve to dist/core/*.js files
// because __dirname in compiled code is dist/core/
```

### Initializing Database State

```typescript
import { init } from './core/index';

// Initialize with dependencies before use
init({
  vectorIndex,    // Vector index module
  checkpoints,    // Checkpoints module
  accessTracker,  // Access tracker module
  hybridSearch    // Hybrid search module
});

// Now safe to use db-state functions
import { checkDatabaseUpdated } from './core/index';
await checkDatabaseUpdated();
```

### Common Operations

```typescript
import {
  checkDatabaseUpdated,
  getLastScanTime,
  waitForEmbeddingModel,
  INDEX_SCAN_COOLDOWN
} from './core/index';

// Check for external database updates (BUG-001 fix)
const wasUpdated = await checkDatabaseUpdated();
if (wasUpdated) {
  console.log('Database reinitialized after external update');
}

// Get persistent rate limit timestamp (BUG-005 fix)
const lastScan = await getLastScanTime();
const now = Date.now();
if (now - lastScan < INDEX_SCAN_COOLDOWN) {
  throw new Error('Index scan on cooldown');
}

// Wait for embedding model before search
const ready = await waitForEmbeddingModel(30000);
if (!ready) {
  throw new Error('Embedding model warmup timeout');
}
```
<!-- /ANCHOR:quick-start -->

---

<!-- ANCHOR:structure -->
## 3. üìÅ STRUCTURE

```
core/
‚îú‚îÄ‚îÄ index.ts       # Module aggregator (re-exports config + db-state) [source]
‚îú‚îÄ‚îÄ config.ts      # Configuration constants and path management [source]
‚îú‚îÄ‚îÄ db-state.ts    # Database state management and lifecycle [source]
‚îî‚îÄ‚îÄ README.md      # This file
```

**Compiled output** (generated by `tsc`):
```
dist/core/
‚îú‚îÄ‚îÄ index.js       # Compiled module aggregator
‚îú‚îÄ‚îÄ config.js      # Compiled configuration
‚îî‚îÄ‚îÄ db-state.js    # Compiled database state manager
```

### Key Files

| File | Purpose | Exports |
|------|---------|---------|
| `index.ts` | Aggregates all core modules for convenient import | All config + db-state exports |
| `config.ts` | Defines paths, limits, and system constants | 8 categories of constants |
| `db-state.ts` | Manages database connection state and external updates | 12 state management functions |
<!-- /ANCHOR:structure -->

---

<!-- ANCHOR:features -->
## 4. ‚ö° FEATURES

### config.ts Features

**Path Constants**

| Constant | Description | Runtime Value (from dist/) |
|----------|-------------|---------------------------|
| `SERVER_DIR` | Server dist directory | `path.join(__dirname, '..')` -> `dist/` |
| `NODE_MODULES` | Node modules directory | `path.join(SERVER_DIR, 'node_modules')` |
| `LIB_DIR` | Library modules directory | `path.join(__dirname, '..', 'lib')` -> `dist/lib/` |
| `SHARED_DIR` | Shared modules directory | `path.join(SERVER_DIR, '..', 'shared')` |
| `DATABASE_DIR` | Database storage location | `SPEC_KIT_DB_DIR` env or `path.join(SERVER_DIR, 'database')` |
| `DATABASE_PATH` | Main SQLite file | `path.join(DATABASE_DIR, 'context-index.sqlite')` |
| `DB_UPDATED_FILE` | External update signal | `path.join(DATABASE_DIR, '.db-updated')` |

**Note:** At runtime, `__dirname` resolves to `dist/core/` (where the compiled code runs), so `SERVER_DIR` goes up one level (`..` -> `dist/`). `DATABASE_DIR` defaults to `path.join(SERVER_DIR, 'database')` which resolves to `dist/database/` unless overridden via the `SPEC_KIT_DB_DIR` environment variable (which is the typical configuration, pointing to `mcp_server/database/`).

**Batch Processing**

| Constant | Default | Environment Override | Description |
|----------|---------|---------------------|-------------|
| `BATCH_SIZE` | 5 | `SPEC_KIT_BATCH_SIZE` | Files processed concurrently |
| `BATCH_DELAY_MS` | 100 | `SPEC_KIT_BATCH_DELAY_MS` | Delay between batches |

**Rate Limiting**

| Constant | Value | Purpose |
|----------|-------|---------|
| `INDEX_SCAN_COOLDOWN` | 60000ms (1 min) | Prevents rapid repeated scans (L15) |

**Query Validation (SEC-003)**

| Constant | Value | Purpose |
|----------|-------|---------|
| `MAX_QUERY_LENGTH` | 10000 | Prevents resource exhaustion (BUG-007) |
| `INPUT_LIMITS.query` | 10000 | Search query max length |
| `INPUT_LIMITS.title` | 500 | Memory title max length |
| `INPUT_LIMITS.specFolder` | 200 | Spec folder path max length |
| `INPUT_LIMITS.contextType` | 100 | Context type max length |
| `INPUT_LIMITS.name` | 200 | Name field max length |
| `INPUT_LIMITS.prompt` | 10000 | Prompt text max length |
| `INPUT_LIMITS.filePath` | 500 | File path max length |

**Path Security**

| Constant | Description |
|----------|-------------|
| `DEFAULT_BASE_PATH` | Default workspace root (env `MEMORY_BASE_PATH` or CWD) |
| `ALLOWED_BASE_PATHS` | **Single source of truth** whitelist for file operations (prevents path traversal). Imported by formatters and handlers. Note: `lib/search/vector-index.ts` defines a separate, more restrictive set intentionally. |

**Cache Configuration**

| Constant | Value | Purpose |
|----------|-------|---------|
| `CONSTITUTIONAL_CACHE_TTL` | 60000ms (1 min) | Constitutional memory cache time-to-live |

### db-state.ts Features

**Initialization**

| Function | Purpose | Signature |
|----------|---------|-----------|
| `init(deps)` | Set module references before use | `(deps: DbStateDeps) => void` |

**External Update Detection (BUG-001 Fix)**

Detects when `generate-context.js` writes new memory files and reinitializes the database connection.

**Schema v4+ Migration**: Database includes FSRS cognitive memory columns (stability, difficulty, last_review, review_count) and memory_conflicts table for PE gate auditing (schema unified in v12).

| Function | Purpose | Returns |
|----------|---------|---------|
| `checkDatabaseUpdated()` | Check `.db-updated` file and reinit if needed | `Promise<boolean>` |
| `reinitializeDatabase()` | Close and reopen DB connection | `Promise<void>` |

**Mutex Protection (HIGH-002 Fix)**

Prevents race conditions when multiple concurrent requests trigger database reinitialization.

```javascript
// BEFORE (race condition):
// Request A: Calls reinitializeDatabase()
// Request B: Calls reinitializeDatabase() concurrently
// RESULT: Database corruption

// AFTER (mutex):
// Request A: Acquires mutex, reinitializes
// Request B: Waits for mutex release, skips reinit
// RESULT: Safe concurrent access
```

**Persistent Rate Limiting (BUG-005 Fix)**

Rate limit state persists across server restarts via database `config` table.

| Function | Purpose | Returns |
|----------|---------|---------|
| `getLastScanTime()` | Retrieve last scan timestamp from DB | `Promise<number>` |
| `setLastScanTime(time)` | Store scan timestamp in DB | `Promise<void>` |

**Embedding Model Readiness**

Prevents race conditions where search starts before model warmup completes.

| Function | Purpose | Returns |
|----------|---------|---------|
| `isEmbeddingModelReady()` | Check if model ready | `boolean` |
| `setEmbeddingModelReady(ready)` | Update readiness state | `void` |
| `waitForEmbeddingModel(timeoutMs)` | Wait with timeout (default 30000ms) | `Promise<boolean>` |

**Constitutional Cache**

Caches constitutional memories for 60 seconds to reduce database load.

| Function | Purpose |
|----------|---------|
| `getConstitutionalCache()` | Retrieve cached constitutional memories |
| `setConstitutionalCache(cache)` | Update cache with timestamp |
| `getConstitutionalCacheTime()` | Get cache creation timestamp |
| `clearConstitutionalCache()` | Invalidate cache |
<!-- /ANCHOR:features -->

---

<!-- ANCHOR:examples -->
## 5. üí° USAGE EXAMPLES

### Example 1: External Update Detection

```typescript
import { checkDatabaseUpdated } from './core/db-state';

// Check for external updates before each search
async function performSearch(query: string) {
  // BUG-001 fix: Detect external updates from generate-context.js
  await checkDatabaseUpdated();

  // Safe to search - DB connection is current
  return vectorIndex.search(query);
}
```

**Result**: Searches always use latest indexed data, even after external updates.

### Example 2: Rate Limit with Persistence

```typescript
import { getLastScanTime, setLastScanTime, INDEX_SCAN_COOLDOWN } from './core/index';

async function indexScan() {
  const lastScan = await getLastScanTime();
  const elapsed = Date.now() - lastScan;

  if (elapsed < INDEX_SCAN_COOLDOWN) {
    const wait = Math.ceil((INDEX_SCAN_COOLDOWN - elapsed) / 1000);
    throw new Error(`Index scan on cooldown. Wait ${wait} seconds.`);
  }

  // Perform scan...
  await performIndexing();

  // Update timestamp in database (BUG-005 fix)
  await setLastScanTime(Date.now());
}
```

**Result**: Rate limits persist across server restarts - prevents abuse.

### Example 3: Safe Concurrent Initialization

```typescript
import { reinitializeDatabase } from './core/db-state';

// Multiple concurrent requests safely handled
await Promise.all([
  reinitializeDatabase(),  // HIGH-002 fix: Acquires mutex
  reinitializeDatabase(),  // Waits for first to complete
  reinitializeDatabase()   // Waits for first to complete
]);
// Result: Only one reinitialization, others wait
```

### Example 4: Embedding Model Warmup

```typescript
import { waitForEmbeddingModel, setEmbeddingModelReady } from './core/db-state';

// Server startup
async function startServer() {
  console.log('Warming up embedding model...');
  await warmupModel();
  setEmbeddingModelReady(true);

  console.log('Server ready');
}

// Search handler
async function handleSearch(query: string) {
  const ready = await waitForEmbeddingModel(30000);
  if (!ready) {
    throw new Error('Embedding model not ready');
  }

  return performSearch(query);
}
```

### Common Patterns

| Pattern | Code | When to Use |
|---------|------|-------------|
| Check updates | `await checkDatabaseUpdated()` | Before every search operation |
| Validate input | `if (query.length > MAX_QUERY_LENGTH)` | User-provided strings |
| Rate limit check | `await getLastScanTime()` | Resource-intensive operations |
| Wait for model | `await waitForEmbeddingModel()` | Startup or first search |
<!-- /ANCHOR:examples -->

---

<!-- ANCHOR:troubleshooting -->
## 6. üõ†Ô∏è TROUBLESHOOTING

### Common Issues

#### Database Not Reloading After External Update

**Symptom**: New memory files indexed by `generate-context.js` don't appear in search results

**Cause**: `.db-updated` file not being created or read correctly

**Solution**:
```bash
# Verify update file exists
ls -la .opencode/skill/system-spec-kit/mcp_server/database/.db-updated

# Check timestamp is recent
cat .opencode/skill/system-spec-kit/mcp_server/database/.db-updated

# Force check in MCP server
# (Runs automatically before each memory_search call)
```

#### Race Condition Errors

**Symptom**: `SQLITE_BUSY` or database lock errors with concurrent requests

**Cause**: Multiple threads trying to reinitialize database simultaneously

**Solution**: HIGH-002 fix is already implemented - verify you're using `reinitializeDatabase()` from core module, not a custom implementation.

#### Rate Limit Not Persisting

**Symptom**: Rate limits reset after server restart

**Cause**: Not using `getLastScanTime()` / `setLastScanTime()` from core

**Solution**:
```typescript
// Use core functions, not local state
import { getLastScanTime, setLastScanTime } from './core/db-state';

// Store in database, not memory
await setLastScanTime(Date.now());
```

#### Initialization Errors

**Symptom**: `db-state not initialized: vector_index is null`

**Cause**: `init()` not called before using db-state functions

**Solution**:
```typescript
import { init } from './core/index';

// Initialize before use
init({
  vectorIndex: yourVectorIndex,
  checkpoints: yourCheckpoints,
  accessTracker: yourAccessTracker,
  hybridSearch: yourHybridSearch
});
```

### Quick Fixes

| Problem | Quick Fix |
|---------|-----------|
| DB not updating | Check `.db-updated` file exists and timestamp is recent |
| Race conditions | Verify using core module `reinitializeDatabase()` |
| Rate limit resets | Use `getLastScanTime()`/`setLastScanTime()` from core, not local state |
| Init errors | Call `init()` with all dependencies |

### Diagnostic Commands

```bash
# Check database update signal
cat .opencode/skill/system-spec-kit/mcp_server/database/.db-updated

# Verify rate limit persistence
sqlite3 .opencode/skill/system-spec-kit/mcp_server/database/context-index.sqlite \
  "SELECT * FROM config WHERE key='last_index_scan';"

# Check database connection
sqlite3 .opencode/skill/system-spec-kit/mcp_server/database/context-index.sqlite \
  "SELECT COUNT(*) FROM memory_index;"
```
<!-- /ANCHOR:troubleshooting -->

---

<!-- ANCHOR:related -->
## 7. üìö RELATED DOCUMENTS

### Internal Documentation

| Document | Purpose |
|----------|---------|
| [MCP Server README](../README.md) | Complete server documentation with all 22 MCP tools |
| [Vector Index Module](../lib/search/vector-index.ts) | Database operations using these config constants |
| [Context Server](../context-server.ts) | Main server entry point that imports core modules |

### Configuration References

| Document | Purpose |
|----------|---------|
| [Search Weights Config](../configs/search-weights.json) | Search ranking configuration |
| [Environment Variables](../../references/config/environment_variables.md) | Environment variable reference |

### Bug Fix Documentation

| Fix | Description | File |
|-----|-------------|------|
| BUG-001 | External update detection | `db-state.ts` |
| HIGH-002 | Mutex for concurrent reinit | `db-state.ts` |
| BUG-005 | Persistent rate limiting | `db-state.ts` |
| BUG-007 | Query length validation | `config.ts` |
| SEC-003 | Input length limits | `config.ts` |

### External Resources

| Resource | Description |
|----------|-------------|
| [Spec Kit Memory Skill](../../SKILL.md) | Parent skill documentation |
| [Database Schema](../../references/memory/memory_system.md) | Memory database structure |
<!-- /ANCHOR:related -->

---

**Architecture Note:**

All source code is written in TypeScript (`.ts` files) and compiled to JavaScript in the `dist/` directory. The `config.ts` module uses `__dirname` which resolves at runtime to `dist/core/`. `SERVER_DIR = path.join(__dirname, '..')` resolves to `dist/`. The `DATABASE_DIR` defaults to `path.join(SERVER_DIR, 'database')` but is typically overridden via the `SPEC_KIT_DB_DIR` environment variable to point to `mcp_server/database/`.

---

*Core modules version: 1.7.2 | Last updated: 2026-02-08*
