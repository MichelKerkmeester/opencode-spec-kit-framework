<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="ve-artifact-type" content="plan">
    <meta name="ve-source-doc" content="">
    <meta name="ve-speckit-level" content="3">
    <meta name="ve-view-mode" content="artifact-dashboard">
    <title>Implementation Plan | SpecKit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'dark' });</script>
    <style>
        :root {
            --bg: #131314;
            --surface: #1c1c1e;
            --text: #fafafa;
            --accent: #3b82f6;
            --muted: #71717a;
            --border: rgba(255, 255, 255, 0.08);

            --font-from-0: 13;
            --font-to-0: 17;
            --vw-from-0: calc(1 / 100);
            --vw-to-0: calc(991 / 100);
            --coefficient-0: calc((var(--font-to-0) - var(--font-from-0)) / (var(--vw-to-0) - var(--vw-from-0)));
            --base-0: calc((var(--font-from-0) - var(--vw-from-0) * var(--coefficient-0)) / 16);

            --font-from-1: 13;
            --font-to-1: 17;
            --vw-from-1: calc(991 / 100);
            --vw-to-1: calc(1440 / 100);
            --coefficient-1: calc((var(--font-to-1) - var(--font-from-1)) / (var(--vw-to-1) - var(--vw-from-1)));
            --base-1: calc((var(--font-from-1) - var(--vw-from-1) * var(--coefficient-1)) / 16);

            --font-from-2: 13;
            --font-to-2: 15;
            --vw-from-2: calc(1440 / 100);
            --vw-to-2: calc(1920 / 100);
            --coefficient-2: calc((var(--font-to-2) - var(--font-from-2)) / (var(--vw-to-2) - var(--vw-from-2)));
            --base-2: calc((var(--font-from-2) - var(--vw-from-2) * var(--coefficient-2)) / 16);

            --font-from-3: 16;
            --font-to-3: 21;
            --vw-from-3: calc(1920 / 100);
            --vw-to-3: calc(5120 / 100);
            --coefficient-3: calc((var(--font-to-3) - var(--font-from-3)) / (var(--vw-to-3) - var(--vw-from-3)));
            --base-3: calc((var(--font-from-3) - var(--vw-from-3) * var(--coefficient-3)) / 16);

            --font-size-4: 1.3125;
        }

        

        html {
            font-size: calc(var(--font-size-4) * 1rem);
            scroll-behavior: smooth;
            background-color: var(--bg);
            color: var(--text);
        }

        @media screen and (max-width: 5120px) {
            html { font-size: calc(var(--base-3) * 1rem + var(--coefficient-3) * 1vw); }
        }
        @media screen and (max-width: 1920px) {
            html { font-size: calc(var(--base-2) * 1rem + var(--coefficient-2) * 1vw); }
        }
        @media screen and (max-width: 1440px) {
            html { font-size: calc(var(--base-1) * 1rem + var(--coefficient-1) * 1vw); }
        }
        @media screen and (max-width: 991px) {
            html { font-size: calc(var(--base-0) * 1rem + var(--coefficient-0) * 1vw); }
        }

        body {
            font-family: 'Helvetica', sans-serif;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Layout */
        .page-container {
            width: 100%;
            max-width: 90rem;
            margin: 0 auto;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 4rem;
        }

        /* Sidebar Navigation */
        .toc-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--muted);
            padding: 0.4rem 0;
            transition: all 0.2s ease;
            letter-spacing: 0.05em;
        }
        .toc-link:hover { color: var(--text); }
        .toc-link.active { color: var(--accent); }
        .toc-link.active::before {
            content: '';
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
        }

        /* Elements */
        .terminal-header {
            border-bottom: 1px solid var(--border);
            background: rgba(19, 19, 20, 0.95);
            backdrop-filter: blur(12px);
            z-index: 100;
        }

        .ledger-line {
            height: 1px;
            background: linear-gradient(90deg, var(--border) 0%, transparent 100%);
            margin: 2rem 0;
        }

        .reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        .glass-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }
        .glass-card:hover { border-color: var(--accent); }

        .scanline {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(59, 130, 246, 0.05);
            opacity: 0.5;
            z-index: 200;
            pointer-events: none;
            animation: scan 10s linear infinite;
        }
        @keyframes scan { 0% { top: -2%; } 100% { top: 100%; } }

        .inline-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        /* Data Table */
        .data-table { width: 100%; text-align: left; font-size: 11px; }
        .data-table thead tr { border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); }
        .data-table th { padding: 1rem; color: var(--muted); font-weight: 600; letter-spacing: 0.1em; }
        .data-table td { padding: 1rem; }
        .data-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
        .data-table tbody tr:hover { background: rgba(255,255,255,0.04); }

        /* KPI Row */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .kpi-cell {
            background: var(--surface);
            padding: 1.25rem;
        }
        .kpi-label { font-size: 9px; font-weight: 600; letter-spacing: 0.15em; color: var(--muted); margin-bottom: 0.5rem; }
        .kpi-value { font-size: 14px; font-weight: 600; color: var(--text); }

        /* Status Badges */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.05em;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .status--green { background: rgba(34, 197, 94, 0.1); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.2); }
        .status--yellow { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .status--red { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

        /* Pipeline (Phase Timeline) */
        .pipeline { position: relative; padding-left: 2rem; }
        .pipeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--accent), var(--border));
        }
        .pipeline-stage {
            position: relative;
            padding-bottom: 2.5rem;
        }
        .pipeline-stage::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--bg);
            box-shadow: 0 0 0 2px var(--accent);
            z-index: 1;
        }
        .pipeline-stage.pending::before {
            background: var(--surface);
            box-shadow: 0 0 0 2px var(--muted);
        }

        /* Flow Steps (Critical Path) */
        .flow-step {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 1.5rem;
        }
        .flow-step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: var(--bg);
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .flow-step::after {
            content: '';
            position: absolute;
            left: 13px;
            top: 32px;
            bottom: -4px;
            width: 2px;
            background: var(--border);
        }
        .flow-step:last-child::after { display: none; }

        /* Callout */
        .callout--warning {
            border-left: 3px solid var(--warning);
            background: rgba(59, 130, 246, 0.05);
            border-radius: 0 8px 8px 0;
            padding: 1.5rem;
        }

        /* Viz Bar (Milestones) */
        .viz-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .viz-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #34d399);
            border-radius: 3px;
            width: 0;
            transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* Mermaid */
        .mermaid { background: transparent !important; }
        .mermaid svg { max-width: 100%; }

        /* Responsive */
        

        /* Accessibility */
        

        

        
    </style>
</head>
<body>
    <div class="selection:bg-blue-500/30 min-h-screen relative w-full">
        <div class="scanline"></div>

        <!-- Status Bar -->
        <div class="terminal-header sticky top-0 px-6 py-3 flex items-center justify-between text-[10px] font-semibold tracking-widest text-muted mono">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                    <span class="text-text">Plan Active</span>
                </div>
                <div class="hidden md:block">Phase: Implementation</div>
                <div class="hidden md:block">Risk: Low</div>
            </div>
            <div class="flex items-center gap-6">
                <div id="clock">00:00:00 UTC</div>
                <div class="text-accent">Plan: Approved // Ready</div>
            </div>
        </div>

        <div class="page-container px-6 lg:px-12 py-12">

            <!-- Hero Header -->
            <header class="mb-32 reveal" id="top">
                <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-12">
                    <div class="space-y-6">
                        <div class="inline-flex items-center gap-2 px-3 py-1 border border-blue-500/20 bg-blue-500/5 text-blue-400 text-[10px] font-semibold tracking-widest rounded">
                            142-session-context-compression // ContextType: Plan
                        </div>
                        <h1 class="text-7xl md:text-9xl font-semibold tracking-tighter leading-none">
                            Implementation<br><span class="text-accent">Plan.</span>
                        </h1>
                    </div>
                    <div class="lg:text-right space-y-6">
                        <div class="space-y-1">
                            <p class="text-[10px] text-muted font-semibold tracking-widest">Status / Approved</p>
                            <p class="text-3xl font-semibold mono">2026-02-28</p>
                        </div>
                        <div class="flex lg:justify-end gap-3">
                            <div class="px-4 py-2 border border-[rgba(255,255,255,0.08)] text-[10px] font-semibold tracking-widest rounded">
                                Tier: Critical
                            </div>
                            <div class="px-4 py-2 bg-text text-bg text-[10px] font-semibold tracking-widest rounded">
                                Level 3
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ledger-line"></div>
            </header>

            <div class="main-grid">

                <!-- Sidebar TOC -->
                <aside class="sidebar">
                    <nav class="sticky top-24 space-y-12">
                        <div class="space-y-4">
                            <p class="text-[10px] font-semibold tracking-[0.2em] text-muted">Plan Ledger</p>
                            <div id="sidebar-nav" class="flex flex-col gap-1">
                                <a href="#summary" class="toc-link active">01 Summary</a>
                                <a href="#quality-gates" class="toc-link">02 Quality Gates</a>
                                <a href="#architecture" class="toc-link">03 Architecture</a>
                                <a href="#phases" class="toc-link">04 Phases</a>
                                <a href="#testing" class="toc-link">05 Testing</a>
                                <a href="#dependencies" class="toc-link">06 Dependencies</a>
                                <a href="#rollback" class="toc-link">07 Rollback</a>
                                <a href="#dep-graph" class="toc-link">08 Dep Graph</a>
                                <a href="#critical-path" class="toc-link">09 Critical Path</a>
                                <a href="#milestones" class="toc-link">10 Milestones</a>
                                <a href="#verification" class="toc-link">11 Verification</a>
                            </div>
                        </div>
                    </nav>
                </aside>

                <!-- Content Area -->
                <main class="space-y-[clamp(4rem,10vh,8rem)]">

                    <!-- 01 Summary -->
                    <section id="summary" class="space-y-12 reveal">
                        <div class="space-y-8">
                            <h2 class="text-[10px] text-text tracking-[0.3em] font-semibold opacity-80 border-b border-[rgba(255,255,255,0.08)] pb-4">01 // Summary</h2>
                            <p class="text-3xl md:text-5xl font-semibold tracking-tighter text-zinc-200">
                                Intelligent context compression for long-running agent sessions.
                            </p>
                            <p class="text-zinc-400 text-sm leading-relaxed max-w-4xl">
                                This plan introduces a session-aware context compression layer that reduces token consumption by up to 60% during extended conversations. By analyzing semantic density and recency signals, the system identifies which context blocks to preserve verbatim, which to summarize, and which to evict entirely -- all while maintaining conversational coherence and task continuity.
                            </p>
                        </div>

                        <!-- Technical Context KPI Row -->
                        <div class="kpi-row mono">
                            <div class="kpi-cell">
                                <div class="kpi-label">Language / Stack</div>
                                <div class="kpi-value">TypeScript 5.4</div>
                            </div>
                            <div class="kpi-cell">
                                <div class="kpi-label">Framework</div>
                                <div class="kpi-value">Node.js + Vitest</div>
                            </div>
                            <div class="kpi-cell">
                                <div class="kpi-label">Storage</div>
                                <div class="kpi-value">SQLite / libSQL</div>
                            </div>
                            <div class="kpi-cell">
                                <div class="kpi-label">Testing</div>
                                <div class="kpi-value">Vitest + E2E</div>
                            </div>
                            <div class="kpi-cell">
                                <div class="kpi-label">Est. LOC</div>
                                <div class="kpi-value">~1,200</div>
                            </div>
                        </div>
                    </section>

                    <!-- 02 Quality Gates -->
                    <section id="quality-gates" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-accent tracking-[0.3em] font-semibold border-b border-[rgba(255,255,255,0.08)] pb-4">02 // Quality Gates</h2>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Definition of Ready -->
                            <div class="glass-card p-6 space-y-5">
                                <h3 class="text-xs font-semibold tracking-widest text-accent flex items-center gap-2">
                                    <iconify-icon icon="lucide:clipboard-check"></iconify-icon>
                                    Definition of Ready
                                </h3>
                                <ul class="space-y-3 text-sm text-zinc-400">
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>Spec folder created with Level 3 documentation</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>Research phase complete with evidence-based decisions</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>Architecture review passed by tech lead</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>All external dependencies identified and version-locked</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>Rollback procedure documented and tested in staging</span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Definition of Done -->
                            <div class="glass-card p-6 space-y-5">
                                <h3 class="text-xs font-semibold tracking-widest text-accent flex items-center gap-2">
                                    <iconify-icon icon="lucide:flag"></iconify-icon>
                                    Definition of Done
                                </h3>
                                <ul class="space-y-3 text-sm text-zinc-400">
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>All checklist items verified with evidence</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:check" class="text-success mt-0.5 text-base"></iconify-icon>
                                        <span>Test suite passes: unit, integration, and E2E</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:x" class="text-danger mt-0.5 text-base"></iconify-icon>
                                        <span>Performance benchmarks meet 60% compression target</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:x" class="text-danger mt-0.5 text-base"></iconify-icon>
                                        <span>Implementation summary written and peer-reviewed</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <iconify-icon icon="lucide:x" class="text-danger mt-0.5 text-base"></iconify-icon>
                                        <span>Memory context saved for future session recovery</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- 03 Architecture -->
                    <section id="architecture" class="space-y-12 reveal">
                        <div class="space-y-8">
                            <h2 class="text-[10px] text-text tracking-[0.3em] font-semibold opacity-80 border-b border-[rgba(255,255,255,0.08)] pb-4">03 // Architecture</h2>
                            <p class="text-zinc-400 text-sm leading-relaxed max-w-4xl">
                                The compression engine follows a pipeline architecture with three discrete stages: analysis, scoring, and transformation. Each stage is independently testable and can be bypassed via feature flags for safe rollout.
                            </p>
                        </div>

                        <!-- Key Components -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="glass-card p-6 space-y-3">
                                <h4 class="font-semibold text-accent text-sm flex items-center gap-2">
                                    <iconify-icon icon="lucide:scan-search"></iconify-icon>
                                    Semantic Analyzer
                                </h4>
                                <p class="text-xs text-zinc-400 leading-relaxed">
                                    Scores each context block by semantic density, reference frequency, and temporal recency. Produces a ranked priority list used by downstream stages.
                                </p>
                            </div>
                            <div class="glass-card p-6 space-y-3">
                                <h4 class="font-semibold text-accent text-sm flex items-center gap-2">
                                    <iconify-icon icon="lucide:layers"></iconify-icon>
                                    Compression Router
                                </h4>
                                <p class="text-xs text-zinc-400 leading-relaxed">
                                    Decides per-block strategy: preserve (high signal), summarize (medium signal), or evict (low signal). Uses configurable thresholds with sensible defaults.
                                </p>
                            </div>
                            <div class="glass-card p-6 space-y-3">
                                <h4 class="font-semibold text-accent text-sm flex items-center gap-2">
                                    <iconify-icon icon="lucide:git-merge"></iconify-icon>
                                    Context Assembler
                                </h4>
                                <p class="text-xs text-zinc-400 leading-relaxed">
                                    Reconstructs the compressed context window, inserting summaries and continuity markers. Validates coherence via overlap detection before emitting the final payload.
                                </p>
                            </div>
                        </div>

                        <!-- Architecture Mermaid Diagram -->
                        <div class="glass-card p-6">
                            <h4 class="text-xs font-semibold tracking-widest text-muted mb-6">Component Relationships</h4>
                            <div class="mermaid">
flowchart LR
    A[Session Input] --> B[Semantic Analyzer]
    B --> C{Compression Router}
    C -->|Preserve| D[Verbatim Buffer]
    C -->|Summarize| E[Summary Generator]
    C -->|Evict| F[Eviction Log]
    D --> G[Context Assembler]
    E --> G
    F -.->|Audit Trail| H[(SQLite Store)]
    G --> I[Compressed Output]
    H -.->|Recovery| G
            </div>
                        </div>
                    </section>

                    <!-- 04 Implementation Phases -->
                    <section id="phases" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-accent tracking-[0.3em] font-semibold border-b border-[rgba(255,255,255,0.08)] pb-4">04 // Implementation Phases</h2>

                        <div class="pipeline">
                            <!-- Phase 1 -->
                            <div class="pipeline-stage">
                                <div class="glass-card p-6 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-semibold text-sm text-accent">Phase 1: Core Analyzer</h4>
                                        <span class="status status--green">Complete</span>
                                    </div>
                                    <p class="text-xs text-zinc-400 leading-relaxed">Build the semantic analysis pipeline that scores context blocks by density and recency.</p>
                                    <ul class="space-y-2 text-xs text-zinc-400">
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square-check" class="text-success"></iconify-icon> Implement block tokenizer with boundary detection</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square-check" class="text-success"></iconify-icon> Build semantic density scorer (TF-IDF variant)</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square-check" class="text-success"></iconify-icon> Add temporal recency weighting with configurable decay</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square-check" class="text-success"></iconify-icon> Write unit tests for scoring edge cases</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Phase 2 -->
                            <div class="pipeline-stage">
                                <div class="glass-card p-6 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-semibold text-sm text-accent">Phase 2: Router + Summarizer</h4>
                                        <span class="status status--yellow">In Progress</span>
                                    </div>
                                    <p class="text-xs text-zinc-400 leading-relaxed">Implement the decision router and summary generation layer.</p>
                                    <ul class="space-y-2 text-xs text-zinc-400">
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square-check" class="text-success"></iconify-icon> Define threshold configuration schema (Zod)</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square-check" class="text-success"></iconify-icon> Implement three-way routing logic</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Build extractive summarizer for medium-signal blocks</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Add feature flag for dark-launch testing</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Phase 3 -->
                            <div class="pipeline-stage pending">
                                <div class="glass-card p-6 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-semibold text-sm text-zinc-400">Phase 3: Assembler + Integration</h4>
                                        <span class="status status--red">Pending</span>
                                    </div>
                                    <p class="text-xs text-zinc-400 leading-relaxed">Wire the full pipeline end-to-end and integrate with session management.</p>
                                    <ul class="space-y-2 text-xs text-zinc-400">
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Build context assembler with coherence validation</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Integrate eviction audit trail with SQLite store</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> End-to-end integration tests with session fixtures</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Performance benchmarking against compression targets</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Phase 4 -->
                            <div class="pipeline-stage pending">
                                <div class="glass-card p-6 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-semibold text-sm text-zinc-400">Phase 4: Hardening + Rollout</h4>
                                        <span class="status status--red">Pending</span>
                                    </div>
                                    <p class="text-xs text-zinc-400 leading-relaxed">Production readiness, staged rollout, and documentation closure.</p>
                                    <ul class="space-y-2 text-xs text-zinc-400">
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Dark-launch verification with all flags disabled</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Staged rollout: 10% / 50% / 100%</li>
                                        <li class="flex items-center gap-2"><iconify-icon icon="lucide:square" class="text-muted"></iconify-icon> Write implementation summary and close spec</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 05 Testing Strategy -->
                    <section id="testing" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-text tracking-[0.3em] font-semibold opacity-80 border-b border-[rgba(255,255,255,0.08)] pb-4">05 // Testing Strategy</h2>

                        <div class="overflow-x-auto glass-card">
                            <table class="data-table mono">
                                <thead>
                                    <tr>
                                        <th>Test Type</th>
                                        <th>Scope</th>
                                        <th>Tools</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-accent font-semibold">Unit</td>
                                        <td class="text-zinc-400">Semantic scorer, router logic, threshold config validation</td>
                                        <td class="text-zinc-400">Vitest, in-memory fixtures</td>
                                    </tr>
                                    <tr>
                                        <td class="text-accent font-semibold">Integration</td>
                                        <td class="text-zinc-400">Full pipeline: analyzer to assembler, SQLite audit trail</td>
                                        <td class="text-zinc-400">Vitest, test DB instance</td>
                                    </tr>
                                    <tr>
                                        <td class="text-accent font-semibold">E2E</td>
                                        <td class="text-zinc-400">Session simulation with multi-turn conversations</td>
                                        <td class="text-zinc-400">Custom harness, token counter</td>
                                    </tr>
                                    <tr>
                                        <td class="text-accent font-semibold">Performance</td>
                                        <td class="text-zinc-400">Compression ratio, latency under load, memory footprint</td>
                                        <td class="text-zinc-400">Vitest bench, hyperfine</td>
                                    </tr>
                                    <tr>
                                        <td class="text-accent font-semibold">Regression</td>
                                        <td class="text-zinc-400">Existing memory search, context retrieval, session recovery</td>
                                        <td class="text-zinc-400">Full test suite (CI gate)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- 06 Dependencies -->
                    <section id="dependencies" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-accent tracking-[0.3em] font-semibold border-b border-[rgba(255,255,255,0.08)] pb-4">06 // Dependencies</h2>

                        <div class="overflow-x-auto glass-card">
                            <table class="data-table mono">
                                <thead>
                                    <tr>
                                        <th>Dependency</th>
                                        <th>Version</th>
                                        <th>Status</th>
                                        <th>Impact if Blocked</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-zinc-300 font-semibold">better-sqlite3</td>
                                        <td class="text-zinc-400">^11.7.0</td>
                                        <td><span class="status status--green">Available</span></td>
                                        <td class="text-zinc-400">Blocks audit trail persistence layer</td>
                                    </tr>
                                    <tr>
                                        <td class="text-zinc-300 font-semibold">zod</td>
                                        <td class="text-zinc-400">^3.23.0</td>
                                        <td><span class="status status--green">Available</span></td>
                                        <td class="text-zinc-400">Blocks config schema validation</td>
                                    </tr>
                                    <tr>
                                        <td class="text-zinc-300 font-semibold">memory_search MCP</td>
                                        <td class="text-zinc-400">internal</td>
                                        <td><span class="status status--green">Available</span></td>
                                        <td class="text-zinc-400">Blocks integration with existing retrieval</td>
                                    </tr>
                                    <tr>
                                        <td class="text-zinc-300 font-semibold">session_manager</td>
                                        <td class="text-zinc-400">internal</td>
                                        <td><span class="status status--yellow">In Review</span></td>
                                        <td class="text-zinc-400">Delays Phase 3 integration; can stub</td>
                                    </tr>
                                    <tr>
                                        <td class="text-zinc-300 font-semibold">tiktoken (tokenizer)</td>
                                        <td class="text-zinc-400">^1.0.0</td>
                                        <td><span class="status status--green">Available</span></td>
                                        <td class="text-zinc-400">Blocks accurate token counting</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- 07 Rollback Plan -->
                    <section id="rollback" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-text tracking-[0.3em] font-semibold opacity-80 border-b border-[rgba(255,255,255,0.08)] pb-4">07 // Rollback Plan</h2>

                        <div class="callout--warning space-y-6">
                            <div class="flex items-center gap-3">
                                <iconify-icon icon="lucide:alert-triangle" class="text-warning text-xl"></iconify-icon>
                                <h4 class="font-semibold text-sm text-warning">Rollback Trigger Conditions</h4>
                            </div>
                            <p class="text-sm text-zinc-400 leading-relaxed">
                                Initiate rollback if compression ratio drops below 30%, if context coherence score falls under 0.7, or if more than 2 session recovery failures occur within a 24-hour window.
                            </p>

                            <div class="space-y-3">
                                <h5 class="text-xs font-semibold tracking-widest text-zinc-300">Procedure</h5>
                                <ol class="space-y-2 text-sm text-zinc-400 list-decimal list-inside">
                                    <li>Set <span class="inline-code">SPECKIT_COMPRESSION_ENABLED=false</span> to disable the pipeline</li>
                                    <li>Verify existing sessions fall back to uncompressed context delivery</li>
                                    <li>Check audit trail in <span class="inline-code">compression_log</span> table for anomaly patterns</li>
                                    <li>Run full regression suite to confirm no collateral damage</li>
                                    <li>Notify stakeholders via incident channel with root cause timeline</li>
                                </ol>
                            </div>

                            <div class="p-4 border border-[rgba(255,255,255,0.08)] rounded-lg bg-[rgba(0,0,0,0.2)]">
                                <h5 class="text-xs font-semibold tracking-widest text-zinc-300 mb-2">Data Reversal</h5>
                                <p class="text-xs text-zinc-400 leading-relaxed">
                                    No destructive data operations. The compression pipeline operates on ephemeral session state only. The audit trail is append-only and preserved regardless of rollback. No database migrations to reverse.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 08 Dependency Graph -->
                    <section id="dep-graph" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-accent tracking-[0.3em] font-semibold border-b border-[rgba(255,255,255,0.08)] pb-4">08 // Dependency Graph</h2>

                        <div class="glass-card p-6">
                            <h4 class="text-xs font-semibold tracking-widest text-muted mb-6">Component Dependencies</h4>
                            <div class="mermaid">
flowchart LR
    TOK[Tokenizer] --> SA[Semantic Analyzer]
    SA --> CR[Compression Router]
    CFG[Config Schema] --> CR
    CR --> SG[Summary Generator]
    CR --> VB[Verbatim Buffer]
    CR --> EL[Eviction Log]
    SG --> CA[Context Assembler]
    VB --> CA
    EL --> DB[(SQLite Store)]
    CA --> OUT[Session Output]
    SM[Session Manager] -.->|pending| CA
            </div>
                        </div>

                        <!-- Dependency Matrix -->
                        <div class="overflow-x-auto glass-card">
                            <table class="data-table mono text-center">
                                <thead>
                                    <tr>
                                        <th class="text-left">Module</th>
                                        <th>Tokenizer</th>
                                        <th>Analyzer</th>
                                        <th>Router</th>
                                        <th>Assembler</th>
                                        <th>Store</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-left text-zinc-300 font-semibold">Tokenizer</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-accent">out</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-muted">--</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-zinc-300 font-semibold">Analyzer</td>
                                        <td class="text-zinc-400">in</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-accent">out</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-muted">--</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-zinc-300 font-semibold">Router</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-zinc-400">in</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-accent">out</td>
                                        <td class="text-accent">out</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-zinc-300 font-semibold">Assembler</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-zinc-400">in</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-zinc-400">in</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-zinc-300 font-semibold">Store</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-muted">--</td>
                                        <td class="text-zinc-400">in</td>
                                        <td class="text-accent">out</td>
                                        <td class="text-muted">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- 09 Critical Path -->
                    <section id="critical-path" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-text tracking-[0.3em] font-semibold opacity-80 border-b border-[rgba(255,255,255,0.08)] pb-4">09 // Critical Path</h2>

                        <div class="space-y-2">
                            <div class="flow-step" data-step="1">
                                <div class="space-y-1">
                                    <p class="text-sm font-semibold text-zinc-200">Block tokenizer + boundary detection</p>
                                    <p class="text-xs text-zinc-400">Foundation for all downstream processing. No parallelism possible.</p>
                                </div>
                            </div>
                            <div class="flow-step" data-step="2">
                                <div class="space-y-1">
                                    <p class="text-sm font-semibold text-zinc-200">Semantic density scorer</p>
                                    <p class="text-xs text-zinc-400">Depends on tokenizer output. Core ranking signal.</p>
                                </div>
                            </div>
                            <div class="flow-step" data-step="3">
                                <div class="space-y-1">
                                    <p class="text-sm font-semibold text-zinc-200">Compression router + threshold schema</p>
                                    <p class="text-xs text-zinc-400">Depends on scorer. Decision layer.</p>
                                    <div class="mt-2 p-3 border border-emerald-500/20 bg-emerald-500/5 rounded text-[11px] text-emerald-400">
                                        <iconify-icon icon="lucide:git-branch" class="mr-1"></iconify-icon>
                                        Parallel opportunity: Summary generator and eviction logger can start here.
                                    </div>
                                </div>
                            </div>
                            <div class="flow-step" data-step="4">
                                <div class="space-y-1">
                                    <p class="text-sm font-semibold text-zinc-200">Context assembler + coherence validation</p>
                                    <p class="text-xs text-zinc-400">Merges all streams. Final integration point.</p>
                                </div>
                            </div>
                            <div class="flow-step" data-step="5">
                                <div class="space-y-1">
                                    <p class="text-sm font-semibold text-zinc-200">E2E testing + performance benchmarks</p>
                                    <p class="text-xs text-zinc-400">Gate for rollout. Must hit compression and latency targets.</p>
                                    <div class="mt-2 p-3 border border-emerald-500/20 bg-emerald-500/5 rounded text-[11px] text-emerald-400">
                                        <iconify-icon icon="lucide:git-branch" class="mr-1"></iconify-icon>
                                        Parallel opportunity: Documentation and implementation summary can start here.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 10 Milestones -->
                    <section id="milestones" class="space-y-12 reveal">
                        <h2 class="text-[10px] text-accent tracking-[0.3em] font-semibold border-b border-[rgba(255,255,255,0.08)] pb-4">10 // Milestones</h2>

                        <div class="grid grid-cols-1 gap-6">
                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-semibold text-sm text-zinc-200">M1: Analyzer MVP</h4>
                                    <span class="mono text-xs text-muted">2026-03-07</span>
                                </div>
                                <p class="text-xs text-zinc-400 leading-relaxed">Semantic density scoring produces correct rankings on 10 reference sessions with 95% agreement against human labels.</p>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-[10px] mono">
                                        <span class="text-muted">Success Criteria: Scoring accuracy &ge; 95%</span>
                                        <span class="text-accent">100%</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill" data-width="100%"></div></div>
                                </div>
                            </div>

                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-semibold text-sm text-zinc-200">M2: Router + Summarizer</h4>
                                    <span class="mono text-xs text-muted">2026-03-14</span>
                                </div>
                                <p class="text-xs text-zinc-400 leading-relaxed">Three-way routing correctly classifies blocks across all density tiers. Extractive summaries retain key entities with &le; 40% token reduction per block.</p>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-[10px] mono">
                                        <span class="text-muted">Success Criteria: Classification accuracy &ge; 90%</span>
                                        <span class="text-warning">62%</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill" data-width="62%" style="background: linear-gradient(90deg, var(--warning), #fbbf24);"></div></div>
                                </div>
                            </div>

                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-semibold text-sm text-zinc-200">M3: Full Pipeline</h4>
                                    <span class="mono text-xs text-muted">2026-03-21</span>
                                </div>
                                <p class="text-xs text-zinc-400 leading-relaxed">End-to-end compression achieves &ge; 60% token reduction with coherence score &ge; 0.85 on the reference session corpus.</p>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-[10px] mono">
                                        <span class="text-muted">Success Criteria: 60% compression + 0.85 coherence</span>
                                        <span class="text-muted">0%</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill" data-width="0%"></div></div>
                                </div>
                            </div>

                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-semibold text-sm text-zinc-200">M4: Production Rollout</h4>
                                    <span class="mono text-xs text-muted">2026-03-28</span>
                                </div>
                                <p class="text-xs text-zinc-400 leading-relaxed">Staged rollout complete (10% / 50% / 100%). All regression tests green. Implementation summary approved and spec folder closed.</p>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-[10px] mono">
                                        <span class="text-muted">Success Criteria: Zero regressions at 100%</span>
                                        <span class="text-muted">0%</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill" data-width="0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 11 Verification Commands -->
                    <section id="verification" class="space-y-12 reveal mb-24">
                        <h2 class="text-[10px] text-text tracking-[0.3em] font-semibold opacity-80 border-b border-[rgba(255,255,255,0.08)] pb-4">11 // Verification Commands</h2>

                        <div class="space-y-6">
                            <div class="space-y-3">
                                <h4 class="text-xs font-semibold tracking-widest text-muted">Unit Tests</h4>
                                <div class="relative group">
                                    <div class="absolute top-3 right-3 text-[9px] font-semibold tracking-widest text-muted bg-black/60 px-2 py-1 rounded">Shell</div>
                                    <pre class="bg-[#1c1c1e] border border-[rgba(255,255,255,0.08)] rounded-lg p-5 pt-10 text-[11px] text-zinc-300 mono overflow-x-auto leading-relaxed"><code>npx vitest run --reporter=verbose \
  mcp_server/__tests__/compression/</code></pre>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h4 class="text-xs font-semibold tracking-widest text-muted">Integration Tests</h4>
                                <div class="relative group">
                                    <div class="absolute top-3 right-3 text-[9px] font-semibold tracking-widest text-muted bg-black/60 px-2 py-1 rounded">Shell</div>
                                    <pre class="bg-[#1c1c1e] border border-[rgba(255,255,255,0.08)] rounded-lg p-5 pt-10 text-[11px] text-zinc-300 mono overflow-x-auto leading-relaxed"><code>SPECKIT_COMPRESSION_ENABLED=true \
npx vitest run --reporter=verbose \
  mcp_server/__tests__/compression/integration/</code></pre>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h4 class="text-xs font-semibold tracking-widest text-muted">Performance Benchmark</h4>
                                <div class="relative group">
                                    <div class="absolute top-3 right-3 text-[9px] font-semibold tracking-widest text-muted bg-black/60 px-2 py-1 rounded">Shell</div>
                                    <pre class="bg-[#1c1c1e] border border-[rgba(255,255,255,0.08)] rounded-lg p-5 pt-10 text-[11px] text-zinc-300 mono overflow-x-auto leading-relaxed"><code>npx vitest bench \
  mcp_server/__tests__/compression/bench.ts</code></pre>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h4 class="text-xs font-semibold tracking-widest text-muted">Full Regression + Lint + Typecheck</h4>
                                <div class="relative group">
                                    <div class="absolute top-3 right-3 text-[9px] font-semibold tracking-widest text-muted bg-black/60 px-2 py-1 rounded">Shell</div>
                                    <pre class="bg-[#1c1c1e] border border-[rgba(255,255,255,0.08)] rounded-lg p-5 pt-10 text-[11px] text-zinc-300 mono overflow-x-auto leading-relaxed"><code>npx tsc --noEmit && \
npx eslint mcp_server/ --max-warnings=0 && \
npx vitest run --reporter=verbose</code></pre>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h4 class="text-xs font-semibold tracking-widest text-muted">Spec Validation</h4>
                                <div class="relative group">
                                    <div class="absolute top-3 right-3 text-[9px] font-semibold tracking-widest text-muted bg-black/60 px-2 py-1 rounded">Shell</div>
                                    <pre class="bg-[#1c1c1e] border border-[rgba(255,255,255,0.08)] rounded-lg p-5 pt-10 text-[11px] text-zinc-300 mono overflow-x-auto leading-relaxed"><code>bash .opencode/skill/system-spec-kit/scripts/validate.sh \
  specs/003-system-spec-kit/142-session-context-compression/</code></pre>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Footer -->
                    <footer class="pt-24 border-t border-[rgba(255,255,255,0.08)] flex flex-col md:flex-row justify-between items-start md:items-center gap-8 opacity-40 mb-12">
                        <div class="space-y-1">
                            <p class="text-[10px] font-semibold tracking-widest">SpecKit Protocol Control</p>
                            <p class="text-[9px] mono">Integrity_Hash: 0xa1f93c_Plan_Ref_v1.0_Approved</p>
                        </div>
                        <div class="text-right space-y-1">
                            <p class="text-[10px] font-semibold tracking-widest">&copy; 2026 OpenCode Infrastructure</p>
                            <p class="text-[9px] mono">End of Plan Ledger</p>
                        </div>
                    </footer>

                </main>
            </div>
        </div>
    </div>

    <script>
        /* Clock */
        function updateClock() {
            const now = new Date();
            const timeStr = now.toISOString().split('T')[1].split('.')[0] + ' UTC';
            const clockEl = document.getElementById('clock');
            if (clockEl) clockEl.textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        /* Scroll Reveal + TOC Scroll-Spy */
        const initObservers = () => {
            const revealObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        const bars = entry.target.querySelectorAll('.viz-fill');
                        bars.forEach(bar => {
                            bar.style.width = bar.getAttribute('data-width');
                        });
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

            const navLinks = document.querySelectorAll('.toc-link');
            const sections = document.querySelectorAll('section[id]');

            const navObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        navLinks.forEach(link => {
                            link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                        });
                    }
                });
            }, { rootMargin: '-20% 0px -70% 0px' });

            sections.forEach(section => navObserver.observe(section));
        };

        window.addEventListener('DOMContentLoaded', initObservers);
    </script>
</body>
</html>
