<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="ve-artifact-type" content="spec">
    <meta name="ve-source-doc" content="">
    <meta name="ve-speckit-level" content="2">
    <meta name="ve-view-mode" content="artifact-dashboard">
    <title>Feature Specification | SpecKit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'dark' });</script>
    <style>
        :root {
            --bg: #131314;
            --surface: #1c1c1e;
            --text: #fafafa;
            --accent: #3b82f6;
            --muted: #71717a;
            --border: rgba(255, 255, 255, 0.08);

            --font-from-0: 13; --font-to-0: 17;
            --vw-from-0: calc(1 / 100); --vw-to-0: calc(991 / 100);
            --coefficient-0: calc((var(--font-to-0) - var(--font-from-0)) / (var(--vw-to-0) - var(--vw-from-0)));
            --base-0: calc((var(--font-from-0) - var(--vw-from-0) * var(--coefficient-0)) / 16);

            --font-from-1: 13; --font-to-1: 17;
            --vw-from-1: calc(991 / 100); --vw-to-1: calc(1440 / 100);
            --coefficient-1: calc((var(--font-to-1) - var(--font-from-1)) / (var(--vw-to-1) - var(--vw-from-1)));
            --base-1: calc((var(--font-from-1) - var(--vw-from-1) * var(--coefficient-1)) / 16);

            --font-from-2: 13; --font-to-2: 15;
            --vw-from-2: calc(1440 / 100); --vw-to-2: calc(1920 / 100);
            --coefficient-2: calc((var(--font-to-2) - var(--font-from-2)) / (var(--vw-to-2) - var(--vw-from-2)));
            --base-2: calc((var(--font-from-2) - var(--vw-from-2) * var(--coefficient-2)) / 16);

            --font-from-3: 16; --font-to-3: 21;
            --vw-from-3: calc(1920 / 100); --vw-to-3: calc(5120 / 100);
            --coefficient-3: calc((var(--font-to-3) - var(--font-from-3)) / (var(--vw-to-3) - var(--vw-from-3)));
            --base-3: calc((var(--font-from-3) - var(--vw-from-3) * var(--coefficient-3)) / 16);

            --font-size-4: 1.3125;
        }

        

        

        

        

        html {
            font-size: calc(var(--font-size-4) * 1rem);
            scroll-behavior: smooth;
            background-color: var(--bg);
            color: var(--text);
        }

        @media screen and (max-width: 5120px) { html { font-size: calc(var(--base-3) * 1rem + var(--coefficient-3) * 1vw); } }
        @media screen and (max-width: 1920px) { html { font-size: calc(var(--base-2) * 1rem + var(--coefficient-2) * 1vw); } }
        @media screen and (max-width: 1440px) { html { font-size: calc(var(--base-1) * 1rem + var(--coefficient-1) * 1vw); } }
        @media screen and (max-width: 991px)  { html { font-size: calc(var(--base-0) * 1rem + var(--coefficient-0) * 1vw); } }

        body { 
            font-family: 'Helvetica', sans-serif; 
            line-height: 1.5; 
            -webkit-font-smoothing: antialiased; 
            background-color: var(--bg);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center top;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .page-container { width: 100%; max-width: 90rem; margin: 0 auto; }
        .main-grid { display: grid; grid-template-columns: 260px 1fr; gap: 4rem; }

        .toc-link {
            display: flex; align-items: center; gap: 0.75rem;
            font-size: 0.7rem; font-weight: 600; color: var(--muted);
            padding: 0.4rem 0; transition: all 0.2s ease; letter-spacing: 0.05em;
        }
        .toc-link:hover { color: var(--text); }
        .toc-link.active { color: var(--accent); }
        .toc-link.active::before { content: ''; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }

        .terminal-header {
            border-bottom: 1px solid var(--border);
            background: rgba(19, 19, 20, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .ledger-line { height: 1px; background: linear-gradient(90deg, var(--border) 0%, transparent 100%); margin: 2rem 0; }

        .reveal { opacity: 0; transform: translateY(20px); transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        .glass-card { 
            background: rgba(28, 28, 30, 0.6); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border); 
            border-radius: 12px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .glass-card:hover { 
            border-color: rgba(59, 130, 246, 0.4); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1), 0 0 20px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 8px;
            background: linear-gradient(to bottom, transparent, rgba(59, 130, 246, 0.3), transparent);
            opacity: 0.6; z-index: 200; pointer-events: none; 
            animation: scan 8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes scan { 0% { top: -10%; opacity: 0; } 5% { opacity: 0.5; } 95% { opacity: 0.5; } 100% { top: 110%; opacity: 0; } }

        .inline-code {
            font-family: 'JetBrains Mono', monospace; color: var(--accent); font-size: 0.9em;
            background: rgba(0, 0, 0, 0.3); padding: 0.1rem 0.3rem; border-radius: 4px; border: 1px solid var(--border);
        }

        .status {
            display: inline-flex; align-items: center; gap: 0.35rem;
            padding: 0.25rem 0.75rem; border-radius: 4px;
            font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
        }
        .status-p0 { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.25); }
        .status-p1 { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.25); }
        .status-p2 { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.25); }
        .status-level { background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid var(--border); }
        .status-progress { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.25); }
        .status-success { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.25); }
        .status-danger { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.25); }

        .callout {
            border-left: 3px solid var(--accent); 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.02) 100%);
            border-radius: 0 12px 12px 0; padding: 1.5rem;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .compare-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; }

        .viz-bar { background: rgba(255,255,255,0.05); border-radius: 4px; height: 8px; overflow: hidden; }
        .viz-fill { height: 100%; border-radius: 4px; width: 0; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }

        .data-table { width: 100%; text-align: left; font-size: 11px; }
        .data-table thead tr { border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); }
        .data-table th { padding: 0.75rem 1rem; color: var(--muted); font-weight: 600; letter-spacing: 0.1em; font-size: 10px; text-transform: uppercase; }
        .data-table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
        .data-table tbody tr { transition: background 0.15s ease; }
        .data-table tbody tr:hover { background: rgba(255,255,255,0.03); }

        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }

        
    </style>
</head>
<body>
    <div class="selection:bg-blue-500/30 min-h-screen relative w-full">
        <div class="scanline"></div>

        <!-- Status Bar -->
        <div class="terminal-header sticky top-0 px-6 py-3 flex items-center justify-between text-[10px] font-semibold tracking-widest mono text-muted">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                    <span class="text-text">Spec Active</span>
                </div>
                <div class="hidden md:block">Artifact: Feature Specification</div>
            </div>
            <div class="flex items-center gap-6">
                <div id="clock">00:00:00 UTC</div>
                <div class="text-accent">SpecKit // Level 2</div>
            </div>
        </div>

        <div class="page-container px-6 lg:px-12 py-12">

            <!-- Hero Header -->
            <header class="mb-32 reveal" id="top">
                <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-12">
                    <div class="space-y-6">
                        <div class="inline-flex items-center gap-2 px-3 py-1 border border-blue-500/20 bg-blue-500/5 text-blue-400 text-[10px] font-semibold tracking-widest rounded">
                            142-hybrid-search-reranking // ContextType: Specification
                        </div>
                        <h1 class="text-7xl md:text-9xl font-semibold tracking-tighter leading-none">
                            <span class="bg-clip-text text-transparent bg-gradient-to-r from-gray-100 to-gray-500">Feature</span><br>
                            <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-blue-600 drop-shadow-sm">Spec.</span>
                        </h1>
                    </div>
                    <div class="lg:text-right space-y-6">
                        <div class="space-y-1">
                            <p class="text-[10px] font-semibold tracking-widest text-muted">Status / In Progress</p>
                            <p class="text-3xl font-semibold mono">2026-02-28</p>
                        </div>
                        <div class="flex lg:justify-end gap-3 flex-wrap">
                            <span class="status status-level">Level 2</span>
                            <span class="status status-p0">P0 Blocker</span>
                            <span class="status status-progress">In Progress</span>
                        </div>
                    </div>
                </div>
                <div class="ledger-line"></div>
            </header>

            <div class="main-grid">

                <!-- Sidebar TOC -->
                <aside class="sidebar">
                    <nav class="sticky top-24 space-y-12">
                        <div class="space-y-4">
                            <p class="text-[10px] font-semibold tracking-[0.2em] text-muted">Specification Ledger</p>
                            <div id="sidebar-nav" class="flex flex-col gap-1">
                                <a href="#executive-summary" class="toc-link active">01 Executive Summary</a>
                                <a href="#metadata" class="toc-link">02 Metadata</a>
                                <a href="#problem-purpose" class="toc-link">03 Problem & Purpose</a>
                                <a href="#scope" class="toc-link">04 Scope</a>
                                <a href="#requirements" class="toc-link">05 Requirements</a>
                                <a href="#success-criteria" class="toc-link">06 Success Criteria</a>
                                <a href="#risks" class="toc-link">07 Risks & Dependencies</a>
                                <a href="#complexity" class="toc-link">08 Complexity</a>
                                <a href="#user-stories" class="toc-link">09 User Stories</a>
                                <a href="#acceptance" class="toc-link">10 Acceptance Scenarios</a>
                                <a href="#nfr" class="toc-link">11 Non-Functional Reqs</a>
                            </div>
                        </div>
                    </nav>
                </aside>

                <!-- Content Area -->
                <main class="space-y-[clamp(4rem,10vh,8rem)]">

                    <!-- 01 Executive Summary -->
                    <section id="executive-summary" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-accent border-[rgba(255,255,255,0.08)]">01 // Executive Summary</h2>
                        <div class="callout space-y-4">
                            <p class="text-sm leading-relaxed text-text">
                                Replace the single-strategy keyword search with a hybrid retrieval pipeline that fuses BM25 lexical matching with vector similarity scoring. Cross-encoder reranking will produce a single, high-quality ranked list that adapts to developer intent.
                            </p>
                            <div class="flex flex-wrap gap-4 mt-4">
                                <div class="flex items-start gap-2">
                                    <iconify-icon icon="lucide:zap" class="text-amber-500" style="margin-top: 2px"></iconify-icon>
                                    <div>
                                        <p class="text-[10px] font-semibold tracking-widest text-muted">Key Decision</p>
                                        <p class="text-xs text-text">Cross-encoder reranking over reciprocal rank fusion</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <iconify-icon icon="lucide:alert-triangle" class="text-red-500" style="margin-top: 2px"></iconify-icon>
                                    <div>
                                        <p class="text-[10px] font-semibold tracking-widest text-muted">Critical Dependency</p>
                                        <p class="text-xs text-text">Embedding provider API must support batch operations</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 02 Metadata -->
                    <section id="metadata" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-text border-[rgba(255,255,255,0.08)]" style="opacity: 0.8">02 // Metadata</h2>
                        <div class="glass-card p-6">
                            <div class="kpi-row">
                                <div class="space-y-1">
                                    <p class="text-[10px] font-semibold tracking-widest text-muted">Spec ID</p>
                                    <p class="text-sm mono font-semibold text-accent">142</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[10px] font-semibold tracking-widest text-muted">Level</p>
                                    <p class="text-sm mono font-semibold">Level 2 (100-499 LOC)</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[10px] font-semibold tracking-widest text-muted">Priority</p>
                                    <p class="text-sm mono font-semibold text-[#f87171]">P0 â€” Blocker</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[10px] font-semibold tracking-widest text-muted">Status</p>
                                    <p class="text-sm mono font-semibold text-[#60a5fa]">In Progress</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[10px] font-semibold tracking-widest text-muted">Created</p>
                                    <p class="text-sm mono font-semibold">2026-02-28</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[10px] font-semibold tracking-widest text-muted">Branch</p>
                                    <p class="text-sm mono font-semibold text-accent">feat/142-hybrid-rerank</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 03 Problem & Purpose -->
                    <section id="problem-purpose" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-accent border-[rgba(255,255,255,0.08)]">03 // Problem & Purpose</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-card p-6 space-y-4 border-t-[3px] border-red-500">
                                <div class="flex items-center gap-2">
                                    <iconify-icon icon="lucide:alert-circle" class="text-red-500"></iconify-icon>
                                    <h3 class="text-xs font-semibold tracking-widest text-red-500">Problem Statement</h3>
                                </div>
                                <p class="text-sm leading-relaxed text-muted">
                                    The current keyword-only search returns irrelevant results for semantic queries. Developers searching for "how to handle authentication errors" get results matching individual keywords rather than the conceptual intent. Search relevance sits at 42% MRR, well below the 70% target.
                                </p>
                                <p class="text-sm leading-relaxed text-muted">
                                    This directly impacts developer productivity: context loading takes 3-4 iterations instead of 1, and 35% of follow-up queries are reformulations of the original search.
                                </p>
                            </div>
                            <div class="glass-card p-6 space-y-4 border-t-[3px] border-green-500">
                                <div class="flex items-center gap-2">
                                    <iconify-icon icon="lucide:target" class="text-green-500"></iconify-icon>
                                    <h3 class="text-xs font-semibold tracking-widest text-green-500">Purpose</h3>
                                </div>
                                <p class="text-sm leading-relaxed text-muted">
                                    Deliver a hybrid retrieval pipeline that combines lexical precision (BM25) with semantic understanding (vector similarity) to surface the right context on the first search. Cross-encoder reranking ensures the final result list is ordered by true relevance, not keyword overlap.
                                </p>
                                <p class="text-sm leading-relaxed text-muted">
                                    Target outcome: MRR above 75%, first-query success rate above 80%, and zero increase in p95 latency for the search handler.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 04 Scope -->
                    <section id="scope" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-text border-[rgba(255,255,255,0.08)]" style="opacity: 0.8">04 // Scope</h2>
                        <div class="compare-grid">
                            <div class="glass-card p-6 space-y-4 border-t-[3px] border-green-500">
                                <h3 class="text-xs font-semibold tracking-widest text-green-500">In Scope</h3>
                                <ul class="space-y-3 text-sm text-muted">
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:check" class="text-green-500" style="margin-top: 3px"></iconify-icon> BM25 lexical scoring engine</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:check" class="text-green-500" style="margin-top: 3px"></iconify-icon> Vector similarity retrieval</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:check" class="text-green-500" style="margin-top: 3px"></iconify-icon> Cross-encoder reranking pass</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:check" class="text-green-500" style="margin-top: 3px"></iconify-icon> Score fusion strategy</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:check" class="text-green-500" style="margin-top: 3px"></iconify-icon> Feature flag gating</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:check" class="text-green-500" style="margin-top: 3px"></iconify-icon> Telemetry instrumentation</li>
                                </ul>
                            </div>
                            <div class="glass-card p-6 space-y-4 border-t-[3px] border-red-500">
                                <h3 class="text-xs font-semibold tracking-widest text-red-500">Out of Scope</h3>
                                <ul class="space-y-3 text-sm text-muted">
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:x" class="text-red-500" style="margin-top: 3px"></iconify-icon> UI/UX redesign of search interface</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:x" class="text-red-500" style="margin-top: 3px"></iconify-icon> Embedding model fine-tuning</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:x" class="text-red-500" style="margin-top: 3px"></iconify-icon> Multi-language tokenization</li>
                                    <li class="flex gap-2 items-start"><iconify-icon icon="lucide:x" class="text-red-500" style="margin-top: 3px"></iconify-icon> Database schema migration</li>
                                </ul>
                            </div>
                            <div class="glass-card p-6 space-y-4 border-t-[3px] border-accent">
                                <h3 class="text-xs font-semibold tracking-widest text-accent">Files to Change</h3>
                                <div class="space-y-2 text-[11px] mono">
                                    <div class="flex justify-between items-center py-1 border-b border-[rgba(255,255,255,0.08)]">
                                        <span class="text-text">hybrid-search.ts</span>
                                        <span class="status status-progress" style="font-size: 9px;">modify</span>
                                    </div>
                                    <div class="flex justify-between items-center py-1 border-b border-[rgba(255,255,255,0.08)]">
                                        <span class="text-text">reranker.ts</span>
                                        <span class="status status-success" style="font-size: 9px;">create</span>
                                    </div>
                                    <div class="flex justify-between items-center py-1 border-b border-[rgba(255,255,255,0.08)]">
                                        <span class="text-text">search-flags.ts</span>
                                        <span class="status status-progress" style="font-size: 9px;">modify</span>
                                    </div>
                                    <div class="flex justify-between items-center py-1 border-b border-[rgba(255,255,255,0.08)]">
                                        <span class="text-text">bm25-engine.ts</span>
                                        <span class="status status-success" style="font-size: 9px;">create</span>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-text">memory-search.ts</span>
                                        <span class="status status-progress" style="font-size: 9px;">modify</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 05 Requirements -->
                    <section id="requirements" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-accent border-[rgba(255,255,255,0.08)]">05 // Requirements</h2>

                        <!-- P0 Blockers -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-3">
                                <span class="status status-p0">P0 Blockers</span>
                                <div style="flex: 1; height: 1px; background: rgba(239, 68, 68, 0.2);"></div>
                            </div>
                            <div class="glass-card overflow-hidden border-t-[3px] border-red-500">
                                <table class="data-table mono">
                                    <thead><tr><th>ID</th><th>Requirement</th><th>Acceptance Criteria</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-[#f87171]" class="font-semibold">R-001</td>
                                            <td class="text-text">Hybrid retrieval must combine BM25 and vector scores using configurable weights</td>
                                            <td class="text-muted">Fusion weights are runtime-configurable via feature flags; default alpha=0.4 (BM25), beta=0.6 (vector)</td>
                                        </tr>
                                        <tr>
                                            <td class="text-[#f87171]" class="font-semibold">R-002</td>
                                            <td class="text-text">Cross-encoder reranking must run on the fused candidate set</td>
                                            <td class="text-muted">Top-50 candidates from fusion are reranked; final list respects user-specified limit parameter</td>
                                        </tr>
                                        <tr>
                                            <td class="text-[#f87171]" class="font-semibold">R-003</td>
                                            <td class="text-text">Search latency p95 must not exceed 200ms for datasets under 10k memories</td>
                                            <td class="text-muted">Benchmark suite passes with p95 under 200ms on reference hardware; degradation triggers fallback</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- P1 Required -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-3">
                                <span class="status status-p1">P1 Required</span>
                                <div style="flex: 1; height: 1px; background: rgba(245, 158, 11, 0.2);"></div>
                            </div>
                            <div class="glass-card overflow-hidden border-t-[3px] border-amber-500">
                                <table class="data-table mono">
                                    <thead><tr><th>ID</th><th>Requirement</th><th>Acceptance Criteria</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-[#fbbf24]" class="font-semibold">R-004</td>
                                            <td class="text-text">Telemetry must emit retrieval strategy, timing, and candidate counts</td>
                                            <td class="text-muted">Each search emits structured telemetry with strategy, duration_ms, and candidate_count fields</td>
                                        </tr>
                                        <tr>
                                            <td class="text-[#fbbf24]" class="font-semibold">R-005</td>
                                            <td class="text-text">Graceful degradation when embedding provider is unavailable</td>
                                            <td class="text-muted">System falls back to BM25-only mode with warning logged; no user-facing errors</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- P2 Optional -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-3">
                                <span class="status status-p2">P2 Optional</span>
                                <div style="flex: 1; height: 1px; background: rgba(59, 130, 246, 0.2);"></div>
                            </div>
                            <div class="glass-card overflow-hidden border-t-[3px] border-accent">
                                <table class="data-table mono">
                                    <thead><tr><th>ID</th><th>Requirement</th><th>Acceptance Criteria</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-[#60a5fa]" class="font-semibold">R-006</td>
                                            <td class="text-text">Intent-aware weight adjustment based on query classification</td>
                                            <td class="text-muted">Seven intent profiles with pre-tuned fusion weights; auto-detection from query text</td>
                                        </tr>
                                        <tr>
                                            <td class="text-[#60a5fa]" class="font-semibold">R-007</td>
                                            <td class="text-text">Search result explanation traces for debugging</td>
                                            <td class="text-muted">Optional trace mode returns per-result scoring breakdown in response metadata</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- 06 Success Criteria -->
                    <section id="success-criteria" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-text border-[rgba(255,255,255,0.08)]" style="opacity: 0.8">06 // Success Criteria</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="glass-card p-5 flex items-start gap-4">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mono text-green-500" style="background: rgba(34, 197, 94, 0.15)">1</div>
                                <div>
                                    <p class="text-sm font-semibold text-text">MRR exceeds 75%</p>
                                    <p class="text-xs text-muted">Mean Reciprocal Rank on the evaluation benchmark suite of 200 queries</p>
                                </div>
                            </div>
                            <div class="glass-card p-5 flex items-start gap-4">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mono text-green-500" style="background: rgba(34, 197, 94, 0.15)">2</div>
                                <div>
                                    <p class="text-sm font-semibold text-text">First-query success rate above 80%</p>
                                    <p class="text-xs text-muted">Users find the right context without reformulating their search query</p>
                                </div>
                            </div>
                            <div class="glass-card p-5 flex items-start gap-4">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mono text-green-500" style="background: rgba(34, 197, 94, 0.15)">3</div>
                                <div>
                                    <p class="text-sm font-semibold text-text">p95 latency under 200ms</p>
                                    <p class="text-xs text-muted">Full pipeline including reranking stays under latency budget on reference hardware</p>
                                </div>
                            </div>
                            <div class="glass-card p-5 flex items-start gap-4">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mono text-green-500" style="background: rgba(34, 197, 94, 0.15)">4</div>
                                <div>
                                    <p class="text-sm font-semibold text-text">Zero regression in existing test suite</p>
                                    <p class="text-xs text-muted">All 142 test files pass with hybrid search enabled behind feature flag</p>
                                </div>
                            </div>
                            <div class="glass-card p-5 flex items-start gap-4">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mono text-green-500" style="background: rgba(34, 197, 94, 0.15)">5</div>
                                <div>
                                    <p class="text-sm font-semibold text-text">Graceful fallback on provider failure</p>
                                    <p class="text-xs text-muted">Search returns BM25-only results within 50ms when embedding provider is down</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 07 Risks & Dependencies -->
                    <section id="risks" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-accent border-[rgba(255,255,255,0.08)]">07 // Risks & Dependencies</h2>

                        <div class="space-y-6">
                            <h3 class="text-xs font-semibold tracking-widest text-muted">Risk Matrix</h3>
                            <div class="glass-card overflow-hidden">
                                <table class="data-table mono">
                                    <thead><tr><th>Risk</th><th>Impact</th><th>Likelihood</th><th>Mitigation</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-text">Embedding API latency spike</td>
                                            <td><span class="status status-p0" style="font-size: 9px;">High</span></td>
                                            <td><span class="status status-p1" style="font-size: 9px;">Medium</span></td>
                                            <td class="text-muted">Circuit breaker with 100ms timeout; auto-fallback to BM25-only</td>
                                        </tr>
                                        <tr>
                                            <td class="text-text">Cross-encoder model size exceeds memory</td>
                                            <td><span class="status status-p1" style="font-size: 9px;">Medium</span></td>
                                            <td><span class="status status-p2" style="font-size: 9px;">Low</span></td>
                                            <td class="text-muted">Use distilled model variant; lazy-load on first rerank call</td>
                                        </tr>
                                        <tr>
                                            <td class="text-text">Score distribution mismatch between BM25 and vector</td>
                                            <td><span class="status status-p1" style="font-size: 9px;">Medium</span></td>
                                            <td><span class="status status-p1" style="font-size: 9px;">Medium</span></td>
                                            <td class="text-muted">Min-max normalization before fusion; calibration test suite</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <h3 class="text-xs font-semibold tracking-widest text-muted">Dependencies</h3>
                            <div class="glass-card overflow-hidden">
                                <table class="data-table mono">
                                    <thead><tr><th>Dependency</th><th>Type</th><th>Status</th><th>Owner</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-text">Embedding provider batch API</td>
                                            <td class="text-muted">External</td>
                                            <td><span class="status status-success" style="font-size: 9px;">Available</span></td>
                                            <td class="text-muted">Platform team</td>
                                        </tr>
                                        <tr>
                                            <td class="text-text">BM25 index from spec 138</td>
                                            <td class="text-muted">Internal</td>
                                            <td><span class="status status-success" style="font-size: 9px;">Merged</span></td>
                                            <td class="text-muted">Search team</td>
                                        </tr>
                                        <tr>
                                            <td class="text-text">Feature flag infrastructure</td>
                                            <td class="text-muted">Internal</td>
                                            <td><span class="status status-success" style="font-size: 9px;">Ready</span></td>
                                            <td class="text-muted">Core infra</td>
                                        </tr>
                                        <tr>
                                            <td class="text-text">Evaluation benchmark dataset</td>
                                            <td class="text-muted">Internal</td>
                                            <td><span class="status status-progress" style="font-size: 9px;">In Progress</span></td>
                                            <td class="text-muted">QA team</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- 08 Complexity Assessment -->
                    <section id="complexity" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-text border-[rgba(255,255,255,0.08)]" style="opacity: 0.8">08 // Complexity Assessment</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="glass-card p-8 flex flex-col items-center justify-center text-center md:col-span-1 border-t-[3px] border-accent">
                                <p class="text-[10px] font-semibold tracking-widest mb-2 text-muted">Total Score</p>
                                <p class="text-6xl font-bold mono text-accent">62</p>
                                <p class="text-xs mt-2 text-muted">out of 100</p>
                                <span class="status status-p1 mt-4" style="font-size: 9px;">Medium-High</span>
                            </div>
                            <div class="glass-card p-6 space-y-5 md:col-span-2">
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs mono">
                                        <span class="text-text">Algorithmic Complexity</span>
                                        <span class="text-accent">75/100</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill" data-width="75%" class="bg-[#3b82f6]"></div></div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs mono">
                                        <span class="text-text">Integration Surface</span>
                                        <span class="text-amber-500">65/100</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill bg-amber-500" data-width="65%"></div></div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs mono">
                                        <span class="text-text">Testing Effort</span>
                                        <span class="text-amber-500">60/100</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill bg-amber-500" data-width="60%"></div></div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs mono">
                                        <span class="text-text">External Dependencies</span>
                                        <span class="text-green-500">50/100</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill bg-green-500" data-width="50%"></div></div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs mono">
                                        <span class="text-text">Rollback Risk</span>
                                        <span class="text-green-500">40/100</span>
                                    </div>
                                    <div class="viz-bar"><div class="viz-fill bg-green-500" data-width="40%"></div></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 09 User Stories -->
                    <section id="user-stories" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-accent border-[rgba(255,255,255,0.08)]">09 // User Stories</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-card p-6 space-y-4 border-l-[3px] border-accent">
                                <p class="text-[10px] font-semibold tracking-widest mono text-accent">US-001</p>
                                <p class="text-sm leading-relaxed text-text">
                                    <strong>As a</strong> developer debugging a production issue,
                                    <strong>I want</strong> search to understand my intent when I type "memory leak in session handler",
                                    <strong>so that</strong> I get the relevant decision records and implementation notes on the first query instead of unrelated keyword matches.
                                </p>
                            </div>
                            <div class="glass-card p-6 space-y-4 border-l-[3px] border-accent">
                                <p class="text-[10px] font-semibold tracking-widest mono text-accent">US-002</p>
                                <p class="text-sm leading-relaxed text-text">
                                    <strong>As a</strong> new team member onboarding to the codebase,
                                    <strong>I want</strong> to search for architectural concepts using natural language,
                                    <strong>so that</strong> I can discover relevant specs and decisions without knowing the exact terminology used in documentation.
                                </p>
                            </div>
                            <div class="glass-card p-6 space-y-4 border-l-[3px] border-accent">
                                <p class="text-[10px] font-semibold tracking-widest mono text-accent">US-003</p>
                                <p class="text-sm leading-relaxed text-text">
                                    <strong>As a</strong> security auditor reviewing access controls,
                                    <strong>I want</strong> search results ordered by true relevance to my audit query,
                                    <strong>so that</strong> I can systematically trace authorization decisions without manually sifting through false positives.
                                </p>
                            </div>
                            <div class="glass-card p-6 space-y-4 border-l-[3px] border-accent">
                                <p class="text-[10px] font-semibold tracking-widest mono text-accent">US-004</p>
                                <p class="text-sm leading-relaxed text-text">
                                    <strong>As a</strong> platform operator monitoring search health,
                                    <strong>I want</strong> telemetry showing which retrieval strategy was selected and how long each stage took,
                                    <strong>so that</strong> I can identify degradation before it impacts developer experience.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 10 Acceptance Scenarios -->
                    <section id="acceptance" class="space-y-12 reveal">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-text border-[rgba(255,255,255,0.08)]" style="opacity: 0.8">10 // Acceptance Scenarios</h2>
                        <div class="space-y-6">
                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold mono text-accent" style="background: rgba(59, 130, 246, 0.15)">A1</span>
                                    <p class="text-sm font-semibold text-text">Hybrid search returns semantically relevant results</p>
                                </div>
                                <div class="space-y-2 text-xs mono" style="padding-left: 2.5rem;">
                                    <p><span class="text-green-500" class="font-semibold">GIVEN</span> <span class="text-muted">the memory index contains 500+ documents across 12 spec folders</span></p>
                                    <p><span class="text-accent" class="font-semibold">WHEN</span> <span class="text-muted">a user searches for "how authentication tokens are validated"</span></p>
                                    <p><span class="text-amber-500" class="font-semibold">THEN</span> <span class="text-muted">the top-3 results include the auth token validation spec, even if it uses the term "JWT verification" instead</span></p>
                                </div>
                            </div>
                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold mono text-accent" style="background: rgba(59, 130, 246, 0.15)">A2</span>
                                    <p class="text-sm font-semibold text-text">Fallback mode activates on provider failure</p>
                                </div>
                                <div class="space-y-2 text-xs mono" style="padding-left: 2.5rem;">
                                    <p><span class="text-green-500" class="font-semibold">GIVEN</span> <span class="text-muted">the embedding provider returns HTTP 503 or times out after 100ms</span></p>
                                    <p><span class="text-accent" class="font-semibold">WHEN</span> <span class="text-muted">a search query is executed with hybrid mode enabled</span></p>
                                    <p><span class="text-amber-500" class="font-semibold">THEN</span> <span class="text-muted">the system returns BM25-only results within 50ms, logs a degradation warning, and emits fallback telemetry</span></p>
                                </div>
                            </div>
                            <div class="glass-card p-6 space-y-4">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold mono text-accent" style="background: rgba(59, 130, 246, 0.15)">A3</span>
                                    <p class="text-sm font-semibold text-text">Reranking improves result ordering</p>
                                </div>
                                <div class="space-y-2 text-xs mono" style="padding-left: 2.5rem;">
                                    <p><span class="text-green-500" class="font-semibold">GIVEN</span> <span class="text-muted">the fusion stage produces 50 candidate results with mixed relevance</span></p>
                                    <p><span class="text-accent" class="font-semibold">WHEN</span> <span class="text-muted">the cross-encoder reranker processes the candidate set</span></p>
                                    <p><span class="text-amber-500" class="font-semibold">THEN</span> <span class="text-muted">MRR improves by at least 15 percentage points compared to fusion-only ordering</span></p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 11 Non-Functional Requirements -->
                    <section id="nfr" class="space-y-12 reveal mb-24">
                        <h2 class="text-[10px] tracking-[0.3em] font-semibold border-b pb-4 text-accent border-[rgba(255,255,255,0.08)]">11 // Non-Functional Requirements</h2>
                        <div class="glass-card p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <iconify-icon icon="lucide:gauge" class="text-accent"></iconify-icon>
                                        <h4 class="text-xs font-semibold text-text">Performance</h4>
                                    </div>
                                    <ul class="space-y-2 text-xs text-muted">
                                        <li class="flex gap-2"><span class="text-accent">-</span> p50 latency under 80ms for hybrid search</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> p95 latency under 200ms including reranking</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> Memory usage increase under 50MB at steady state</li>
                                    </ul>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <iconify-icon icon="lucide:shield" class="text-accent"></iconify-icon>
                                        <h4 class="text-xs font-semibold text-text">Reliability</h4>
                                    </div>
                                    <ul class="space-y-2 text-xs text-muted">
                                        <li class="flex gap-2"><span class="text-accent">-</span> Automatic fallback within 100ms on provider failure</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> No data loss during index operations</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> Feature flag kill switch for instant rollback</li>
                                    </ul>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <iconify-icon icon="lucide:eye" class="text-accent"></iconify-icon>
                                        <h4 class="text-xs font-semibold text-text">Observability</h4>
                                    </div>
                                    <ul class="space-y-2 text-xs text-muted">
                                        <li class="flex gap-2"><span class="text-accent">-</span> Structured telemetry for every search invocation</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> Strategy selection reasoning in debug mode</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> Health score computation per search</li>
                                    </ul>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <iconify-icon icon="lucide:puzzle" class="text-accent"></iconify-icon>
                                        <h4 class="text-xs font-semibold text-text">Maintainability</h4>
                                    </div>
                                    <ul class="space-y-2 text-xs text-muted">
                                        <li class="flex gap-2"><span class="text-accent">-</span> Fusion weights configurable without code change</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> Reranker model swappable via provider interface</li>
                                        <li class="flex gap-2"><span class="text-accent">-</span> All new modules have >90% test coverage</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 rounded-lg flex items-start gap-4" style="border: 1px solid rgba(59, 130, 246, 0.2); background: rgba(59, 130, 246, 0.05);">
                            <iconify-icon icon="lucide:info" class="text-xl mt-0.5 text-accent"></iconify-icon>
                            <p class="text-sm leading-relaxed text-muted">
                                <strong class="text-text">Edge Cases:</strong> Empty query strings return the 10 most recently accessed memories. Queries exceeding 500 tokens are truncated with a warning. Identical BM25 and vector scores are broken by recency. Memories with missing embeddings are included in BM25 results only.
                            </p>
                        </div>
                    </section>

                    <!-- Footer -->
                    <footer class="pt-24 flex flex-col md:flex-row justify-between items-start md:items-center gap-8 opacity-40 mb-12 border-t border-[rgba(255,255,255,0.08)]">
                        <div class="space-y-1">
                            <p class="text-[10px] font-semibold tracking-widest">SpecKit Protocol Control</p>
                            <p class="text-[9px] mono">Integrity_Hash: 0x3b82f6_Spec_Ref_v1.0_Draft</p>
                        </div>
                        <div class="text-right space-y-1">
                            <p class="text-[10px] font-semibold tracking-widest">OpenCode Infrastructure</p>
                            <p class="text-[9px] mono">End of Specification Ledger</p>
                        </div>
                    </footer>

                </main>
            </div>
        </div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            const timeStr = now.toISOString().split('T')[1].split('.')[0] + ' UTC';
            const el = document.getElementById('clock');
            if (el) el.textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        const initObservers = () => {
            const revealObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        entry.target.querySelectorAll('.viz-fill').forEach(bar => {
                            bar.style.width = bar.getAttribute('data-width');
                        });
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

            const navLinks = document.querySelectorAll('.toc-link');
            const sections = document.querySelectorAll('section[id]');

            const navObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        navLinks.forEach(link => {
                            link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                        });
                    }
                });
            }, { rootMargin: '-20% 0px -70% 0px' });

            sections.forEach(section => navObserver.observe(section));
        };

        window.addEventListener('DOMContentLoaded', initObservers);
    </script>
</body>
</html>
