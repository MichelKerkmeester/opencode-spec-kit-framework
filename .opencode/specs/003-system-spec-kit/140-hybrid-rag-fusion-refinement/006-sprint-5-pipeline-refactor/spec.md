---
title: "Feature Specification: Sprint 5 — Pipeline Refactor"
description: "Refactor retrieval pipeline to 4-stage architecture with Stage 4 invariant, add spec folder pre-filter, query expansion, and spec-kit retrieval metadata."
trigger_phrases:
  - "sprint 5"
  - "pipeline refactor"
  - "R6"
  - "4-stage pipeline"
importance_tier: "normal"
contextType: "implementation"
---
# Feature Specification: Sprint 5 — Pipeline Refactor

<!-- SPECKIT_LEVEL: 2 -->
<!-- SPECKIT_TEMPLATE_SOURCE: spec-core + level2-verify + phase-child-header | v2.2 -->

---

<!-- ANCHOR:metadata -->
## 1. METADATA

| Field | Value |
|-------|-------|
| **Level** | 2 |
| **Priority** | P2 |
| **Status** | Draft |
| **Created** | 2026-02-26 |
| **Branch** | `140-hybrid-rag-fusion-refinement` |
| **Parent Spec** | ../spec.md |
| **Parent Plan** | ../plan.md |
| **Phase** | 6 of 8 |
| **Predecessor** | ../005-sprint-4-feedback-loop/ |
| **Successor** | ../007-sprint-6-graph-deepening/ |
| **Handoff Criteria** | R6 0 ordering differences, 158+ tests pass, R9 cross-folder equivalent, R12 no latency degradation |
<!-- /ANCHOR:metadata -->

---

<!-- ANCHOR:phase-context -->
### Phase Context

This is **Phase 6** of the Hybrid RAG Fusion Refinement specification.

**Scope Boundary**: Sprint 5 scope boundary — pipeline architecture. Establishes clean 4-stage pipeline with architectural invariant (Stage 4 = no score changes), adds retrieval optimizations (spec folder pre-filter, query expansion), and integrates spec-kit signals (template anchors, validation metadata).

**Dependencies**:
- Sprint 4 exit gate (feedback loop complete — R1, R11, R13-S2 verified)

**Deliverables**:
- 4-stage pipeline refactor with Stage 4 invariant (R6)
- Spec folder pre-filter (R9)
- Query expansion with R15 mutual exclusion (R12)
- Template anchor optimization (S2)
- Validation signals as retrieval metadata (S3)
- Dual-scope memory auto-surface hooks at tool dispatch and session compaction (TM-05)

**Internal Phasing**: Phase A (Pipeline) MUST pass before Phase B (Search + Spec-Kit) begins.
<!-- /ANCHOR:phase-context -->

---

<!-- ANCHOR:problem -->
## 2. PROBLEM & PURPOSE

### Problem Statement

The current pipeline intermixes scoring, filtering, and annotation without clear stage boundaries. This enables anti-patterns like double-weighting (G2) where intent weights or other scoring signals can be applied multiple times across different code paths. Spec folder pre-filtering is absent, requiring full corpus search even when the user has specified a folder. No query expansion exists. Template and validation signals generated by the spec-kit system are unused in retrieval scoring.

### Purpose

Establish a clean 4-stage pipeline with an architectural invariant (Stage 4 cannot modify scores), add retrieval optimizations for speed and relevance, and surface spec-kit signals in the scoring layer.
<!-- /ANCHOR:problem -->

---

<!-- ANCHOR:scope -->
## 3. SCOPE

### In Scope

- **R6**: 4-stage pipeline refactor with Stage 4 invariant (no score changes after Stage 3)
- **R9**: Spec folder pre-filter for scoped queries
- **R12**: Query expansion (suppressed when R15="simple") with `SPECKIT_EMBEDDING_EXPANSION` flag
- **S2**: Template anchor optimization — anchor-aware retrieval metadata
- **S3**: Validation signals as retrieval metadata — validation metadata in scoring

### Out of Scope

- R15 changes — locked from Sprint 3
- R11 changes — locked from Sprint 4
- New fusion algorithms — RRF/RSF decision locked from Sprint 3
- Graph deepening — Sprint 6 scope

### Internal Phasing

- **Phase A (Pipeline)**: R6 (40-55h) — MUST pass 0 ordering differences gate before Phase B starts
- **Phase B (Search + Spec-Kit)**: R9, R12, S2, S3 (24-37h) — starts only after Phase A passes

### Files to Change

| File Path | Change Type | Description |
|-----------|-------------|-------------|
| `memory-search.ts` | Major Modify | R6: 4-stage pipeline architecture |
| Pipeline module | Create | R6: Stage definitions and boundaries |
| Search handlers | Modify | R9: Spec folder pre-filter, R12: Query expansion |
| Template/validation handlers | Modify | S2: Anchor optimization, S3: Validation metadata |
| `hooks/auto-surface.ts` | Modify | TM-05: Dual-scope injection hooks at tool dispatch and session compaction |
<!-- /ANCHOR:scope -->

---

<!-- ANCHOR:requirements -->
## 4. REQUIREMENTS

### P2 - Important (can defer with documented reason)

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| REQ-S5-001 | **R6**: 4-stage pipeline with Stage 4 invariant | 0 ordering differences on eval corpus, 158+ tests pass. Flag: `SPECKIT_PIPELINE_V2` |
| REQ-S5-002 | **R9**: Spec folder pre-filter | Cross-folder queries produce identical results to without pre-filter |
| REQ-S5-003 | **R12**: Query expansion (suppressed when R15="simple") | No simple query latency degradation. Flag: `SPECKIT_EMBEDDING_EXPANSION` |
| REQ-S5-004 | **S2**: Template anchor optimization | Anchor-aware retrieval metadata present in results |
| REQ-S5-005 | **S3**: Validation signals as retrieval metadata | Validation metadata integrated into scoring |
| REQ-S5-006 | **TM-05**: Dual-scope memory auto-surface hooks at tool dispatch and session compaction lifecycle points, with per-point token budgets (4000 max). Extends `hooks/auto-surface.ts`. Behind config/logic in Spec-Kit integration layer | Memory auto-surface fires at tool dispatch and session compaction; per-point token budget of 4000 enforced; no regression in existing auto-surface behavior |
<!-- /ANCHOR:requirements -->

---

<!-- ANCHOR:success-criteria -->
## 5. SUCCESS CRITERIA

- **SC-001**: R6 dark-run: 0 ordering differences on full eval corpus
- **SC-002**: All 158+ existing tests pass with `SPECKIT_PIPELINE_V2` enabled
- **SC-003**: Stage 4 invariant verified: no score modifications in Stage 4
- **SC-004**: R9 cross-folder queries identical to without pre-filter
- **SC-005**: R12+R15 mutual exclusion: R12 suppressed when R15="simple"
- **SC-006**: R12 no degradation of simple query latency
- **SC-007**: Intent weights applied ONCE in Stage 2 (prevents G2 recurrence)
- **SC-008**: Sprint 5 exit gate — all requirements verified
<!-- /ANCHOR:success-criteria -->

---

<!-- ANCHOR:risks -->
## 6. RISKS & DEPENDENCIES

| Type | Item | Impact | Mitigation |
|------|------|--------|------------|
| Risk | R6 is single largest work item (40-55h) | High | Checkpoint before start; off-ramp to retain current pipeline if ordering regressions unresolvable |
| Risk | Ordering regression in dark-run | High | Off-ramp: retain current pipeline and implement R9/R12/S2/S3 as incremental patches |
| Risk | R12+R15 mutual exclusion must be enforced | Medium | Explicit guard: if R15 classification = "simple", skip R12 expansion |
| Risk | G2 recurrence — intent weights applied in multiple stages | Medium | Stage 2 = single point for all scoring signals; Stage 4 invariant enforces no-score-change |
| Dependency | Sprint 4 exit gate | Blocks start | Must be verified complete |
<!-- /ANCHOR:risks -->

---

<!-- ANCHOR:nfr -->
## 7. NON-FUNCTIONAL REQUIREMENTS

### Performance
- **NFR-P01**: R6 pipeline must not degrade p95 latency vs current implementation
- **NFR-P02**: R12 must not degrade simple query latency (R15 mutual exclusion)
- **NFR-P03**: R9 pre-filter should reduce latency for scoped queries

### Reliability
- **NFR-R01**: All 158+ existing tests must pass under `SPECKIT_PIPELINE_V2`
- **NFR-R02**: Stage 4 invariant: any code that modifies scores after Stage 3 is a build-time error (or assertion)

### Maintainability
- **NFR-M01**: Each stage has clear interface boundary — stages are independently testable
- **NFR-M02**: Stage definitions documented in code with JSDoc
<!-- /ANCHOR:nfr -->

---

<!-- ANCHOR:edge-cases -->
## 8. EDGE CASES

### Data Boundaries
- **R9 with no spec folder**: Pre-filter is a no-op — full corpus search
- **R12 with empty expansion**: If query expansion produces no additional terms, original query proceeds unchanged
- **S2/S3 with no template/validation data**: Missing signals are omitted — scoring not degraded

### Error Scenarios
- **R6 stage boundary violation**: Stage 4 attempts score modification — assertion/guard catches and logs error
- **R12+R15 flag conflict**: Both expansion and simple routing active — R15 takes precedence, R12 suppressed

### State Transitions
- **Phase A to Phase B gate**: R6 must achieve 0 ordering differences before Phase B begins
- **R6 off-ramp**: If ordering regressions cannot be resolved, retain current pipeline and implement R9/R12/S2/S3 as incremental patches to existing code
<!-- /ANCHOR:edge-cases -->

---

<!-- ANCHOR:complexity -->
## 9. COMPLEXITY ASSESSMENT

| Dimension | Score | Notes |
|-----------|-------|-------|
| Scope | 20/25 | R6 is major refactor (40-55h); 4 additional features in Phase B |
| Risk | 14/25 | Ordering regression risk; R6 off-ramp defined; R12+R15 interaction |
| Research | 6/20 | Research complete (142 analysis); 4-stage architecture designed |
| **Total** | **40/70** | **Level 2** |
<!-- /ANCHOR:complexity -->

---

<!-- ANCHOR:questions -->
## 10. OPEN QUESTIONS

- **OQ-S5-001**: Should Stage 4 invariant be enforced at compile-time (TypeScript type guards) or runtime (assertions)?
- **OQ-S5-002**: How should S2/S3 signals weight relative to existing scoring — additive or multiplicative?
<!-- /ANCHOR:questions -->

---

## RELATED DOCUMENTS

- **Implementation Plan**: See `plan.md`
- **Task Breakdown**: See `tasks.md`
- **Verification Checklist**: See `checklist.md`
- **Parent Spec**: See `../spec.md`
- **Parent Plan**: See `../plan.md`

---

### R6 4-Stage Architecture

| Stage | Name | Responsibilities | Score Changes |
|-------|------|-----------------|---------------|
| 1 | Candidate Generation | 5 channels execute, raw results collected | N/A (raw scores) |
| 2 | Fusion + Signal Integration | RRF/RSF, causal boost, co-activation, composite, intent weights (ONCE) | YES |
| 3 | Rerank + Aggregate | Cross-encoder, MMR, MPAB | YES |
| 4 | Filter + Annotate | State filter, session dedup, constitutional injection, attribution | **NO** |

**Architectural Invariant**: Stage 4 MUST NOT modify scores. Any ordering change after Stage 3 is a bug.

---

<!--
LEVEL 2 SPEC — Phase 6 of 8
- Core + L2 addendums (NFR, Edge Cases, Complexity)
- Phase-child-header addendum
- Sprint 5: Pipeline Refactor
-->
