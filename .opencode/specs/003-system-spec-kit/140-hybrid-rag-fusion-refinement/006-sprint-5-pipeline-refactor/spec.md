---
title: "Feature Specification: Sprint 5 — Pipeline Refactor"
description: "Refactor retrieval pipeline to 4-stage architecture with Stage 4 invariant, add spec folder pre-filter, query expansion, and spec-kit retrieval metadata."
trigger_phrases:
  - "sprint 5"
  - "pipeline refactor"
  - "R6"
  - "4-stage pipeline"
importance_tier: "normal"
contextType: "implementation" # SPECKIT_TEMPLATE_SOURCE: spec-core + level2-verify + phase-child-header | v2.2
---
# Feature Specification: Sprint 5 — Pipeline Refactor

<!-- SPECKIT_LEVEL: 2 -->
<!-- SPECKIT_TEMPLATE_SOURCE: spec-core + level2-verify + phase-child-header | v2.2 -->

---

<!-- ANCHOR:metadata -->
## 1. METADATA

| Field | Value |
|-------|-------|
| **Level** | 2 |
| **Priority** | P1 (elevated from P2 — safety-critical NFRs: Stage 4 invariant, pipeline integrity) |
| **Status** | Implemented |
| **Created** | 2026-02-26 |
| **Branch** | `140-hybrid-rag-fusion-refinement` |
| **Parent Spec** | ../spec.md |
| **Parent Plan** | ../plan.md |
| **Phase** | 6 of 8 |
| **Predecessor** | ../005-sprint-4-feedback-and-quality/ |
| **Successor** | ../007-sprint-6-indexing-and-graph/ |
| **Handoff Criteria** | R6 0 ordering differences, 158+ tests pass, R9 cross-folder equivalent, R12 no latency degradation |
<!-- /ANCHOR:metadata -->

---

<!-- ANCHOR:phase-context -->
### Phase Context

This is **Phase 6** of the Hybrid RAG Fusion Refinement specification.

**Scope Boundary**: Sprint 5 scope boundary — pipeline architecture. Establishes clean 4-stage pipeline with architectural invariant (Stage 4 = no score changes), adds retrieval optimizations (spec folder pre-filter, query expansion), and integrates spec-kit signals (template anchors, validation metadata).

**R6 Conditionality**: R6 pipeline refactor is CONDITIONAL — required only if Sprint 2 score normalization fails exit gate, OR Stage 4 invariant is deemed architecturally necessary regardless of normalization outcome. If Sprint 2 normalization succeeds and no architectural justification exists for the invariant, R6 may be descoped.

**Dependencies**:
- Sprint 4 exit gate (feedback loop complete — R1, R11, R13-S2 verified)

> **HARD SCOPE CAP**: Sprint 5 is beyond the recommended off-ramp (Sprint 3). Per root spec, starting Sprint 5+ requires separate NEW spec approval and explicit justification based on Sprint 3 off-ramp evaluation results.

**Deliverables**:
- 4-stage pipeline refactor with Stage 4 invariant (R6)
- Spec folder pre-filter (R9)
- Query expansion with R15 mutual exclusion (R12)
- Template anchor optimization (S2)
- Validation signals as retrieval metadata (S3)
- Dual-scope memory auto-surface hooks at tool dispatch and session compaction (TM-05)

**Internal Phasing**: Phase A (Pipeline) MUST pass before Phase B (Search + Spec-Kit) begins.
<!-- /ANCHOR:phase-context -->

---

<!-- ANCHOR:problem -->
## 2. PROBLEM & PURPOSE

### Problem Statement

The current pipeline intermixes scoring, filtering, and annotation without clear stage boundaries. This enables anti-patterns like double-weighting (G2) where intent weights or other scoring signals can be applied multiple times across different code paths. Spec folder pre-filtering is absent, requiring full corpus search even when the user has specified a folder. No query expansion exists. Template and validation signals generated by the spec-kit system are unused in retrieval scoring.

### Purpose

Establish a clean 4-stage pipeline with an architectural invariant (Stage 4 cannot modify scores), add retrieval optimizations for speed and relevance, and surface spec-kit signals in the scoring layer.
<!-- /ANCHOR:problem -->

---

<!-- ANCHOR:scope -->
## 3. SCOPE

### In Scope

- **R6**: 4-stage pipeline refactor with Stage 4 invariant (no score changes after Stage 3)
- **R9**: Spec folder pre-filter for scoped queries
- **R12**: Query expansion (suppressed when R15="simple") with `SPECKIT_EMBEDDING_EXPANSION` flag
- **S2**: Template anchor optimization — anchor-aware retrieval metadata
- **S3**: Validation signals as retrieval metadata — validation metadata in scoring
- **PI-A4**: Constitutional memory as retrieval directives — reformat constitutional memories with `retrieval_directive` metadata field (deferred from Sprint 4 per REC-07)

### Out of Scope

- R15 changes — locked from Sprint 3
- R11 changes — locked from Sprint 4
- New fusion algorithms — RRF/RSF decision locked from Sprint 3
- Graph deepening — Sprint 6 scope

### Internal Phasing

- **Phase A (Pipeline)**: R6 decomposed into 8 sub-tasks (T002a-T002h, 40-63h total). See `tasks.md` for the authoritative sub-task breakdown including stage architecture definition, per-stage implementation, integration, feature flag interaction testing, and dark-run verification.
  - MUST pass exit gate (0 differences in positions 1-5 AND rank correlation >0.995) before Phase B starts
- **Phase B (Search + Spec-Kit)**: R9, R12, S2, S3, TM-05 (28-43h) — starts only after Phase A passes. Phase B tasks are parallelizable ([P] markers in tasks.md); wall-clock time may be less than sequential effort estimate.

### Files to Change

| File Path | Change Type | Description |
|-----------|-------------|-------------|
| `memory-search.ts` | Major Modify | R6: 4-stage pipeline architecture |
| lib/search/pipeline/ | Create | R6: Stage definitions and boundaries |
| handlers/memory-search.ts, handlers/memory-context.ts | Modify | R9: Spec folder pre-filter, R12: Query expansion |
| Template/validation handlers | Modify | S2: Anchor optimization, S3: Validation metadata |
| `hooks/memory-surface.ts` | Modify | TM-05: Dual-scope injection hooks at tool dispatch and session compaction |
<!-- /ANCHOR:scope -->

---

<!-- ANCHOR:requirements -->
## 4. REQUIREMENTS

### P2 - Important (can defer with documented reason)

| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| REQ-S5-001 | **R6**: 4-stage pipeline with Stage 4 invariant (decomposed into 4 sub-tasks: Stage1/Stage2/Stage3/Stage4 + integration) | 0 ordering differences in positions 1-5 AND weighted rank correlation >0.995 on eval corpus (relaxed from strict "0 differences" which is fragile for floating-point arithmetic), 158+ tests pass. Flag: `SPECKIT_PIPELINE_V2` |
| REQ-S5-002 | **R9**: Spec folder pre-filter | Cross-folder queries produce identical results to without pre-filter |
| REQ-S5-003 | **R12**: Query expansion (suppressed when R15="simple") | No simple query latency degradation. Flag: `SPECKIT_EMBEDDING_EXPANSION` |
| REQ-S5-004 | **S2**: Template anchor optimization | Anchor-aware retrieval metadata present in results |
| REQ-S5-005 | **S3**: Validation signals as retrieval metadata | Validation metadata integrated into scoring |
| REQ-S5-006 | **TM-05**: Dual-scope memory auto-surface hooks at tool dispatch and session compaction lifecycle points, with per-point token budgets (4000 max). Extends `hooks/memory-surface.ts`. Behind config/logic in Spec-Kit integration layer | Memory auto-surface fires at tool dispatch and session compaction; per-point token budget of 4000 enforced; no regression in existing auto-surface behavior |

### Acceptance Scenarios

1. **Given** `SPECKIT_PIPELINE_V2` is enabled and Stage 3 produces ranked results, **When** Stage 4 filter/annotate executes, **Then** scores and ordering are unchanged.
2. **Given** a query is scoped to a spec folder, **When** R9 pre-filtering runs before scoring, **Then** only in-scope candidates are processed and result relevance remains equivalent to baseline behavior.
3. **Given** R15 classifies a query as `simple`, **When** R12 expansion logic is evaluated, **Then** expansion is skipped and simple-query latency remains within the defined guardrail.
4. **Given** template-anchor and validation metadata are available for results, **When** Stage 2 composite scoring executes, **Then** both S2 and S3 signals are attached and applied at the single scoring point.
<!-- /ANCHOR:requirements -->

---

<!-- ANCHOR:success-criteria -->
## 5. SUCCESS CRITERIA

- **SC-001**: R6 dark-run: 0 ordering differences in positions 1-5 AND weighted rank correlation >0.995 on full eval corpus
- **SC-002**: All 158+ existing tests pass with `SPECKIT_PIPELINE_V2` enabled
- **SC-003**: Stage 4 invariant verified: no score modifications in Stage 4
- **SC-004**: R9 cross-folder queries identical to without pre-filter
- **SC-005**: R12+R15 mutual exclusion: R12 suppressed when R15="simple"
- **SC-006**: R12 p95 simple query latency within 5% of pre-R12 baseline
- **SC-007**: Intent weights applied ONCE in Stage 2 (prevents G2 recurrence)
- **SC-008**: Sprint 5 exit gate — all requirements verified
<!-- /ANCHOR:success-criteria -->

---

<!-- ANCHOR:risks -->
## 6. RISKS & DEPENDENCIES

| Type | Item | Impact | Mitigation |
|------|------|--------|------------|
| Risk | R6 is single largest work item (40-55h) | High | Checkpoint before start; off-ramp to retain current pipeline if ordering regressions unresolvable |
| Risk | Ordering regression in dark-run | High | Off-ramp: retain current pipeline and implement R9/R12/S2/S3 as incremental patches |
| Risk | R12+R15 mutual exclusion must be enforced | Medium | Explicit guard: if R15 classification = "simple", skip R12 expansion |
| Risk | G2 recurrence — intent weights applied in multiple stages | Medium | Stage 2 = single point for all scoring signals; Stage 4 invariant enforces no-score-change |
| Dependency | Sprint 4 exit gate | Blocks start | Must be verified complete |
<!-- /ANCHOR:risks -->

---

<!-- ANCHOR:nfr -->
## 7. NON-FUNCTIONAL REQUIREMENTS

### Performance
- **NFR-P01**: R6 pipeline must not degrade p95 latency vs current implementation
- **NFR-P02**: R12 must not degrade simple query latency (R15 mutual exclusion)
- **NFR-P03**: R9 pre-filter should reduce latency for scoped queries

### Reliability
- **NFR-R01**: All 158+ existing tests must pass under `SPECKIT_PIPELINE_V2`
- **NFR-R02**: Stage 4 invariant: any code that modifies scores after Stage 3 is a build-time error (compile-time type guards) with runtime assertion as defense-in-depth

### Maintainability
- **NFR-M01**: Each stage has clear interface boundary — stages are independently testable
- **NFR-M02**: Stage definitions documented in code with JSDoc
<!-- /ANCHOR:nfr -->

---

<!-- ANCHOR:edge-cases -->
## 8. EDGE CASES

### Data Boundaries
- **R9 with no spec folder**: Pre-filter is a no-op — full corpus search
- **R12 with empty expansion**: If query expansion produces no additional terms, original query proceeds unchanged
- **S2/S3 with no template/validation data**: Missing signals are omitted — scoring not degraded

### Error Scenarios
- **R6 stage boundary violation**: Stage 4 attempts score modification — assertion/guard catches and logs error
- **R12+R15 flag conflict**: Both expansion and simple routing active — R15 takes precedence, R12 suppressed

### State Transitions
- **Phase A to Phase B gate**: R6 must achieve 0 ordering differences before Phase B begins
- **R6 off-ramp**: If ordering regressions cannot be resolved, retain current pipeline and implement R9/R12/S2/S3 as incremental patches to existing code
<!-- /ANCHOR:edge-cases -->

---

<!-- ANCHOR:complexity -->
## 9. COMPLEXITY ASSESSMENT

| Dimension | Score | Notes |
|-----------|-------|-------|
| Scope | 20/25 | R6 is major refactor (40-55h); 4 additional features in Phase B |
| Risk | 14/25 | Ordering regression risk; R6 off-ramp defined; R12+R15 interaction |
| Research | 6/20 | Research complete (142 analysis); 4-stage architecture designed |
| **Total** | **40/70** | **Level 2** |
<!-- /ANCHOR:complexity -->

---

<!-- ANCHOR:questions -->
## 10. OPEN QUESTIONS

- **OQ-S5-001** [CLOSED — UT-7 R2]: Stage 4 invariant enforced via **compile-time TypeScript type guards** (read-only score fields in Stage 4 input/output types) as primary enforcement, with **runtime assertion** (score delta = 0 check at Stage 4 exit) as defense-in-depth. Rationale: compile-time enforcement prevents the pattern from being written; runtime assertion catches edge cases missed by type system.
- **OQ-S5-002** [CLOSED — UT-7 R4]: S2 (template anchor) and S3 (validation) signals are **independent ranking dimensions** in the composite scoring model, expanding it from 5-factor to 7-factor with rebalanced weights. Both signals are applied exclusively in Stage 2 as part of the consolidated scoring point. Weight rebalancing ensures existing factor influence is preserved proportionally. Rationale: independent dimensions provide maximum tuning flexibility while the Stage 2 single-application-point architecture prevents G2-class double-weighting.
<!-- /ANCHOR:questions -->

---

---

<!-- ANCHOR:pageindex-integration -->
### PageIndex Integration

Sprint 5 incorporates two PageIndex recommendations that extend the pipeline refactor and validation infrastructure.

#### PI-B1: Tree Thinning for Spec Folder Consolidation

**Rationale**: The R6 pipeline refactor establishes clean stage boundaries, but the context loading step that precedes the pipeline can still be token-heavy when spec folders contain many small files. PI-B1 applies bottom-up merging of small files during spec folder context loading:

- Files under 200 tokens: merge summary into parent document
- Files under 500 tokens: use file content directly as the summary (no separate summary pass needed)
- Memory files: 300-token threshold for thinning, 100-token threshold where the text itself is the summary

This is an extension of the `generate-context.js` workflow, not a change to the pipeline stages themselves. It reduces token overhead before Stage 1 candidate generation without modifying any scoring logic.

**Relationship to existing work**: PI-B1 is a pre-pipeline optimization that operates on the context loading layer. It complements the R9 spec folder pre-filter (which runs inside the pipeline) by reducing context size before the pipeline starts. The Stage 4 invariant is unaffected.

**Effort**: 10-14h | **Risk**: Low

#### PI-B2: Progressive Validation for Spec Documents

**Rationale**: The current `validate.sh` script operates as a binary pass/fail gate. PI-B2 extends it to a 4-level progressive pipeline:

1. **Detect** — identify all violations (existing behavior)
2. **Auto-fix** — apply safe mechanical corrections automatically: missing dates, heading level normalization, whitespace normalization
3. **Suggest** — present non-automatable issues with guided fix options
4. **Report** — produce structured output (exit 0/1/2) with before/after diffs for all auto-fixes

All auto-fixes are logged with before/after diffs as the primary mitigation against silent corruption. This makes the validation step actionable rather than purely diagnostic, reducing the manual effort required to bring a spec folder into compliance.

**Relationship to existing work**: PI-B2 extends `validate.sh` from the Sprint 5 verification infrastructure. It does not affect the pipeline stages, scoring logic, or any Sprint 5 feature flags. Exit codes remain compatible: exit 0 = pass, exit 1 = warnings, exit 2 = errors (must fix).

**Effort**: 16-24h | **Risk**: Medium | **Mitigation**: Log all auto-fixes with before/after diff; dry-run mode available
<!-- /ANCHOR:pageindex-integration -->

---

## RELATED DOCUMENTS

- **Implementation Plan**: See `plan.md`
- **Task Breakdown**: See `tasks.md`
- **Verification Checklist**: See `checklist.md`
- **Parent Spec**: See `../spec.md`
- **Parent Plan**: See `../plan.md`

---

### R6 4-Stage Architecture

| Stage | Name | Responsibilities | Score Changes |
|-------|------|-----------------|---------------|
| 1 | Candidate Generation | 5 channels execute, raw results collected | N/A (raw scores) |
| 2 | Fusion + Signal Integration | RRF/RSF, causal boost, co-activation, composite, intent weights (ONCE) | YES |
| 3 | Rerank + Aggregate | Cross-encoder, MMR, MPAB | YES |
| 4 | Filter + Annotate | State filter, session dedup, constitutional injection, attribution | **NO** |

**Architectural Invariant**: Stage 4 MUST NOT modify scores. Any ordering change after Stage 3 is a bug.

---

<!--
LEVEL 2 SPEC — Phase 6 of 8
- Core + L2 addendums (NFR, Edge Cases, Complexity)
- Phase-child-header addendum
- Sprint 5: Pipeline Refactor
-->
