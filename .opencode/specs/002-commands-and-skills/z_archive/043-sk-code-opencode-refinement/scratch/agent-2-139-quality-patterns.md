# 139-hybrid-rag-fusion Quality Patterns (Agent 2)

## Repeated Anti-Patterns
1. **Graph contract drift (FM-01).** The hybrid retrieval formatter still assumes a row-shaped `memory` payload while graph search now emits richer `mem:edgeId`/edge-level metadata, so downstream ranking and relation scoring can misinterpret or silently drop key provenance fields. Source: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/research.md` (Failure Mode Inventory, FM-01).
2. **Deep-mode pipeline-to-context fan-out gaps (FM-02) coupled with deferred handler coverage (FM-06).** Deep-mode expansion only activates when `memory_context` passes `'deep'`, but propagation tests and handler suites defer the core ranking paths, leaving repeated regression risk when hybrid search wiring changes. Source: same research doc (FM-02 + Test Coverage Observations).
3. **Documentation/telemetry schema drift (FM-05).** README claims about tool counts, telemetry schema shapes, and search contract metadata routinely diverge from implementation, which erodes trust and makes validation discipline subjective rather than evidence-based. Source: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/research.md` (Failure Mode Inventory FM-05 and Automation Opportunities 1 & 4).

## Guardrails & Validation Discipline
1. **P0 requirement lattice (REQ-002, REQ-007, REQ-008, REQ-009).** The spec mandates deterministic retrieval/fusion behavior, parser/indexing invariants, storage transaction recovery, and telemetry/schema governance before completion, so every change must map to at least one of those contracts and include evidence for the associated regression gate. Source: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/spec.md` (Requirements table, P0 entries).
2. **Automation loops as regression gates.** Research section 8 turns contract-sync CI for docs/code, strict retrieval schema tests, self-healing index/retrieval health sweeps, telemetry schema validation, and mutation/ledger audits into measurable guardrails, forcing tooling and docs to stay aligned and regressions to trip observable checks. Source: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/research.md` (Automation Opportunities).
3. **ToC policy enforcement for spec docs.** Level 2 spec 007 enforces that only `research.md` may retain a Table of Contents and that non-research artifacts are cleaned, keeping documentation consistent and avoidable drift controlled by policy rather than ad-hoc reviewers. Source: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/007-spec-kit-templates/spec.md` (Problem, Scope, Requirements).

## Candidate Standards
### sk-code--opencode
- **Standard text:** “Every change touching hybrid retrieval/fusion, session routing, or storage contracts must reference the deterministic subsystem requirement (REQ-002/003/004/007/008/009), include regression fixtures that prove the invariants hold, and pass the automation loops (contract-sync CI, schema validation, recovery sweeps) described in the 006 research inventory before claiming completion.” Sources: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/spec.md` (Requirements table) plus `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/research.md` (Automation Opportunities).
### sk-code--review
- **Standard text:** “Reviews must verify policy compliance for hybrid RAG docs—confirm there are no unintended `## TABLE OF CONTENTS` blocks outside `research.md` and cite the guarding artifact (spec 007)—and ensure any code changes reference the relevant 006 guardrails (deterministic retrieval, index invariants, telemetry schema) with explicit regression evidence before approving.” Sources: `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/007-spec-kit-templates/spec.md` (ToC policy) and `.opencode/specs/003-system-spec-kit/139-hybrid-rag-fusion/006-hybrid-rag-fusion-logic-improvements/spec.md` (Requirements/guardrails).
