# Research - Performance Patterns Update

## Overview

This document captures findings from 10 parallel research agents that analyzed the workflows-code skill and performance optimization patterns from spec 024-performance-optimization.

---

## Agent 1: Skill Structure Analysis (Opus)

### Focus
Analyze current workflows-code SKILL.md structure and identify gaps for performance patterns.

### Key Findings

**Current Structure:**
- Phase 1: Implementation (existing)
- Phase 1.5: Code Quality Gate (existing)
- Phase 2: Debugging (existing)
- Phase 3: Verification (existing)

**Identified Gaps:**

| Gap | Priority | Description |
|-----|----------|-------------|
| Phase 0: Research | P0 | No research/audit stage before implementation |
| CWV Remediation Guide | P0 | No Core Web Vitals optimization patterns |
| Resource Loading Patterns | P0 | No preconnect/prefetch/preload documentation |
| Webflow Constraints | P1 | Platform limitations not documented |
| Third-Party Performance | P1 | No GTM/analytics optimization patterns |
| Multi-Agent Research | P2 | 10-agent methodology not codified |

### Recommendation
Add Phase 0: Research as optional stage with performance audit workflow and 10-agent reference.

---

## Agent 2: Performance Patterns Analysis (Opus)

### Focus
Identify all performance patterns from 024-performance-optimization implementation.

### Key Findings

**9 Patterns Identified:**

| # | Pattern | Source | LOC |
|---|---------|--------|-----|
| 1 | LCP Safety Timeout | global.html:83-92 | 10 |
| 2 | Preconnect Hints | global.html:45-47 | 3 |
| 3 | GTM Delay (requestIdleCallback) | global.html:7-26 | 20 |
| 4 | Async CSS Loading | home.html:30-32 | 3 |
| 5 | Safari Fallback Pattern | global.html:23-25 | 3 |
| 6 | Noscript Fallback | home.html:32 | 1 |
| 7 | Console Warning Debug | global.html:90 | 1 |
| 8 | Class-based Page Reveal | global.html:88 | 1 |
| 9 | Timeout Configuration | global.html:92 | 1 |

**Pattern Categories:**
- **LCP Optimization:** Patterns 1, 8
- **Resource Loading:** Patterns 2, 4, 6
- **Script Optimization:** Patterns 3, 5
- **Debugging:** Pattern 7
- **Configuration:** Pattern 9

### Code Examples

**Pattern 1: LCP Safety Timeout**
```javascript
setTimeout(function () {
  var pw = document.querySelector('.page--wrapper, [data-target="page-wrapper"]');
  if (pw && !pw.classList.contains('page-ready')) {
    pw.classList.add('page-ready');
    console.warn('[LCP Safety] Force-revealed page after timeout');
  }
}, 3000);
```

**Pattern 3: GTM Delay**
```javascript
(function () {
  function loadGTM() {
    // GTM code
  }
  if ('requestIdleCallback' in window) {
    requestIdleCallback(loadGTM, { timeout: 3000 });
  } else {
    setTimeout(loadGTM, 2000); // Safari fallback
  }
})();
```

**Pattern 4: Async CSS Loading**
```html
<link rel="preload" href="style.css" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="style.css"></noscript>
```

---

## Agent 3: Multi-Agent Research Analysis (Opus)

### Focus
Document the 10-agent research methodology used in 024-performance-optimization.

### Key Findings

**10-Agent Specialization Model:**

| Agent | Focus Area | Key Deliverable |
|-------|------------|-----------------|
| 1 | HTML Loading Strategy | Script loading order, critical path |
| 2 | JS Bundle Inventory | File count, sizes, dependencies |
| 3 | Third-Party Scripts | External resources, impact analysis |
| 4 | CSS Performance | File sizes, critical CSS candidates |
| 5 | LCP/Images Analysis | LCP element identification, root cause |
| 6 | Above-Fold Resources | Critical resource mapping |
| 7 | Animation Performance | Motion.dev usage, GPU layers |
| 8 | Initialization Patterns | DOMContentLoaded handlers, polling |
| 9 | External Libraries | Library usage vs bundle size |
| 10 | Network Waterfall | Request timing, blocking resources |

**Coordination Pattern:**
1. Dispatch all 10 agents in parallel
2. Each agent produces focused analysis
3. Synthesize findings into unified report
4. Identify root cause from cross-agent patterns

**Success Metrics:**
- Root cause identified: Page hidden until hero JS completes
- 20.2s LCP â†’ 3s safety timeout solution
- Comprehensive codebase understanding in single pass

### Recommendation
Document this model in `references/research/multi-agent-patterns.md` for reuse in future complex analyses.

---

## Agent 4: Webflow Constraints Analysis (Opus)

### Focus
Document Webflow platform limitations affecting performance optimization.

### Key Findings

**TypeKit Constraints:**
- Webflow manages TypeKit loading
- Loads synchronously in `<head>`
- No option for async loading
- **Workaround:** Preconnect hints only (-100-300ms improvement)

**jQuery/webflow.js Constraints:**
- Auto-injected by Webflow
- Cannot add defer/async attributes
- Required for Webflow interactions
- **Workaround:** None available for core files

**CSS Constraints:**
- Single CSS file generated by Webflow
- No critical CSS extraction
- Cannot split above/below fold
- **Workaround:** Custom CSS in head code block

**Custom Code Constraints:**
- Head code runs early but after Webflow CSS
- Body code runs after DOM ready
- Page-specific code available
- **Workaround:** Use head code for preconnects, body code for deferred scripts

**Summary Table:**

| Resource | Can Async? | Can Defer? | Workaround |
|----------|------------|------------|------------|
| TypeKit | No | No | Preconnect |
| jQuery | No | No | None |
| webflow.js | No | No | None |
| Main CSS | No | N/A | Custom critical CSS |
| Custom scripts | Yes | Yes | Full control |
| Third-party | Yes | Yes | Full control |

---

## Agent 5: Verification Patterns Analysis (Opus)

### Focus
Document performance verification workflow from 024-performance-optimization.

### Key Findings

**Before/After Protocol:**

1. **Pre-Implementation Baseline**
   - PageSpeed Insights Mobile run
   - PageSpeed Insights Desktop run
   - Record: LCP, FCP, TBT, CLS, SI, Score

2. **Implementation Checkpoints**
   - Incremental testing after each major change
   - Console error monitoring
   - Functionality regression checks

3. **Post-Implementation Verification**
   - PageSpeed Insights re-run
   - Side-by-side metric comparison
   - Regression detection

**Baseline Metrics Captured (024):**

| Metric | Mobile | Desktop |
|--------|--------|---------|
| LCP | 20.2s | 3.7s |
| FCP | 6.2s | 1.5s |
| SI | 8.7s | 2.0s |
| TBT | 110ms | 40ms |
| CLS | 0.004 | 0.014 |
| Score | ~30 | ~70 |

**Functionality Checks:**
- [ ] Homepage loads correctly
- [ ] Navigation works (desktop + mobile)
- [ ] Video playback works
- [ ] Carousels/sliders work
- [ ] Cookie consent works
- [ ] No console errors

### Recommendation
Create `references/verification/performance-checklist.md` with this protocol.

---

## Agent 6-10: Supporting Analysis (Sonnet)

### Agent 6: Existing Folder Structure
- Confirmed 004-workflows-code has 6 sub-folders (001-006)
- Next folder: 007-performance-patterns-update
- Each sub-folder has independent documentation

### Agent 7: References Analysis
- Current references cover: implementation, debugging, verification, deployment
- Gaps: performance, research subdirectories
- Good foundation to build upon

### Agent 8: Template Requirements
- Level 3+ requires 6 files: spec, plan, tasks, checklist, decision-record, research
- Estimated ~965 lines total for complete documentation

### Agent 9: Async Patterns Review
- Current async-patterns.md covers promises, async/await
- Missing: requestIdleCallback, Safari fallbacks
- Update needed for comprehensive coverage

### Agent 10: Priority Assessment
- P0: CWV remediation, resource loading, SKILL.md update
- P1: Webflow constraints, third-party, verification
- P2: Multi-agent, async update

---

## Synthesis: Required Skill Updates

### New Files (6)

| File | Priority | LOC |
|------|----------|-----|
| `references/performance/cwv-remediation.md` | P0 | ~200 |
| `references/performance/resource-loading.md` | P0 | ~150 |
| `references/performance/webflow-constraints.md` | P1 | ~100 |
| `references/performance/third-party.md` | P1 | ~100 |
| `references/verification/performance-checklist.md` | P1 | ~80 |
| `references/research/multi-agent-patterns.md` | P2 | ~150 |

### File Updates (2)

| File | Priority | Changes |
|------|----------|---------|
| `SKILL.md` | P0 | Add Phase 0: Research |
| `references/implementation/async-patterns.md` | P2 | Add requestIdleCallback |

### Total Estimated LOC: ~830

---

## Revision History

| Date | Author | Changes |
|------|--------|---------|
| 2026-01-26 | Claude Opus 4.5 | Initial research compiled from 10 agents |
