# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: PLAN WORKFLOW (AUTONOMOUS MODE)
# ─────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for autonomous planning
purpose: Spec-driven planning with autonomous execution through step 7
action: Run SpecKit from spec to planning with continuous self-validation

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: none
  tracking: progressive_task_checklists
  validation: continuous_self_validation

# ─────────────────────────────────────────────────────────────────
# PLANNING PHILOSOPHY
# ─────────────────────────────────────────────────────────────────
planning_philosophy:
  principle: "Clarity first, completeness second"
  approach: "Thorough analysis with iterative refinement"
  mandate: "Define requirements, validate assumptions, plan incrementally, execute autonomously"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  spec_folder: "[SPEC_FOLDER] - Spec folder path. Leave empty to auto-create next available."
  context: "[CONTEXT] - Background information, constraints, existing docs. Leave empty to infer."
  issues: "[ISSUES] - Known issues or concerns to address. Leave empty to discover."
  request: "[REQUEST] - Feature or improvement to plan. REQUIRED."
  environment: "[STAGING LINK] - Staging/production URL for browser testing. Leave empty to skip."
  scope: "[FILES] - Files or folders to focus on. Leave empty for default scope."

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "spec_folder path using pattern specs/{NNN} or specs/{NNN-name}"
    fallback: "Extract numeric portion or use timestamp if extraction fails"
  defaults: { spec_folder_empty: "Auto-create specs/{NNN} from highest +001", context_empty: "Infer from request/staging/codebase", issues_empty: "Discover during workflow", environment_empty: "Skip browser testing", scope_empty: "specs/**" }
  scope_policy: { default: "specs/**", rule: "Limit file operations to scope when provided" }

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING
# ─────────────────────────────────────────────────────────────────
context_loading:
  trigger: "At workflow START, before Step 1"
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    parameters: { query: "planning context for {spec_folder_name}", specFolder: "{spec_folder_path}", anchors: ['summary', 'decisions', 'state', 'planning'] }
  command_reference: "/memory:context"
  when_to_skip: ["New spec folder (no prior context)", "User says 'skip context' or 'fresh start'"]
  behavior: { if_found: "Surface relevant decisions/state before proceeding", if_none: "Proceed to Step 1" }

# ─────────────────────────────────────────────────────────────────
# DOCUMENTATION LEVELS
# ─────────────────────────────────────────────────────────────────
documentation_levels:
  level_1_baseline:
    name: "Level 1 (Baseline)"
    required_files: [spec.md, plan.md, tasks.md]
    loc_guidance: "<100 LOC"
    use_case: "Simple changes, bug fixes"
  level_2_verification:
    name: "Level 2 (Verification)"
    required_files: [spec.md, plan.md, tasks.md, checklist.md]
    loc_guidance: "100-499 LOC"
    use_case: "Medium features, refactoring"
  level_3_full:
    name: "Level 3 (Full)"
    required_files: [spec.md, plan.md, tasks.md, checklist.md, decision-record.md]
    loc_guidance: ">=500 LOC"
    use_case: "Complex features, architecture changes"
  level_selection:
    note: "LOC thresholds are SOFT GUIDANCE - choose level based on complexity and risk"
    default: "Level 1 for simple tasks, escalate based on analysis"

# ─────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ─────────────────────────────────────────────────────────────────
available_templates:
  default_level: level_2
  level_1:
    spec: .opencode/skill/system-spec-kit/templates/level_1/spec.md
    plan: .opencode/skill/system-spec-kit/templates/level_1/plan.md
    tasks: .opencode/skill/system-spec-kit/templates/level_1/tasks.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_1/implementation-summary.md
  level_2:
    spec: .opencode/skill/system-spec-kit/templates/level_2/spec.md
    plan: .opencode/skill/system-spec-kit/templates/level_2/plan.md
    tasks: .opencode/skill/system-spec-kit/templates/level_2/tasks.md
    checklist: .opencode/skill/system-spec-kit/templates/level_2/checklist.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_2/implementation-summary.md
  level_3:
    spec: .opencode/skill/system-spec-kit/templates/level_3/spec.md
    plan: .opencode/skill/system-spec-kit/templates/level_3/plan.md
    tasks: .opencode/skill/system-spec-kit/templates/level_3/tasks.md
    checklist: .opencode/skill/system-spec-kit/templates/level_3/checklist.md
    decision_record: .opencode/skill/system-spec-kit/templates/level_3/decision-record.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_3/implementation-summary.md
  level_3_plus:
    spec: .opencode/skill/system-spec-kit/templates/level_3+/spec.md
    plan: .opencode/skill/system-spec-kit/templates/level_3+/plan.md
    tasks: .opencode/skill/system-spec-kit/templates/level_3+/tasks.md
    checklist: .opencode/skill/system-spec-kit/templates/level_3+/checklist.md
    decision_record: .opencode/skill/system-spec-kit/templates/level_3+/decision-record.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_3+/implementation-summary.md
  shared:
    research: .opencode/skill/system-spec-kit/templates/research.md
    handover: .opencode/skill/system-spec-kit/templates/handover.md
    debug_delegation: .opencode/skill/system-spec-kit/templates/debug-delegation.md

# ─────────────────────────────────────────────────────────────────
# PARALLEL DISPATCH CONFIGURATION
# ─────────────────────────────────────────────────────────────────
parallel_dispatch_config:
  enabled: true
  scoring: { domain_count: 0.35, file_count: 0.25, loc_estimate: 0.15, parallel_opportunity: 0.20, task_type: 0.05 }
  thresholds: { direct_max: 20, ask_min: 20, min_domains: 2 }
  session_preference_s: 3600
  override_phrases:
    direct: [ "proceed directly", "handle directly", "skip parallel", "skip agents" ]
    parallel: [ "use parallel", "dispatch agents", "parallelize", "use agents" ]
    auto: [ "auto-decide", "auto mode", "decide for me" ]
  eligible_phases: [step_3_specification, step_5_planning]

# ─────────────────────────────────────────────────────────────────
# MULTI-AGENT DISPATCH CONFIGURATION
# ─────────────────────────────────────────────────────────────────
multi_agent_config:
  enabled: true
  dispatch_modes:
    single: { id: A, label: "Single Agent", agents: 1, model: opus }
    multi_small:
      id: B
      label: "Multi-Agent (1+2)"
      orchestrator: { model: opus, role: coordinator }
      workers:
        - { role: architecture_explorer, focus: "Project Structure Analysis", step: 5 }
        - { role: feature_explorer, focus: "Feature Pattern Analysis", step: 5 }
    multi_large:
      id: C
      label: "Multi-Agent (1+3)"
      orchestrator: { model: opus, role: coordinator }
      workers:
        - { role: architecture_explorer, focus: "Project Structure Analysis", step: 5 }
        - { role: feature_explorer, focus: "Feature Pattern Analysis", step: 5 }
        - { role: dependency_explorer, focus: "Dependency and Test Analysis", step: 5 }
  fallback: { timeout_s: 60, on_timeout: "continue with available", on_all_fail: "single-agent mode" }

# ─────────────────────────────────────────────────────────────────
# AGENT ROUTING CONFIGURATION
# ─────────────────────────────────────────────────────────────────
# REFERENCE ONLY — routing metadata, do not dispatch agents from these values
agent_routing:
  specification_phase:
    step: 3
    agent: "@speckit"
    agent_file: ".opencode/agent/speckit.md"
    model: opus
    # REFERENCE ONLY — routing metadata, do not dispatch agents from these values
    dispatch: "Task tool → @speckit create spec.md for {feature_description}"
    fallback: general
  research_phase:
    step: 5
    agent: "@research"
    agent_file: ".opencode/agent/research.md"
    # REFERENCE ONLY — routing metadata, do not dispatch agents from these values
    dispatch: "Task tool → @research technical investigation for {feature_description}"
    fallback: general
    trigger: "confidence < 60% during planning OR user requests research"
    conditional: true
  handover_phase:
    step: 7
    agent: "@handover"
    agent_file: ".opencode/agent/handover.md"
    # REFERENCE ONLY — routing metadata, do not dispatch agents from these values
    dispatch: "Task tool → @handover create session continuation document for {spec_path}"
    fallback: general

# ─────────────────────────────────────────────────────────────────
# QUALITY GATES
# ─────────────────────────────────────────────────────────────────
quality_gates:
  enabled: true
  pre_execution:
    location: "Before Step 1"
    threshold: 70
    blocking: hard
    checks:
      - { id: feature_description, points: 30 }
      - { id: spec_path_valid, points: 30 }
      - { id: no_blocking_deps, points: 20 }
      - { id: execution_mode_set, points: 20 }
    on_fail: "Pre-execution gate below threshold. Missing: {missing_checks}."
  post_execution:
    location: "After Step 7"
    threshold: 70
    blocking: hard
    checks:
      - { id: spec_exists, points: 25 }
      - { id: plan_exists, points: 25 }
      - { id: tasks_exists, points: 20 }
      - { id: context_saved, points: 15 }
      - { id: handover_check, points: 15 }
    on_fail: "Post-execution gate below threshold. Missing: {missing_checks}."

# ─────────────────────────────────────────────────────────────────
# CIRCUIT BREAKER
# ─────────────────────────────────────────────────────────────────
circuit_breaker:
  enabled: true
  thresholds: { failures: 3, recovery_s: 60, success_to_close: 1 }
  states: { CLOSED: normal_operation, OPEN: workflow_halted, HALF_OPEN: single_retry }
  tracked_errors: [task_dispatch, file_write, agent_routing, memory_save]

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with citable source" }
    medium: { range: "40-79%", action: "Proceed with caution, document assumptions" }
    low: { range: "0-39%", action: "STOP - Ask clarification with A/B/C options" }
  scoring_weights: { requirements_clarity: 0.30, technical_approach: 0.25, pattern_alignment: 0.25, risk_awareness: 0.20 }
  reply_format: ["Confidence: NN%", "Top factors: 2-3 bullets", "Next action"]
  escalation: { timebox_minutes: 10, failed_threshold: 2 }

# ─────────────────────────────────────────────────────────────────
# REQUEST ANALYSIS FRAMEWORK
# ─────────────────────────────────────────────────────────────────
request_analysis_framework:
  solution_flow: [parse_request, gather_context, identify_approach, validate_choice, clarify_if_needed, scope_check, execute]
  pre_change_validation: [simplest_solution, scope_discipline, spec_folder_created, confidence_80_plus, sources_cited]

# ─────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT
# ─────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false
  planning_gate:
    location: "After Step 5"
    requirements: ["spec.md exists, no [NEEDS CLARIFICATION] markers", "plan.md exists with technical approach"]
    action_if_failed: "STOP and return to incomplete step"
  step_completion_rule: "Execute ALL activities -> Verify ALL outputs -> Mark step complete -> ONLY THEN proceed. NEVER skip steps. NEVER proceed without completion. NEVER implement without /spec_kit:implement."
  critical_steps:
    step_3_specification: { enforcement: "MUST create spec.md with all sections", verification: "File exists with acceptance criteria" }
    step_5_planning: { enforcement: "MUST create plan.md with technical approach", verification: "File exists with implementation phases" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_request_analysis:
    purpose: Analyze inputs and define planning scope
    activities: [Analyze all user inputs, Define development scope, Verify/create spec folder, Check existing artifacts, Establish planning scope]
    deep_analysis:
      focus: comprehensive_requirement_analysis
      outputs: [requirement_summary, approach_overview, complexity_assessment, key_objectives, success_criteria]
    confidence_checkpoint:
      evaluate_at: "After analyzing all inputs"
      scoring_factors:
        - { factor: "Requirements clarity", weight: 0.40, assess: "Request unambiguous? Goals clear?" }
        - { factor: "Scope definition", weight: 0.30, assess: "Scope well-bounded? Constraints identified?" }
        - { factor: "Context availability", weight: 0.30, assess: "Sufficient context provided or discoverable?" }
      thresholds:
        high_80_plus: { action: "Proceed to Step 2", log: "Confidence: [NN%] - Requirements clear" }
        medium_40_79: { action: "Proceed with caution", log: "Confidence: [NN%] - proceeding with assumptions documented", requirement: "Document assumptions in spec.md" }
        low_below_40:
          action: "STOP - Ask clarification"
          format: '"I need clarity (confidence: [NN%]). Please clarify: A) [interpretation] B) [interpretation] C) [interpretation]"'
          wait_for: "User response"
    validation: understanding_confirmed

  step_2_pre_work_review:
    purpose: Review skills folder and project standards
    activities: [Read/review AGENTS.md, Check .opencode/skill/ for coding standards, Extract coding standards summary, Identify architectural patterns, Document conventions]
    required_documents: [AGENTS.md, "Skills folder (if available)"]
    verification: MUST_REVIEW
    validation: principles_established

  step_3_specification:
    purpose: Create comprehensive feature specification
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, docs]
      decision_logic: "Check override phrases -> session preference -> sequential dependencies -> calculate complexity -> <20% proceed directly, >=20% + 2 domains ALWAYS ask user. No auto-dispatch."
      on_parallel_dispatch:
        agents: [{ name: spec_explorer, focus: "Existing specs and patterns" }, { name: requirement_analyzer, focus: "Similar features and requirements" }]
        dispatch_note: "Spawn agents in SINGLE message for parallel execution"
      fallback: "Proceed with activities if dispatch fails or user chooses direct"
    activities: [Run create.sh (scripts/spec/create.sh), "Estimate complexity and select doc level (L1:<100 LOC, L2:100-499, L3:>=500)", Load and fill spec.md, Generate functional requirements, Define success criteria]
    outputs: [spec.md]
    template: .opencode/skill/system-spec-kit/templates/level_2/spec.md
    confidence_checkpoint:
      evaluate_at: "After drafting spec.md"
      scoring_factors:
        - { factor: "Requirements completeness", weight: 0.35, assess: "All functional requirements testable?" }
        - { factor: "Acceptance criteria clarity", weight: 0.35, assess: "Success criteria measurable?" }
        - { factor: "Technical feasibility", weight: 0.30, assess: "Approach sound? Dependencies identified?" }
      thresholds:
        high_80_plus: { action: "Finalize spec.md, proceed to Step 4", log: "Confidence: [NN%] - Spec complete" }
        medium_40_79: { action: "Add [NEEDS CLARIFICATION] markers", log: "Confidence: [NN%] - Marked uncertainties" }
        low_below_40:
          action: "STOP - Ask clarification before finalizing spec"
          format: '"Spec confidence low ([NN%]). Need clarity: A) [ambiguity 1] B) [ambiguity 2] C) [research spike suggestion]"'
          wait_for: "User response before finalizing spec.md"
      citation_requirement: "[SOURCE: file.md:lines] for code | [CITATION: URL] for external | [CITATION: NONE] for general knowledge"
    validation: spec_complete

  step_4_clarification:
    purpose: Resolve ambiguities and clarify requirements
    activities: ["Extract [NEEDS CLARIFICATION] markers (max 3)", Research codebase for patterns, Resolve ambiguities, Update spec.md with clarifications, Document assumptions]
    outputs: [resolved_ambiguities, clarified_requirements, updated_spec]
    validation: requirements_clear

  step_5_planning:
    purpose: Create technical plan with implementation approach
    # Tool selection delegated to AGENTS.md Section 8
    parallel_dispatch_note: "Dispatches 4 parallel agents via Task tool (Architecture, Feature, Dependency, Test Explorers). No question asked - integral to this phase."
    # REFERENCE ONLY — routing metadata, do not dispatch agents from these values
    inline_parallel_exploration:
      purpose: "Spawn 4 @context agents to discover codebase patterns before planning"
      execution: { tool: Task, subagent_type: context, model: opus, parallel: true }
      agents:
        architecture_explorer:
          focus: "Project structure, entry points, component connections"
          prompt: |
            Explore codebase architecture for: {task_description}
            Return: 1) Architecture hypothesis 2) Full file paths 3) Patterns noticed
            Do NOT draw conclusions - just report findings.
        feature_explorer:
          focus: "Similar features, related patterns"
          prompt: |
            Explore codebase for similar features/patterns for: {task_description}
            Return: 1) Similar features hypothesis 2) Full file paths 3) Patterns noticed
            Do NOT draw conclusions - just report findings.
        dependency_explorer:
          focus: "Imports, modules, affected areas"
          prompt: |
            Explore dependencies and integration points for: {task_description}
            Return: 1) Affected modules hypothesis 2) Full file paths 3) Patterns noticed
            Do NOT draw conclusions - just report findings.
        test_explorer:
          focus: "Test patterns, testing infrastructure"
          prompt: |
            Explore test patterns and testing infrastructure.
            Return: 1) Testing hypothesis 2) Full test file paths 3) Patterns noticed
            Do NOT draw conclusions - just report findings.
      verification:
        approach: ["Read files identified by @context agents", "Verify/refute each hypothesis", "Cross-reference for consistency", "Build complete mental model", "Resolve conflicts by reading additional files"]
      outputs: [architecture_findings, feature_findings, dependency_findings, test_findings, verified_mental_model]
      fallback: { on_failure: "Use inline planning activities below" }
    activities: [Run check-prerequisites.sh --json --paths-only, Load plan.md, Fill Technical Context, Fill Constitution Check, "Phase 0: Generate research.md", "Phase 1: Define component structure/interfaces", Generate Testing Strategy, Generate Success Metrics, Import Risk Matrix from spec, Generate Dependencies Tables, Generate Phase 2-4 outlines]
    outputs: [plan.md, research.md]
    template: .opencode/skill/system-spec-kit/templates/level_2/plan.md
    confidence_checkpoint:
      evaluate_at: "After drafting plan.md"
      scoring_factors:
        - { factor: "Technical approach clarity", weight: 0.30, assess: "Implementation strategy well-defined?" }
        - { factor: "Risk identification", weight: 0.25, assess: "Risks identified with mitigations?" }
        - { factor: "Dependency mapping", weight: 0.25, assess: "All dependencies documented?" }
        - { factor: "Pattern alignment", weight: 0.20, assess: "Follows existing codebase patterns?" }
      thresholds:
        high_80_plus: { action: "Finalize plan.md, proceed to Step 6", log: "Confidence: [NN%] - Plan complete", cite: "Document sources in plan.md Technical Context" }
        medium_40_79: { action: "Proceed but flag uncertainties", log: "Confidence: [NN%] - Noted uncertainties", requirement: "Add RISK markers" }
        low_below_40:
          action: "STOP - Request research spike or clarification"
          format: '"Planning confidence low ([NN%]). A) Research spike: [question] B) Simplify scope C) Clarify requirements: [question]"'
          wait_for: "User decision"
      escalation: { trigger: "2 failed attempts OR 10 minutes elapsed", action: "Present options with current findings" }
    validation: approach_defined

  step_6_save_context:
    purpose: Save conversation context for planning documentation
    activities: [Invoke system-spec-kit skill, Preserve requirements/clarifications, Preserve technical approach decisions, Preserve architecture discussions, Index memory file]
    tool_invocation:
      command: Read(".opencode/skill/system-spec-kit/SKILL.md")
      note: 'Read SKILL.md to activate context saving'
    outputs: ["[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__planning_session.md"]
    validation: context_saved_successfully
    post_save_indexing:
      mcp_tool: memory_save
      invocation: 'spec_kit_memory_memory_save({ filePath: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__planning_session.md" })'
      critical_note: "Call semantic memory MCP DIRECTLY - NEVER through Code Mode"
      when: "Immediately after memory file written to disk"
    anchor_requirements:
      enforcement: MANDATORY
      minimum_anchors: 2
      pattern: "[context-type]-[keywords]-[spec-number]"
      format: "<!-- ANCHOR:ID --> content <!-- /ANCHOR:ID -->"
      case: UPPERCASE
      required_sections:
        - { context_type: "general", section: "Session summary with key outcomes", example_id: "GENERAL-SESSION-SUMMARY-{spec#}" }
        - { context_type: "decision", section: "Key decisions made during session", example_id: "DECISION-{topic}-{spec#}" }
      optional_sections:
        - { context_type: "research", example_id: "RESEARCH-{topic}-{spec#}" }
        - { context_type: "files", example_id: "FILES-{spec#}" }
      benefit: "93% token savings on anchor-based retrieval"
      reference: "See /memory:save Step 3 for full anchor documentation"
    importance_tier:
      assign: normal
      promotion_note: "Use memory_update() to promote to 'important' or 'critical' if warranted"
      tier_reference: "constitutional > critical > important > normal > temporary > deprecated"

  step_7_handover_check:
    purpose: Prompt user to create session handover for future continuity
    activities: [Display handover prompt, "If accepted: run /spec_kit:handover", "If declined: proceed to completion"]
    mandatory_check: true
    display_prompt: |
      Planning complete. Would you like to create a handover document?
      Run: /spec_kit:handover
      Recommended if: implementation in different session, another dev may implement, planning has nuances.
    user_response_handling: { accept: "Run /spec_kit:handover", decline: "Proceed to termination", default: "Wait for user response" }
    outputs: ["handover.md (optional)"]
    validation: handover_check_completed

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 7
  message: "Planning phase completed. Workflow terminated after step 7."
  next_steps: [Review planning docs, Validate technical approach, "Use /spec_kit:implement:auto or /spec_kit:implement:confirm"]

# ─────────────────────────────────────────────────────────────────
# AUTONOMOUS EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
autonomous_execution:
  principle: "Execute planning workflow autonomously with self-validation at each step"
  decision_making: [Analyze requirements from user inputs, Explore codebase for context, Make informed planning decisions, Document reasoning/alternatives, Proceed with best judgment]
  validation_approach: [Self-validate after each step, Verify spec completeness, Ensure technical approach is sound, Validate against quality standards]

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  step_validation_fails: "Review requirements, ask clarifying questions, retry"
  spec_ambiguity_persists: "Document as assumption, add to risk matrix"
  environment_unavailable: "Skip browser testing, document limitation"
  unexpected_error: "Log error, document state, attempt graceful recovery"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - follow_workflow_sequence
  - document_all_decisions
  - validate_before_completion
  - self_validate_and_proceed
  - do_not_prompt_for_user_approval
  - use_checklist_for_verification_level_2_plus
  - mark_checklist_items_with_evidence
  - complete_all_p0_items_before_done
  - get_user_approval_for_p1_deferrals
  NEVER:
  - skip_workflow_steps
  - proceed_beyond_planning
  - make_unsupported_assumptions
  - proceed_without_self_validation
