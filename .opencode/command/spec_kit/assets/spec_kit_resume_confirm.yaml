# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: RESUME WORKFLOW (INTERACTIVE MODE)
# ─────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for interactive session resume
purpose: Resume previous work session with user confirmation at each step
action: Detect session, confirm selection, load context, and present options

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: utility
  compliance: OPTIONAL
  execution: interactive
  approvals: step_by_step
  tracking: session_state_detection
  validation: checkpoint_based

resume_philosophy:
  principle: "Context continuity with user control"
  approach: "Detect, confirm, load, proceed"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  spec_folder: "[SPEC_FOLDER] - Spec folder path. Leave empty to auto-detect from most recent memory."

# ─────────────────────────────────────────────────────────────────
# SESSION DETECTION
# ─────────────────────────────────────────────────────────────────
session_detection:
  priority_order: ["CLI argument", "Deterministic candidate ranking", "Semantic memory search", "Trigger phrase matching", "Most recent memory file by mtime"]
  note: "Stateless architecture - no .spec-active marker file used. Interactive mode confirms ambiguous ranked detections."
  deterministic_ranking:
    roots: ["specs/", ".opencode/specs/"]
    normalization: "Canonicalize alias roots before ranking (specs/ vs .opencode/specs/)"
    filters: ["archive", "test", "fixture", "scratch"]
    tie_breakers: ["artifact completeness", "recent activity", "stable path sort"]
    confidence_contract:
      high_confidence: "present top candidate for confirmation"
      low_confidence_interactive: "present top 3 ranked candidates and require explicit user selection"
  tier_details:
    tier_1_cli:
      method: "Parse $ARGUMENTS for spec folder path"
      priority: "highest"
    tier_1b_ranked_candidates:
      method: "Enumerate candidate folders from both roots, normalize aliases, filter non-active folders, rank deterministically"
      fallback: "tier_2"
    tier_2_semantic:
      method: "memory_list({ limit: 3, sortBy: 'updated_at' })"
      fallback: "tier_3"
    tier_3_triggers:
      method: "memory_match_triggers({ prompt: 'resume work session context' })"
      fallback: "tier_4"
    tier_4_mtime:
      method: "glob {.opencode/,}specs/**/memory/*.md | sort by mtime | head -1"
      fallback: "report no session"
  phase_folder_detection:
    trigger: "After spec folder resolved, check if it contains [0-9][0-9][0-9]-*/ child directories"
    action: "If phase children found → list them with per-child tasks.md completion status → present phase selection UI before proceeding"
    skip: "If --phase-folder was provided in $ARGUMENTS, skip detection and use the specified child directly"
    detection_method_value: "phase-folder"
  fallback: { on_no_memory: "Report no active session, suggest /spec_kit:complete" }

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING
# ─────────────────────────────────────────────────────────────────
context_loading_priority:
  order: ["handover.md (<24h old)", "CONTINUE_SESSION.md", "checklist.md", "Recent memory/*.md (embedded Project State Snapshot)"]
  note: "Use handover.md for fast resume, fall through in priority order"

memory_loading:
  mode: interactive
  behavior: "Check handover.md (<24h) first, then prompt user to select additional memory files"
  options:
    - { id: A, label: "Load most recent memory file", description: "Quick context refresh" }
    - { id: B, label: "Load all recent files (up to 3)", description: "Comprehensive context" }
    - { id: C, label: "List all files and select specific", description: "Choose specific memories" }
    - { id: D, label: "Skip", description: "Start fresh without prior context" }
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    parameters: { query: "resume context for {spec_folder_name}", specFolder: "{spec_folder_path}", anchors: ['summary', 'state', 'next-steps'] }

checkpoint_options:
  session_selection:
    - { label: "Confirm", description: "This is the correct spec folder" }
    - { label: "Select Different", description: "Choose a different spec folder" }
    - { label: "Cancel", description: "Cancel resume operation" }
  continuation:
    - { label: "Continue from pending work", description: "Pick up where you left off" }
    - { label: "Run /spec_kit:implement", description: "Execute remaining tasks" }
    - { label: "Just chat", description: "Work on it manually" }

stale_session_detection:
  check: "last_modified > 7 days"
  interactive_behavior:
    options:
      - { label: "Resume anyway", description: "Load context and continue" }
      - { label: "Fresh start", description: "Keep artifacts, restart workflow" }
      - { label: "Review first", description: "Show what changed in codebase" }
      - { label: "Cancel", description: "Do not resume" }

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with context loading and resume" }
    medium: { range: "40-79%", action: "Proceed with caution - present stale session options" }
    low: { range: "0-39%", action: "STOP - Ask user about context reliability" }
  scoring_weights: { session_recency: 0.40, artifact_completeness: 0.30, memory_availability: 0.20, codebase_changes: 0.10 }
  reply_format: ["Confidence: NN%", "Context source: handover|memory", "Next action"]
  escalation: { timebox_minutes: 5, failed_threshold: 2, action: "Present options to user with current findings" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_session_detection:
    purpose: Detect active session from CLI argument or memory files
    activities:
      - Check CLI argument for spec folder
      - If no argument, build deterministic candidates from `specs/` and `.opencode/specs/`
      - Canonicalize aliases and filter archive/test/fixture/scratch paths
      - Rank candidates deterministically with stable tie-breakers
      - If low confidence, present top-ranked candidates for explicit selection
      - If no ranked candidate, continue to semantic/memory fallback
      - Validate resolved spec folder exists
    outputs: { spec_folder: detected_path, detection_method: argument_or_memory }
    validation: session_detected
    checkpoint:
      question: "Found session. Is this the correct spec folder?"
      options:
        - { label: "Confirm", description: "This is the correct spec folder" }
        - { label: "Select Different", description: "Choose a different spec folder" }
        - { label: "Cancel", description: "Cancel resume operation" }

  step_2_memory_selection:
    purpose: Check for handover.md first, then present memory options
    activities:
      - Check for handover.md in spec_folder (<24h old)
      - If exists, load and display contents
      - Extract Last Completed, Next Action, Blockers from handover.md
      - List memory files sorted by mtime (contain embedded Project State Snapshot)
      - Present numbered options to user, wait for selection
    context_priority: ["handover.md", "memory/*.md (contains Project State Snapshot)"]
    outputs: { handover_loaded: "true|false", selected_memory: user_choice, load_count: number }
    checkpoint:
      question: "Load additional context?"
      note: "If handover.md loaded, user may skip additional memory"
      options:
        - { label: "A) Load most recent memory file", description: "Quick context refresh" }
        - { label: "B) Load all recent files (up to 3)", description: "Comprehensive context" }
        - { label: "C) List all files and select specific", description: "Choose specific memories" }
        - { label: "D) Skip", description: "Continue with current context only" }

  step_3_load_memory:
    purpose: Load selected memory files (in addition to handover.md if loaded)
    activities:
      - Read selected memory file(s) from step 2
      - Merge with handover.md context if already loaded
      - Extract Project State Snapshot (Phase, Active File, Last/Next Action, Blockers)
      - Parse and summarize combined context
    mcp_tool:
      name: memory_search
      note: "Call directly - NEVER through Code Mode. Use anchors for targeted retrieval (~90% token savings)."
      parameters: { query: "resume context", specFolder: "{detected_spec_folder}", anchors: ['summary', 'state', 'next-steps'], includeContent: true }
    outputs: { memory_loaded: true, context_source: "handover|memory|combined", context_summary: extracted_context }
    validation: context_loaded

  step_4_calculate_progress:
    purpose: Calculate task and checklist progress
    activities: [Parse tasks.md for completion status, Parse checklist.md for verification status, Calculate percentages, Identify pending items]
    outputs: { tasks_progress: percentage, checklist_progress: percentage, pending_items: list }
    validation: progress_calculated

  step_5_present_resume:
    purpose: Display resume summary and offer continuation options
    activities: [Display spec folder and last activity, Show progress bars, List artifacts status, Show pending work and next actions, Present continuation options]
    outputs: { resume_summary: displayed }
    validation: resume_complete
    checkpoint:
      question: "Ready to continue. What would you like to do?"
      options:
        - { label: "Continue from pending work", description: "Pick up where you left off" }
        - { label: "Run /spec_kit:implement", description: "Execute remaining tasks" }
        - { label: "Just chat", description: "Work on it manually" }

stale_session:
  threshold_days: 7
  detection: { check: "last_modified > 7 days", action: "Present warning and options" }
  interactive_behavior:
    options:
      - { label: "Resume anyway", description: "Load context and continue" }
      - { label: "Fresh start", description: "Keep artifacts, restart workflow" }
      - { label: "Review first", description: "Show what changed" }
      - { label: "Cancel", description: "Do not resume" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 5
  message: "Session resume complete. Ready to continue work."
  next_steps:
    - "Continue from pending work"
    - "Review implementation summary"
    - "Run /spec_kit:implement if tasks remain"

# ─────────────────────────────────────────────────────────────────
# INTERACTIVE EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
interactive_execution:
  principle: "Execute resume with user approval at each checkpoint"
  checkpoint_behavior: [Complete step activities, Present results summary, Present options for selection, Wait for response, Process feedback, Proceed or redirect as directed]
  user_feedback_handling: { confirm: "Proceed to next step", select_different: "Show folder selection options", skip: "Proceed without loading memory", cancel: "Abort resume operation" }

crash_recovery:
  command_reference: "/memory:continue"
  description: "For crash recovery (context compaction, session interruption) — provides automatic state detection, recovery hints, continuation prompt generation"
  when_to_use: ["Session interrupted unexpectedly", "Context compaction detected", "Need to recover without handover.md"]
  integration_with_resume:
    relationship: "/spec_kit:resume = standard continuation | /memory:continue = crash recovery"
    recommendation: "Use /memory:continue when session crashed; /spec_kit:resume for normal continuation"

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  no_active_session: "Report no session, suggest /spec_kit:complete"
  spec_folder_missing: "Report not found, ask user to specify or create"
  memory_search_failed: { action: "Report error, offer to proceed without context", fallback: "Offer /memory:continue" }
  stale_session_detected: "Present stale session options to user"
  user_cancels: "Acknowledge cancellation, exit gracefully"
  crash_detected: "Suggest /memory:continue for automatic crash recovery"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - detect_session_before_loading
  - confirm_spec_folder_with_user
  - present_memory_options
  - calculate_progress_from_artifacts
  - display_clear_summary
  - use_mcp_tools_directly
  - respect_user_selections
  NEVER:
  - auto_load_without_confirmation
  - proceed_without_user_approval
  - proceed_without_valid_spec_folder
  - call_mcp_through_code_mode
  - ignore_user_cancellation
