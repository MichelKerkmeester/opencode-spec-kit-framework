# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: HANDOVER WORKFLOW
# ─────────────────────────────────────────────────────────────────
role: Session Handover Specialist
purpose: Generate comprehensive handover documentation for session continuation
action: Analyze session context and create detailed handover.md

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: utility
  execution: autonomous
  output: "handover.md file in spec folder"

session_detection:
  priority_order: ["CLI argument", "Deterministic candidate ranking", "Most recent active spec fallback"]
  deterministic_ranking:
    roots: ["specs/", ".opencode/specs/"]
    normalization: "Canonicalize alias roots before ranking (specs/ vs .opencode/specs/)"
    filters: ["archive", "test", "fixture", "scratch"]
    tie_breakers: ["artifact completeness", "recent activity", "stable path sort"]
    confidence_contract:
      high_confidence: "select top ranked candidate"
      low_confidence: "prompt for explicit folder confirmation"
  fallback: "If no eligible folder found, abort handover and request explicit spec path"

pre_handover_validation:
  mode: strict
  required_checks:
    - { id: ANCHORS_VALID, description: "Referenced session docs contain valid opening/closing anchor pairs" }
    - { id: PRIORITY_TAGS, description: "Key pending work and blockers are explicitly tagged by priority in summary" }
    - { id: PLACEHOLDER_FILLED, description: "No unresolved placeholder text remains in generated output" }
  on_warning: "Prompt user to fix first or proceed explicitly"
  on_error: "Block handover creation until resolved or explicitly bypassed"

user_inputs:
  spec_folder: "[SPEC_FOLDER] - Path to spec folder (e.g., specs/007-auth-feature). REQUIRED."
  session_context: "[SESSION_CONTEXT] - Current session context. Auto-gathered from conversation."

output_structure:
  file: handover.md
  location: "[spec_folder]/handover.md"
  target_length: "100-150 lines"
  sections:
    1_session_summary: { title: "Session Summary", content: [Session date/duration, Primary objective, Progress percentage, Key accomplishments (3-5 bullets)] }
    2_current_state: { title: "Current State", content: [Phase (RESEARCH/PLANNING/IMPLEMENTATION/REVIEW), Active file/line, Last action, System state] }
    3_completed_work: { title: "Completed Work", content: [Completed tasks with descriptions, Files created/modified, Tests passed, Documentation updated] }
    4_pending_work: { title: "Pending Work", content: [Immediate next action (specific), Remaining tasks in priority order, Estimated effort, Dependencies] }
    5_key_decisions: { title: "Key Decisions", content: [Decisions made, Rationale, Alternatives rejected, Impact on future work] }
    6_blockers_risks: { title: "Blockers & Risks", content: [Current blockers (or "None"), Potential risks, Mitigation strategies, Questions needing answers] }
    7_continuation: { title: "Continuation Instructions", content: [Exact resume command, Files to review first, Context to load, Quick-start checklist] }

# ─────────────────────────────────────────────────────────────────
# HANDOVER TEMPLATE
# ─────────────────────────────────────────────────────────────────
template: |
  # Session Handover: {{FEATURE_NAME}}

  **Spec Folder**: {{SPEC_FOLDER}}
  **Created**: {{TIMESTAMP}}
  **Session Duration**: {{DURATION_ESTIMATE}}

  ---

  ## 1. Session Summary

  **Objective**: {{PRIMARY_OBJECTIVE}}
  **Progress**: {{PROGRESS_PERCENTAGE}}%

  ### Key Accomplishments
  {{#ACCOMPLISHMENTS}}
  - {{.}}
  {{/ACCOMPLISHMENTS}}

  ---

  ## 2. Current State

  | Field | Value |
  |-------|-------|
  | Phase | {{PHASE}} |
  | Active File | {{ACTIVE_FILE}} |
  | Last Action | {{LAST_ACTION}} |
  | System State | {{SYSTEM_STATE}} |

  ---

  ## 3. Completed Work

  ### Tasks Completed
  {{#COMPLETED_TASKS}}
  - [x] {{TASK}} - {{DESCRIPTION}}
  {{/COMPLETED_TASKS}}

  ### Files Modified
  {{#FILES_MODIFIED}}
  - `{{FILE_PATH}}` - {{CHANGE_DESCRIPTION}}
  {{/FILES_MODIFIED}}

  ---

  ## 4. Pending Work

  ### Immediate Next Action
  > {{NEXT_ACTION}}

  ### Remaining Tasks
  {{#PENDING_TASKS}}
  - [ ] {{TASK}} ({{EFFORT}}) {{#HAS_DEPENDENCY}}← depends on {{DEPENDENCY}}{{/HAS_DEPENDENCY}}
  {{/PENDING_TASKS}}

  ---

  ## 5. Key Decisions

  {{#DECISIONS}}
  ### {{DECISION_TITLE}}
  - **Choice**: {{CHOSEN_OPTION}}
  - **Rationale**: {{RATIONALE}}
  - **Alternatives rejected**: {{ALTERNATIVES}}
  {{/DECISIONS}}
  {{^DECISIONS}}
  No significant decisions made this session.
  {{/DECISIONS}}

  ---

  ## 6. Blockers & Risks

  ### Current Blockers
  {{#BLOCKERS}}
  - **{{BLOCKER_TITLE}}**: {{DESCRIPTION}}
  {{/BLOCKERS}}
  {{^BLOCKERS}}
  None
  {{/BLOCKERS}}

  ### Risks
  {{#RISKS}}
  - {{RISK}} → Mitigation: {{MITIGATION}}
  {{/RISKS}}
  {{^RISKS}}
  No significant risks identified.
  {{/RISKS}}

  ---

  ## 7. Continuation Instructions

  ### To Resume
  ```
  /spec_kit:resume {{SPEC_FOLDER}}
  ```

  ### Files to Review First
  {{#REVIEW_FILES}}
  1. `{{FILE_PATH}}` - {{REASON}}
  {{/REVIEW_FILES}}

  ### Quick-Start Checklist
  - [ ] Load this handover document
  - [ ] Review pending tasks above
  - [ ] Check {{ACTIVE_FILE}} for current state
  - [ ] Execute: {{NEXT_ACTION}}

  ---

  *Generated by /spec_kit:handover:full*

# ─── AGENT AVAILABILITY (conditional — not instructions) ──────────
# These entries define WHICH agent to use IF a workflow step calls for it.
# Do NOT dispatch agents based on reading this section.
# Agents are activated ONLY when their designated step is executing.
agent_availability:
  handover:
    available_at_step: 3
    condition: "ONLY dispatch when Step 3 (Create Handover) is actively executing"
    agent_file: "[runtime_agent_path]/handover.md"
    model: sonnet
    fallback: "general"
    not_for: "automatic handover, pre-step context saving, or premature session ending"

# ─────────────────────────────────────────────────────────────────
# QUALITY GATES
# ─────────────────────────────────────────────────────────────────
quality_gates:
  enabled: true
  pre_execution:
    location: "Before handover generation"
    threshold: 70
    blocking: hard
    checks:
      - { id: spec_path_validated, points: 50 }
      - { id: validation_passed_or_bypassed, points: 50 }
    on_fail: "Pre-execution gate below threshold. Missing: {missing_checks}. Hard block."
  post_execution:
    location: "After handover generation"
    threshold: 70
    blocking: hard
    checks:
      - { id: handover_file_created, points: 40 }
      - { id: no_placeholder_text, points: 30 }
      - { id: json_response_valid, points: 30 }
    on_fail: "Post-execution gate below threshold. Missing: {missing_checks}. Complete before done."

# ─────────────────────────────────────────────────────────────────
# CIRCUIT BREAKER
# ─────────────────────────────────────────────────────────────────
circuit_breaker:
  enabled: true
  thresholds: { failures: 3, recovery_s: 60, success_to_close: 1 }
  states: { CLOSED: normal_operation, OPEN: use_fallback, HALF_OPEN: test_single }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
execution:
  steps:
    - "Resolve spec folder from CLI argument or deterministic ranking"
    - "Run strict pre-handover validation checks (ANCHORS_VALID, PRIORITY_TAGS, PLACEHOLDER_FILLED)"
    - "Analyze current session context"
    - "Extract completed work from tool calls and file changes"
    - "Identify pending tasks from conversation and todo list"
    - "Document decisions made"
    - "Note blockers and risks"
    - "Generate handover.md using template"
    - "Write file to spec folder"
    - "Return file path and summary"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - Resolve or confirm spec folder before generation
  - Run pre-handover validation checks before writing output
  - Be specific in Next Action (file names, line numbers)
  - List files in order of importance
  - Include command to resume
  - Keep total length 100-150 lines
  NEVER:
  - Leave Next Action vague
  - Omit blockers (say None if none)
  - Exceed 200 lines
  - Include sensitive information
