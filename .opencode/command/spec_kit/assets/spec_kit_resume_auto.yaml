# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: RESUME WORKFLOW (AUTONOMOUS MODE)
# ─────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for autonomous session resume
purpose: Resume previous work session with automatic context loading
action: Detect session, load context, and present continuation options

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: utility
  compliance: OPTIONAL
  execution: autonomous
  approvals: none
  tracking: session_state_detection
  validation: context_loaded

resume_philosophy:
  principle: "Context continuity, minimal friction"
  approach: "Auto-detect, auto-load, fast resume"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  spec_folder: "[SPEC_FOLDER] - Spec folder path. Leave empty to auto-detect from most recent memory."

# ─────────────────────────────────────────────────────────────────
# SESSION DETECTION
# ─────────────────────────────────────────────────────────────────
session_detection:
  priority_order: ["CLI argument", "Semantic memory search", "Trigger phrase matching", "Most recent memory file by mtime"]
  note: "Stateless architecture - no .spec-active marker file used"
  tier_details:
    tier_1_cli:
      method: "Parse $ARGUMENTS for spec folder path"
      priority: "highest"
    tier_2_semantic:
      method: "memory_list({ limit: 3, sortBy: 'updated_at' })"
      fallback: "tier_3"
    tier_3_triggers:
      method: "memory_match_triggers({ prompt: 'resume work session context' })"
      fallback: "tier_4"
    tier_4_mtime:
      method: "glob {.opencode/,}specs/**/memory/*.md | sort by mtime | head -1"
      fallback: "report no session"
  phase_folder_detection:
    trigger: "After spec folder resolved, check if it contains [0-9][0-9][0-9]-*/ child directories"
    action: "If phase children found → list them with per-child tasks.md completion status → present phase selection UI before proceeding"
    skip: "If --phase-folder was provided in $ARGUMENTS, skip detection and use the specified child directly"
    detection_method_value: "phase-folder"
  fallback: { on_no_memory: "Report no active session, suggest /spec_kit:complete" }

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING
# ─────────────────────────────────────────────────────────────────
context_loading_priority:
  order: ["handover.md (<24h old)", "CONTINUE_SESSION.md", "checklist.md", "Recent memory/*.md (embedded Project State Snapshot)"]
  note: "Use handover.md for fast resume, fall through in priority order"

memory_loading:
  mode: automatic
  behavior: "Auto-load handover.md (<24h) first, else most recent memory file without prompting"
  selection: most_recent
  max_files: 1
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    parameters: { query: "resume context for {spec_folder_name}", specFolder: "{spec_folder_path}", anchors: ['summary', 'state', 'next-steps'] }

stale_session_detection:
  check: "last_modified > 7 days"
  autonomous_behavior: "Warn about stale context but continue"

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with context loading and resume" }
    medium: { range: "40-79%", action: "Proceed but warn about potential context staleness" }
    low: { range: "0-39%", action: "Warn user about context reliability issues" }
  scoring_weights: { session_recency: 0.40, artifact_completeness: 0.30, memory_availability: 0.20, codebase_changes: 0.10 }
  reply_format: ["Confidence: NN%", "Context source: handover|memory", "Next action"]
  escalation: { timebox_minutes: 5, failed_threshold: 2 }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_session_detection:
    purpose: Detect active session from CLI argument or memory files
    activities: [Check CLI argument for spec folder, Find most recent memory file if no argument, Validate spec folder exists]
    outputs: { spec_folder: detected_path, detection_method: argument_or_memory }
    validation: session_detected

  step_2_load_memory:
    purpose: Load context using priority order (handover.md first, then memory)
    activities:
      - Check for handover.md in spec_folder (<24h old)
      - If exists, load as primary context
      - If not, select most recent memory/*.md
      - Extract key context (phase, decisions, pending work, next actions from state section)
    context_priority: ["handover.md", "memory/*.md (contains Project State Snapshot)"]
    mcp_tool:
      name: memory_search
      note: "Call directly - NEVER through Code Mode. Use anchors for targeted retrieval (~90% token savings)."
      parameters: { query: "resume context", specFolder: "{detected_spec_folder}", anchors: ['summary', 'state', 'next-steps'], includeContent: true }
    outputs: { memory_loaded: true, context_source: "handover|memory", context_summary: extracted_context }
    validation: context_loaded

  step_3_calculate_progress:
    purpose: Calculate task and checklist progress
    activities: [Parse tasks.md for completion status, Parse checklist.md for verification status, Calculate percentages, Identify pending items]
    outputs: { tasks_progress: percentage, checklist_progress: percentage, pending_items: list }
    validation: progress_calculated

  step_4_present_resume:
    purpose: Display resume summary and continue work
    activities: [Display spec folder and last activity, Show progress bars, List artifacts status, Show pending work and next actions, Proceed directly to continue work]
    outputs: { resume_summary: displayed, continuation_mode: ready }
    validation: resume_complete

stale_session:
  threshold_days: 7
  detection: { check: "last_modified > 7 days", action: "Flag as stale but proceed in auto mode" }
  autonomous_behavior: "Warn about stale context but continue"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 4
  message: "Session resumed successfully. Ready to continue work."
  next_steps: [Continue from pending work, Review implementation summary, Run /spec_kit:implement if tasks remain]

crash_recovery:
  command_reference: "/memory:continue"
  description: "For crash recovery (context compaction, session interruption) — provides automatic state detection, recovery hints, continuation prompt generation"
  when_to_use: ["Session interrupted unexpectedly", "Context compaction detected", "Need to recover without handover.md"]
  integration_with_resume:
    relationship: "/spec_kit:resume = standard continuation | /memory:continue = crash recovery"
    recommendation: "Use /memory:continue when session crashed; /spec_kit:resume for normal continuation"

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  no_active_session: "Report no session, suggest /spec_kit:complete"
  spec_folder_missing: "Report not found, ask user to specify or create"
  memory_search_failed: { action: "Proceed without context", fallback: "Try /memory:continue" }
  stale_session_detected: "Warn user, proceed with caution"
  crash_detected: "Suggest /memory:continue for automatic crash recovery"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - detect_session_before_loading
  - load_most_recent_memory_automatically
  - calculate_progress_from_artifacts
  - display_clear_summary
  - use_mcp_tools_directly
  NEVER:
  - prompt_for_memory_selection_in_auto_mode
  - block_on_stale_session
  - proceed_without_valid_spec_folder
  - call_mcp_through_code_mode
