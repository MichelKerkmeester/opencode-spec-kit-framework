# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: RESEARCH WORKFLOW (INTERACTIVE MODE)
# ─────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for interactive research
purpose: Spec-driven comprehensive technical investigation with user approval
action: Run SpecKit research workflow with user checkpoints

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: interactive
  approvals: step_by_step
  tracking: progressive_research_documentation
  validation: checkpoint_based

# ─────────────────────────────────────────────────────────────────
# RESEARCH PHILOSOPHY
# ─────────────────────────────────────────────────────────────────
research_philosophy:
  principle: "Thoroughness first, documentation second"
  approach: "Systematic investigation with user validation at checkpoints"
  mandate: "Research deeply, validate with user, document comprehensively"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  spec_folder: "[SPEC_FOLDER] - Spec folder path. Leave empty to auto-create next available."
  context: "[CONTEXT] - Background information, technical stack, or investigating context. Leave empty to infer."
  issues: "[ISSUES] - Known issues, questions, or unknowns to investigate. Leave empty to discover."
  request: "[REQUEST] - Research topic or technical question to investigate. REQUIRED."
  environment: "[STAGING LINK] - Staging URL for browser-based analysis. Leave empty to skip."
  scope: "[FILES] - Files or folders to focus investigation on. Leave empty for default scope."

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "spec_folder path using pattern specs/{NNN}, specs/{NNN-name}, or specs/{NNN-parent}/{NNN-phase} (phase child — use parent NNN as spec_id)"
    fallback: "Extract numeric portion or use timestamp if extraction fails"
  defaults: { spec_folder_empty: "Auto-create specs/{NNN} from highest +001", context_empty: "Infer from [REQUEST] and codebase", issues_empty: "Discover during workflow", environment_empty: "Skip browser steps", scope_empty: "specs/**" }
  phase_folder_awareness:
    note: "[SPEC_FOLDER] may be a phase child path (e.g., specs/003-name/001-phase/). When Option E is selected or --phase-folder is provided, spec_id derives from the parent folder NNN, not the child NNN."
    path_pattern: "specs/{NNN-parent}/{NNN-phase}/"
  scope_policy: { default: "specs/**", rule: "Limit file operations to scope when provided" }

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING
# ─────────────────────────────────────────────────────────────────
context_loading:
  trigger: "At workflow START, before Step 1"
  purpose: "Load prior research context and related findings"
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    parameters: { query: "research context for {spec_folder_name}", specFolder: "{spec_folder_path}", anchors: ['summary', 'decisions', 'state', 'research'] }
  command_reference: "/memory:context"
  when_to_skip: ["New spec folder (no prior context)", "User says 'skip context' or 'fresh start'"]
  behavior: { if_context_found: "Surface relevant findings before proceeding", if_no_context: "Proceed to Step 1 without delay" }
  checkpoint:
    question: "Prior research context found. Load it?"
    options:
      - { label: "A) Load context", description: "Review prior research findings and decisions" }
      - { label: "B) Skip", description: "Start fresh without prior context" }

# ─────────────────────────────────────────────────────────────────
# DOCUMENTATION LEVELS
# ─────────────────────────────────────────────────────────────────
documentation_levels:
  level_1_baseline:
    name: "Level 1 (Baseline)"
    required_files: [spec.md, plan.md, tasks.md]
    loc_guidance: "<100 LOC"
    use_case: "Simple changes, bug fixes"
  level_2_verification:
    name: "Level 2 (Verification)"
    required_files: [spec.md, plan.md, tasks.md, checklist.md]
    loc_guidance: "100-499 LOC"
    use_case: "Medium features, refactoring"
  level_3_full:
    name: "Level 3 (Full)"
    required_files: [spec.md, plan.md, tasks.md, checklist.md, decision-record.md]
    loc_guidance: ">=500 LOC"
    use_case: "Complex features, architecture changes"
  level_selection:
    note: "LOC thresholds are SOFT GUIDANCE - choose level based on complexity and risk"
    default: "Research typically supports Level 2+ or Level 3"

# ─────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ─────────────────────────────────────────────────────────────────
available_templates:
  default_level: level_2
  level_1:
    spec: .opencode/skill/system-spec-kit/templates/level_1/spec.md
  level_2:
    spec: .opencode/skill/system-spec-kit/templates/level_2/spec.md
    checklist: .opencode/skill/system-spec-kit/templates/level_2/checklist.md
  level_3:
    spec: .opencode/skill/system-spec-kit/templates/level_3/spec.md
    checklist: .opencode/skill/system-spec-kit/templates/level_3/checklist.md
    decision_record: .opencode/skill/system-spec-kit/templates/level_3/decision-record.md
  level_3_plus:
    spec: .opencode/skill/system-spec-kit/templates/level_3+/spec.md
    checklist: .opencode/skill/system-spec-kit/templates/level_3+/checklist.md
    decision_record: .opencode/skill/system-spec-kit/templates/level_3+/decision-record.md
  shared:
    research: .opencode/skill/system-spec-kit/templates/research.md
    handover: .opencode/skill/system-spec-kit/templates/handover.md
    debug_delegation: .opencode/skill/system-spec-kit/templates/debug-delegation.md

# ─────────────────────────────────────────────────────────────────
# PARALLEL DISPATCH CONFIGURATION
# ─────────────────────────────────────────────────────────────────
parallel_dispatch_config:
  enabled: true
  scoring: { domain_count: 0.35, file_count: 0.25, loc_estimate: 0.15, parallel_opportunity: 0.20, task_type: 0.05 }
  thresholds: { direct_max: 20, ask_min: 20, min_domains: 2 }
  session_preference_s: 3600
  override_phrases:
    direct: [ "proceed directly", "handle directly", "skip parallel", "skip agents" ]
    parallel: [ "use parallel", "dispatch agents", "parallelize", "use agents" ]
    auto: [ "auto-decide", "auto mode", "decide for me" ]
  eligible_phases: [step_3_codebase_investigation, step_4_external_research, step_5_technical_analysis]

# ─────────────────────────────────────────────────────────────────
# MULTI-AGENT DISPATCH CONFIGURATION
# ─────────────────────────────────────────────────────────────────
multi_agent_config:
  enabled: true
  dispatch_modes:
    single: { id: A, label: "Single Agent", agents: 1, model: opus }
    multi_small:
      id: B
      label: "Multi-Agent (1+2)"
      orchestrator: { model: opus, role: coordinator }
      workers:
        - { role: codebase_explorer, focus: "Codebase Investigation", step: 3 }
        - { role: external_researcher, focus: "External Research", step: 4 }
    multi_large:
      id: C
      label: "Multi-Agent (1+3)"
      orchestrator: { model: opus, role: coordinator }
      workers:
        - { role: codebase_explorer, focus: "Codebase Investigation", step: 3 }
        - { role: external_researcher, focus: "External Research", step: 4 }
        - { role: technical_analyzer, focus: "Technical Analysis", step: 5 }
  fallback: { timeout_s: 60, on_timeout: "continue with available", on_all_fail: "single-agent mode" }

# ─── AGENT AVAILABILITY (conditional — not instructions) ──────────
# These entries define WHICH agent to use IF a workflow step calls for it.
# Do NOT dispatch agents based on reading this section.
# Agents are activated ONLY when their designated step is executing.
agent_availability:
  research:
    available_at_steps: [3, 4, 5, 6, 7]
    condition: "ONLY dispatch when Steps 3-7 are actively executing"
    agent_file: "[runtime_agent_path]/research.md"
    fallback: "general"
    not_for: "reviewing this workflow prompt, pre-step investigation, or any pre-step activity"
  handover:
    available_at_step: 9
    condition: "ONLY dispatch when user explicitly requests handover at Step 9"
    agent_file: "[runtime_agent_path]/handover.md"
    fallback: "general"
    note: "Session continuation if ending after research"
    not_for: "automatic handover, pre-step context saving, or premature session ending"

# ─────────────────────────────────────────────────────────────────
# QUALITY GATES
# ─────────────────────────────────────────────────────────────────
quality_gates:
  enabled: true
  pre_execution:
    location: "Before Step 1"
    threshold: 70
    blocking: hard
    checks:
      - { id: research_topic_defined, points: 30 }
      - { id: spec_path_valid, points: 30 }
      - { id: no_blocking_deps, points: 20 }
      - { id: execution_mode_set, points: 20 }
    on_fail: "Pre-execution gate below threshold. Missing: {missing_checks}."
  post_execution:
    location: "After Step 9"
    threshold: 70
    blocking: hard
    checks:
      - { id: research_md_exists, points: 30 }
      - { id: key_questions_answered, points: 25 }
      - { id: checklist_verified, points: 25 }
      - { id: context_saved, points: 20 }
    on_fail: "Post-execution gate below threshold. Missing: {missing_checks}."

# ─────────────────────────────────────────────────────────────────
# CIRCUIT BREAKER
# ─────────────────────────────────────────────────────────────────
circuit_breaker:
  enabled: true
  thresholds: { failures: 3, recovery_s: 60, success_to_close: 1 }
  states: { CLOSED: normal_operation, OPEN: use_fallback, HALF_OPEN: test_single }
  tracked_errors: [tool_timeout, tool_error, validation_failure, agent_dispatch_failure]

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  mode_note: "Interactive mode integrates confidence checks with user approval"
  thresholds:
    high: { range: "80-100%", action: "Document finding with sources" }
    medium: { range: "40-79%", action: "Document with caveats, mark uncertainty" }
    low: { range: "0-39%", action: "STOP - Ask A/B/C or mark UNKNOWN" }
  scoring_weights: { evidence_quality: 0.35, source_reliability: 0.25, completeness: 0.25, contradiction_resolution: 0.15 }
  reply_format: ["Confidence: NN%", "Evidence strength: 2-3 bullets", "Next action"]
  escalation: { timebox_minutes: 10, failed_threshold: 2, action: "Document limitations, ask user for direction" }
  interactive_integration: "Confidence checks surfaced at user checkpoints"

# ─────────────────────────────────────────────────────────────────
# REQUEST ANALYSIS FRAMEWORK
# ─────────────────────────────────────────────────────────────────
request_analysis_framework:
  research_validation: [research_question_clear, sources_identified, scope_bounded, success_criteria_defined, user_approved_direction]
  research_principles:
    - "Thoroughness: Investigate comprehensively before documenting"
    - "Evidence-Based: Cite sources [SOURCE: file:lines] or [CITATION: NONE]"
    - "Acknowledge uncertainty: Mark uncertain findings with UNKNOWN"
  citation_requirement: "ALL findings must cite sources: [SOURCE: file:lines] for code, [CITATION: URL] for external, [UNKNOWN] when unavailable"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT
# ─────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false
  research_gate:
    location: "After Step 8"
    requirements: ["research.md exists with all 17 sections", "Key questions from Step 1 answered"]
    action_if_failed: "STOP and return to incomplete step"
  step_completion_rule: "Execute ALL activities -> Verify ALL outputs -> Present checkpoint for approval -> Mark complete after approval -> THEN proceed. NEVER skip steps, proceed without approval, or submit incomplete research."
  critical_steps:
    step_5: { enforcement: "MUST complete feasibility and risk assessment", verification: "All analysis outputs documented" }
    step_8: { enforcement: "MUST create research.md with all 17 sections", verification: "File exists, all sections populated" }

checkpoint_options:
  standard:
    - { label: "Approve", description: "Approve and proceed" }
    - { label: "Review Details", description: "Show more details" }
    - { label: "Modify", description: "Request changes" }
    - { label: "Skip", description: "Skip (if optional)" }
  research_direction:
    - { label: "Continue", description: "Direction is good, proceed" }
    - { label: "Go Deeper", description: "Investigate more thoroughly" }
    - { label: "Redirect", description: "Change research focus" }
    - { label: "Skip Area", description: "Not relevant" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_request_analysis:
    purpose: Analyze research request and define investigation scope
    activities: [Analyze user inputs, Define research scope/objectives, Verify/create spec folder, Check existing artifacts, Establish boundaries, Identify key questions]
    deep_analysis:
      focus: comprehensive_research_scoping
      outputs: [feature_summary, research_objectives, investigation_priorities, key_questions, success_criteria]
    validation: understanding_confirmed
    confidence_checkpoint:
      evaluate_at: "After analyzing research request"
      scoring_factors:
        - { factor: "Research scope clarity", weight: 0.40, assess: "Is the question specific and answerable?" }
        - { factor: "Source availability", weight: 0.30, assess: "Are sources identifiable?" }
        - { factor: "Success criteria", weight: 0.30, assess: "Is complete answer defined?" }
      thresholds:
        high_80_plus: { action: "Proceed to Step 2", log: "Confidence: [NN%] - Scope clear" }
        medium_40_79: { action: "Proceed with documented assumptions", log: "Confidence: [NN%] - Noted uncertainties" }
        low_below_40:
          action: "STOP - Clarify research scope"
          format: "Research scope unclear ([NN%]). A) [interpretation] B) [interpretation] C) [interpretation]"
    checkpoint:
      question: "Step 1 Complete: Research scope defined. How would you like to proceed?"
      use: present_options_to_user
      options:
        - { label: "Approve Scope", description: "Research scope is clear, proceed" }
        - { label: "Narrow Focus", description: "Make scope more specific" }
        - { label: "Expand Scope", description: "Broaden research areas" }

  step_2_pre_work_review:
    purpose: Review skills folder and project standards
    activities: [Review AGENTS.md, Check .opencode/skill/ for standards, Extract coding standards, Identify architectural patterns, Document conventions, Note research-relevant constraints]
    required_documents: [AGENTS.md, "Skills folder (if available)"]
    verification: MUST_REVIEW
    validation: principles_established
    checkpoint:
      question: "Step 2 Complete: Skills folder reviewed. How would you like to proceed?"
      use: present_options_to_user
      options: checkpoint_options.standard

  step_3_codebase_investigation:
    purpose: Explore existing codebase for patterns and implementations
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, analysis]
      complexity_boost: 10
      on_parallel_dispatch:
        agents:
          - { name: "pattern_explorer", focus: "Search related code patterns and implementations" }
          - { name: "architecture_analyzer", focus: "Analyze architecture and integration points" }
      fallback: "Proceed with activities if dispatch fails or user chooses direct"
    activities: [Search related code patterns, Analyze existing implementations, Document current architecture, Identify integration points, Map dependencies, Note technical debt]
    outputs: [current_state_analysis, existing_patterns, integration_points, dependency_map]
    validation: codebase_understood
    confidence_checkpoint:
      evaluate_at: "After codebase investigation"
      scoring_factors:
        - { factor: "Pattern clarity", weight: 0.40, assess: "Patterns identified with evidence?" }
        - { factor: "Coverage completeness", weight: 0.35, assess: "All relevant areas explored?" }
        - { factor: "Integration understanding", weight: 0.25, assess: "Integration points mapped?" }
      thresholds:
        high_80_plus: { action: "Proceed to external research", log: "Confidence: [NN%] - Codebase understood" }
        medium_40_79: { action: "Proceed, flag areas needing investigation", log: "Confidence: [NN%] - Some areas need depth" }
        low_below_40: { action: "Expand investigation", format: "Need more exploration in: [areas]" }
    checkpoint:
      question: "Step 3 Complete: Codebase investigated. How would you like to proceed?"
      use: present_options_to_user
      options: checkpoint_options.research_direction

  step_4_external_research:
    purpose: Research external documentation and best practices
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [docs, analysis]
      complexity_boost: 5
      on_parallel_dispatch:
        agents:
          - { name: "documentation_researcher", focus: "Search official docs and API references" }
          - { name: "best_practices_explorer", focus: "Analyze community best practices and alternatives" }
      fallback: "Proceed with activities if dispatch fails or user chooses direct"
    activities: [Search official documentation, Review API references, Analyze community best practices, Identify relevant libraries/tools, Document limitations, Compare alternatives]
    outputs: [best_practices_summary, api_documentation, library_comparison, constraint_documentation]
    validation: external_research_complete
    checkpoint:
      question: "Step 4 Complete: External research done. How would you like to proceed?"
      use: present_options_to_user
      options: checkpoint_options.research_direction

  step_5_technical_analysis:
    purpose: Perform feasibility assessment and technical analysis
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, analysis, testing]
      complexity_boost: 15
      on_parallel_dispatch:
        agents:
          - { name: "feasibility_analyzer", focus: "Evaluate technical feasibility and performance" }
          - { name: "risk_assessor", focus: "Analyze security, scalability, and risks" }
      fallback: "Proceed with activities if dispatch fails or user chooses direct"
    activities: [Evaluate technical feasibility, Assess performance implications, Analyze security, Review scalability, Document trade-offs, Identify risks and mitigations]
    outputs: [technical_specifications, feasibility_assessment, performance_analysis, security_review, risk_assessment]
    validation: technical_analysis_complete
    checkpoint:
      question: "Step 5 Complete: Technical analysis done. Review findings?"
      use: present_options_to_user
      options:
        - { label: "Approve Analysis", description: "Comprehensive, proceed" }
        - { label: "Review Findings", description: "Show detailed findings" }
        - { label: "Investigate More", description: "Dig deeper" }

  step_5_5_checkpoint_analysis:
    purpose: Save context checkpoint after technical analysis complete
    checkpoint: true
    memory_action: save
    activities: [Save checkpoint via system-spec-kit skill, Record progress to analysis milestone, Preserve findings and specifications]
    tool_invocation: { command: 'Read(".opencode/skill/system-spec-kit/SKILL.md")', note: "Intermediate checkpoint - analysis complete" }
    outputs: [{ checkpoint_file: "[SPEC_FOLDER]/memory/checkpoint__analysis_complete.md" }]
    validation: checkpoint_saved

  step_6_quality_checklist:
    purpose: Generate validation checklist for research quality (Level 2+)
    level_requirement: "Level 2+"
    activities: [Check doc level (skip L1, required L2+), Load checklist.md template, Generate research-specific validation items, Include completeness/accuracy/quality checks]
    outputs: [{ quality_checklist: generated }]
    template: .opencode/skill/system-spec-kit/templates/level_2/checklist.md
    validation: checklist_generated
    confidence_checkpoint:
      evaluate_at: "After quality checklist generation"
      scoring_factors:
        - { factor: "Coverage completeness", weight: 0.40, assess: "Covers all research objectives?" }
        - { factor: "Validation quality", weight: 0.35, assess: "Items specific and verifiable?" }
        - { factor: "Priority accuracy", weight: 0.25, assess: "P0/P1/P2 correctly assigned?" }
      thresholds:
        high_80_plus: { action: "Proceed to solution design", log: "Confidence: [NN%] - Checklist comprehensive" }
        medium_40_79: { action: "Proceed, note gaps", log: "Confidence: [NN%] - Checklist has gaps" }
        low_below_40: { action: "Expand checklist before proceeding" }
    checkpoint:
      question: "Step 6 Complete: Quality checklist generated. How would you like to proceed?"
      use: present_options_to_user
      options: checkpoint_options.standard

  step_7_solution_design:
    purpose: Design solution architecture based on research findings
    activities: [Synthesize findings, Design recommended architecture, Define implementation patterns, Create integration approach, Document decision rationale, Outline implementation strategy]
    outputs: [solution_architecture, implementation_patterns, integration_approach, decision_rationale]
    level_3_documents: ["decision-record-[name].md — Level 3 requirement"]
    template: .opencode/skill/system-spec-kit/templates/level_3/decision-record.md
    validation: solution_designed
    checkpoint:
      question: "Step 7 Complete: Solution designed. Review architecture?"
      use: present_options_to_user
      options:
        - { label: "Approve Design", description: "Architecture looks good" }
        - { label: "Review Architecture", description: "Show detailed design" }
        - { label: "Alternative Approach", description: "Explore different architecture" }

  step_8_research_compilation:
    purpose: Compile all research into comprehensive documentation
    activities: [Load research.md, Fill all 17 sections systematically]
    outputs: [{ research.md: comprehensive_technical_documentation }]
    template: .opencode/skill/system-spec-kit/templates/research.md
    research_sections: [metadata, investigation_report, executive_overview, core_architecture, technical_specifications, constraints_limitations, integration_patterns, implementation_guide, code_examples, testing_debugging, performance, security, maintenance, api_reference, troubleshooting, acknowledgements, appendix_changelog]
    validation: research_documented
    checkpoint:
      question: "Step 8 Complete: Research compiled. Review research.md?"
      use: present_options_to_user
      options:
        - { label: "Approve Research", description: "Documentation complete" }
        - { label: "Review Document", description: "Show for detailed review" }
        - { label: "Add Content", description: "Add more to documentation" }

  step_9_save_context:
    purpose: Save conversation context for documentation
    activities: [Invoke system-spec-kit skill, Preserve decisions/rationale/findings/analysis, Index memory file]
    tool_invocation:
      command: 'Read(".opencode/skill/system-spec-kit/SKILL.md")'
      note: 'Load skill for context saving - uses generate-context.js'
      script_path: 'node .opencode/skill/system-spec-kit/scripts/dist/memory/generate-context.js [spec-folder-path]'
      critical_rule: 'NEVER use Write tool directly for memory/ paths - ALWAYS use generate-context.js'
    outputs: [{ context_file: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__research_session.md" }]
    validation: context_saved_successfully
    checkpoint:
      question: "Step 9 Complete: Research workflow finished!"
      use: present_options_to_user
      options:
        - { label: "Done", description: "Complete the workflow" }
        - { label: "View Summary", description: "Show research summary" }
    post_save_indexing:
      mcp_tool: memory_save
      invocation: 'spec_kit_memory_memory_save({ filePath: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__research_session.md" })'
      critical_note: "Call semantic memory MCP DIRECTLY - NEVER through Code Mode"
      when: "Immediately after memory file written to disk"
    anchor_requirements:
      enforcement: MANDATORY
      minimum_anchors: 2
      pattern: "[context-type]-[keywords]-[spec-number]"
      format: "<!-- ANCHOR:ID --> content <!-- /ANCHOR:ID -->"
      required_sections:
        - { context_type: "general", section: "Research summary with key findings", example_id: "GENERAL-RESEARCH-SUMMARY-{spec#}" }
        - { context_type: "decision", section: "Key decisions and recommendations", example_id: "DECISION-{topic}-{spec#}" }
      optional_sections:
        - { context_type: "research", example_id: "RESEARCH-{topic}-{spec#}" }
        - { context_type: "discovery", example_id: "DISCOVERY-{topic}-{spec#}" }
      benefit: "93% token savings on anchor-based retrieval"
    importance_tier:
      assign: important
      rationale: "Research findings inform multiple future decisions"
      tier_reference: "constitutional > critical > important > normal > temporary > deprecated"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 9
  message: "Research phase completed. Workflow terminated after step 9."
  next_steps: [Review research.md, Validate recommendations, "Run /spec_kit:plan or /spec_kit:complete"]

# ─────────────────────────────────────────────────────────────────
# INTERACTIVE EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
interactive_execution:
  principle: "Execute research workflow with user approval at each checkpoint"
  checkpoint_behavior: "Complete step → Present findings → Present options → Wait for response → Proceed or redirect"
  user_feedback_handling: { approve: "Proceed", review: "Show details", modify: "Accept changes, re-execute", skip: "Skip optional step" }

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  research_scope_unclear: "Ask clarifying questions, narrow focus"
  user_redirects_focus: "Acknowledge, adjust scope, document change"
  external_sources_unavailable: "Document limitation, continue with available info"
  conflicting_findings: "Document both perspectives, present options to user"
  technical_dead_end: "Document findings, present alternatives, let user decide"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - follow_workflow_sequence
  - document_all_findings
  - validate_before_completion
  - cite_sources_and_references
  - pause_at_checkpoints_for_approval
  - respect_user_direction
  - allow_research_redirection
  - use_checklist_for_verification_level_2_plus
  - mark_checklist_items_with_evidence
  - complete_all_p0_items_before_done
  - get_user_approval_for_p1_deferrals
  NEVER:
  - skip_workflow_steps
  - make_unsupported_claims
  - proceed_without_user_approval
  - ignore_user_direction
  - submit_incomplete_research
