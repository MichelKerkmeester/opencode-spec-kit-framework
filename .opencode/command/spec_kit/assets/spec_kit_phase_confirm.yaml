# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: PHASE WORKFLOW (INTERACTIVE MODE)
# ─────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for interactive phase decomposition
purpose: Create phased spec folder structures with user approval at each step
action: Analyze scope, confirm decomposition, create parent+child folders with checkpoints

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: sequential_7_step
  compliance: MANDATORY
  execution: interactive
  approvals: step_by_step
  tracking: phase_creation
  validation: checkpoint_based

# ─────────────────────────────────────────────────────────────────
# PHASE PHILOSOPHY
# ─────────────────────────────────────────────────────────────────
phase_philosophy:
  principle: "Decompose before you plan, plan before you build"
  approach: "Structured decomposition with user validation at each decision point"
  mandate: "Detect complexity, propose phases, confirm with user, create folders"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  feature_description: "[FEATURE] - Feature description. REQUIRED."
  phases: "[PHASES] - Number of phases. Default: 3."
  phase_names: "[NAMES] - Comma-separated phase names. Optional (auto-generated if omitted)."
  parent_level: "[LEVEL] - Parent doc level. Default: 3+."

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "Next available spec number from existing folders"
    fallback: "Extract highest NNN from specs/*/ and add 1"
  parent_level_mapping:
    A: "3+"
    B: "3"
    C: "2"
    note: "Map Q3 letter answer to level string before passing to create.sh --level"
  defaults:
    phases_empty: "Default to 3, refine during scope analysis"
    phase_names_empty: "Auto-generate from feature decomposition"
    parent_level_empty: "Default to Level 3+"

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING
# ─────────────────────────────────────────────────────────────────
context_loading:
  trigger: "At workflow START, before Step 1"
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    parameters: { query: "phase decomposition for {feature_description}", anchors: ['summary', 'decisions', 'architecture'] }
  when_to_skip: ["New feature (no prior context)", "User says 'skip context' or 'fresh start'"]
  behavior: { if_found: "Surface relevant prior phase work", if_none: "Proceed to Step 1" }
  checkpoint:
    question: "Prior phase context found. Load it?"
    options:
      - { label: "Yes - Load context", description: "Use prior decisions and state" }
      - { label: "No - Fresh start", description: "Proceed without prior context" }
      - { label: "Review - Show context first", description: "Display context before deciding" }

# ─────────────────────────────────────────────────────────────────
# DOCUMENTATION LEVELS
# ─────────────────────────────────────────────────────────────────
documentation_levels:
  parent_default: "level_3_plus"
  child_default: "level_1"
  note: "Parent holds Phase Documentation Map at L3+; children start at L1, escalated during /spec_kit:plan"

# ─────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ─────────────────────────────────────────────────────────────────
available_templates:
  parent_spec: .opencode/skill/system-spec-kit/templates/level_3+/spec.md
  child_spec: .opencode/skill/system-spec-kit/templates/level_1/spec.md
  phase_parent_section: .opencode/skill/system-spec-kit/templates/addendum/phase/phase-parent-section.md
  phase_child_header: .opencode/skill/system-spec-kit/templates/addendum/phase/phase-child-header.md

# ─────────────────────────────────────────────────────────────────
# CHECKPOINT OPTIONS
# ─────────────────────────────────────────────────────────────────
checkpoint_options:
  standard:
    - { label: "Approve", description: "Approve and proceed to next step" }
    - { label: "Review Details", description: "Show more details before deciding" }
    - { label: "Modify", description: "Request changes to this step" }
    - { label: "Skip", description: "Skip this step (if optional)" }

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with phase decomposition" }
    medium: { range: "40-79%", action: "Proceed with caution, surface at checkpoint" }
    low: { range: "0-39%", action: "STOP - Ask clarification with A/B/C options" }
  scoring_weights: { scope_clarity: 0.30, decomposition_logic: 0.30, boundary_definition: 0.20, dependency_awareness: 0.20 }
  reply_format: ["Confidence: NN%", "Phase rationale: 2-3 bullets", "Next action"]
  escalation: { timebox_minutes: 10, failed_threshold: 2 }
  interactive_integration: "Confidence checks surfaced at user checkpoints"

# ─────────────────────────────────────────────────────────────────
# QUALITY GATES
# ─────────────────────────────────────────────────────────────────
quality_gates:
  enabled: true
  pre_execution:
    location: "Before Step 1"
    threshold: 70
    blocking: hard
    checks:
      - { id: feature_description_clear, points: 40 }
      - { id: phase_count_reasonable, points: 30 }
      - { id: execution_mode_set, points: 30 }
    on_fail: "Pre-execution gate below threshold. Missing: {missing_checks}."
  post_execution:
    location: "After Step 7"
    threshold: 70
    blocking: hard
    checks:
      - { id: parent_folder_exists, points: 25 }
      - { id: child_folders_exist, points: 25 }
      - { id: parent_spec_has_phase_map, points: 20 }
      - { id: children_have_back_refs, points: 15 }
      - { id: context_saved, points: 15 }
    on_fail: "Post-execution gate below threshold. Missing: {missing_checks}."

# ─────────────────────────────────────────────────────────────────
# CIRCUIT BREAKER
# ─────────────────────────────────────────────────────────────────
circuit_breaker:
  enabled: true
  thresholds: { failures: 3, recovery_s: 60, success_to_close: 1 }
  states: { CLOSED: normal_operation, OPEN: workflow_halted, HALF_OPEN: single_retry }
  tracked_errors: [folder_creation, file_write, memory_save]

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_analyze_scope:
    purpose: Evaluate task complexity and recommend phase decomposition
    activities:
      - "Run recommend-level.sh --json --recommend-phases with estimated LOC, files, and domain flags"
      - Parse phase recommendation from JSON output
      - Extract suggested_phase_count, phase_score, phase_reason
      - "If phases not recommended (score < threshold): present finding to user"
      - Validate feature description is actionable
    tool_invocation:
      command: "bash .opencode/skill/system-spec-kit/scripts/spec/recommend-level.sh --json --recommend-phases --loc {estimated_loc} --files {estimated_files}"
      note: "Add --architectural, --api, --db flags based on feature description analysis"
    outputs: { phase_recommendation: "true|false", suggested_count: number, phase_score: number, phase_reason: string }
    confidence_checkpoint:
      evaluate_at: "After scope analysis"
      scoring_factors:
        - { factor: "Scope clarity", weight: 0.40, assess: "Feature boundaries well-defined?" }
        - { factor: "Decomposition rationale", weight: 0.35, assess: "Clear reason for phasing?" }
        - { factor: "Phase count appropriateness", weight: 0.25, assess: "Not too few, not too many?" }
      thresholds:
        high_80_plus: { action: "Present results at checkpoint", log: "Confidence: [NN%] - Scope clear" }
        medium_40_79: { action: "Present with caveats at checkpoint", log: "Confidence: [NN%] - Some scope ambiguity" }
        low_below_40:
          action: "STOP - Ask clarification at checkpoint"
          format: '"Scope unclear (confidence: [NN%]). A) [interpretation] B) [interpretation] C) [interpretation]"'
          wait_for: "User response"
    validation: scope_analyzed
    checkpoint:
      question: "Step 1 Complete: Scope analyzed. Phase recommendation: {phase_recommendation}. Suggested phases: {suggested_count}. Proceed?"
      options:
        - { label: "Approve", description: "Accept scope analysis and proceed" }
        - { label: "Adjust Phase Count", description: "Change the number of phases" }
        - { label: "Review Scoring", description: "Show detailed scoring breakdown" }
        - { label: "Cancel", description: "Abort phase decomposition" }

  step_2_decomposition_proposal:
    purpose: Define phase structure with clear boundaries and dependencies
    activities:
      - "Generate phase names (from --phase-names argument or auto-generate from scope analysis)"
      - Define scope boundaries per phase (what each phase delivers)
      - Map dependencies between phases (which phases must complete before others)
      - Define deliverables per phase (files, components, capabilities)
      - "Set default child level (L1, escalated during /spec_kit:plan)"
      - Present decomposition proposal for user review
    outputs: { phase_plan: { count: number, names: list, boundaries: map, dependencies: map, deliverables: map } }
    validation: decomposition_defined
    checkpoint:
      question: "Step 2 Complete: Phase decomposition proposed. Review the breakdown?"
      display_before_question: |
        Proposed Phases:
        {phase_table}

        Dependencies:
        {dependency_map}
      options:
        - { label: "Approve Decomposition", description: "Phase structure looks good, create folders" }
        - { label: "Modify Phases", description: "Change phase names, boundaries, or count" }
        - { label: "Review Details", description: "Show detailed scope per phase" }
        - { label: "Start Over", description: "Re-analyze with different parameters" }

  step_3_create_folders:
    purpose: Create parent and child phase folders using create.sh
    activities:
      - "Run create.sh with --phase --phases N --phase-names \"name1,name2,...\" --level L"
      - Verify parent folder created with correct structure
      - Verify all N child folders created with NNN- prefix numbering
      - Verify template files present in parent and all children
    tool_invocation:
      command: "bash .opencode/skill/system-spec-kit/scripts/spec/create.sh \"{feature_description}\" --phase --phases {phase_count} --phase-names \"{phase_names}\" --level {parent_level}"
      command_with_parent: "bash .opencode/skill/system-spec-kit/scripts/spec/create.sh \"{feature_description}\" --phase --phases {phase_count} --phase-names \"{phase_names}\" --level {parent_level} --parent \"{parent_spec}\""
      note: "Use command_with_parent when --parent flag was provided (adding phases to existing spec). create.sh handles folder creation, template copying, and basic structure."
    outputs: { parent_folder: path, child_folders: list_of_paths }
    validation: folders_created
    checkpoint:
      question: "Step 3 Complete: Folders created. Verify structure?"
      display_before_question: |
        Created:
        {folder_tree}
      options:
        - { label: "Approve Structure", description: "Folder structure is correct" }
        - { label: "Review Files", description: "Show contents of created folders" }
        - { label: "Recreate", description: "Delete and recreate with changes" }

  step_4_populate_parent:
    purpose: Fill parent spec.md with Phase Documentation Map
    activities:
      - Load phase-parent-section.md addendum template
      - Fill Phase Documentation Map table with phase details (name, scope, status, dependencies)
      - Add scope descriptions per phase
      - Set dependency mappings between phases
      - Set handoff criteria (what must be true before next phase starts)
      - Update parent spec.md Executive Summary to reference phased approach
    outputs: { parent_spec_updated: true }
    validation: parent_populated
    checkpoint:
      question: "Step 4 Complete: Parent spec populated with Phase Documentation Map. Review?"
      options:
        - { label: "Approve", description: "Parent spec looks correct" }
        - { label: "Review Parent Spec", description: "Show parent spec.md content" }
        - { label: "Modify", description: "Request changes to Phase Documentation Map" }

  step_5_populate_children:
    purpose: Fill child phase specs with scope boundaries and parent back-references
    activities:
      - Load phase-child-header.md addendum template
      - "For each child phase folder:"
      - "  - Inject parent back-reference metadata (Parent Spec, Parent Plan paths)"
      - "  - Set phase scope boundary (in-scope / out-of-scope for THIS phase)"
      - "  - Set predecessor phase link (or 'None' for first phase)"
      - "  - Set successor phase link (or 'None' for last phase)"
      - "  - Define phase deliverables"
      - "  - Set handoff criteria from/to adjacent phases"
    outputs: { child_specs_updated: true, children_count: number }
    validation: children_populated
    checkpoint:
      question: "Step 5 Complete: All {children_count} child phases populated. Review?"
      options:
        - { label: "Approve All", description: "All child specs look correct" }
        - { label: "Review Each", description: "Show each child spec for individual review" }
        - { label: "Modify", description: "Request changes to specific child phases" }

  step_6_save_context:
    purpose: Save conversation context for phase decomposition
    activities:
      - "Run generate-context.js for parent spec folder"
      - Preserve decomposition decisions and phase boundaries
      - Preserve dependency mappings
      - Index memory file
    tool_invocation:
      command: "node .opencode/skill/system-spec-kit/scripts/dist/memory/generate-context.js {parent_spec_path}"
      note: "ALWAYS use generate-context.js script - NEVER manually create memory files"
    outputs: { memory_file: path }
    validation: context_saved
    checkpoint:
      question: "Step 6 Complete: Context saved. Proceed to next steps?"
      options:
        - { label: "Done", description: "Complete the phase workflow" }
        - { label: "View Memory", description: "Show saved context file" }
    anchor_requirements:
      enforcement: MANDATORY
      minimum_anchors: 2
      required_sections:
        - { context_type: "general", section: "Phase decomposition summary", example_id: "GENERAL-PHASE-DECOMPOSITION-{spec#}" }
        - { context_type: "decision", section: "Phase boundary decisions", example_id: "DECISION-PHASE-BOUNDARIES-{spec#}" }

  step_7_next_steps:
    purpose: Present created structure and continuation options
    activities:
      - Display created folder structure (tree view)
      - Show Phase Documentation Map summary
      - "Suggest /spec_kit:plan for first child phase"
      - "Suggest sequential planning for all phases"
      - "Suggest /spec_kit:implement after planning completes"
    display_format: |
      Phase Decomposition Complete:
      Parent: {parent_folder}
      Phases:
        {child_1} - {scope_1}
        {child_2} - {scope_2}
        ...

      Recommended next steps:
      1. /spec_kit:plan {child_1_path}  (plan first phase)
      2. /spec_kit:plan {child_2_path}  (plan second phase)
      ...
      N. /spec_kit:implement {child_1_path}  (after planning)
    outputs: { next_steps_presented: true }
    validation: workflow_complete
    checkpoint:
      question: "Phase decomposition complete. What would you like to do next?"
      options:
        - { label: "Plan First Phase", description: "Run /spec_kit:plan for phase 001" }
        - { label: "Review Structure", description: "Re-examine the created structure" }
        - { label: "Done", description: "End phase decomposition workflow" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 7
  message: "Phase decomposition complete. Folder structure created and populated."
  next_steps:
    - "/spec_kit:plan for each child phase (sequential)"
    - "/spec_kit:implement after planning completes"
    - "/spec_kit:resume to continue from any phase"
  enforcement: |
    CRITICAL: Phase decomposition creates STRUCTURE only. Detailed planning and
    implementation require separate commands per child phase:
    1. /spec_kit:plan specs/NNN-name/001-phase/ (per child)
    2. /spec_kit:implement specs/NNN-name/001-phase/ (per child, after planning)
    Do NOT begin planning or implementation from this workflow.

# ─────────────────────────────────────────────────────────────────
# INTERACTIVE EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
interactive_execution:
  principle: "Execute phase decomposition with user approval at each checkpoint"
  checkpoint_behavior:
    - Complete step activities
    - Present results summary
    - Present options for approval
    - Wait for user response
    - Process feedback
    - Proceed or modify as directed
  user_feedback_handling:
    approve: "Proceed to next step"
    review: "Show detailed output for the step"
    modify: "Accept changes and re-execute step"
    skip: "Skip optional step"
    cancel: "Abort workflow gracefully"
    start_over: "Return to Step 1 with new parameters"

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  create_sh_fails: "Present error to user, suggest fix, offer retry"
  folder_already_exists: "Report conflict, ask user to choose: overwrite, rename, or cancel"
  recommend_level_unavailable: "Inform user, skip scoring, use provided phase count"
  template_missing: "Warn user, offer to create minimal structure manually"
  memory_save_fails: { action: "Inform user, offer manual save option", fallback: "Suggest /memory:save" }
  user_cancels: "Acknowledge cancellation, clean up any partially created folders, exit gracefully"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
    - follow_workflow_sequence
    - create_parent_before_children
    - link_children_to_parent
    - link_phases_to_each_other
    - save_context_after_creation
    - present_next_steps
    - pause_at_checkpoints_for_approval
    - respect_user_feedback
  NEVER:
    - skip_workflow_steps
    - proceed_to_planning_or_implementation
    - create_children_without_parent
    - leave_unlinked_phase_folders
    - manually_create_memory_files
    - proceed_without_user_approval
    - ignore_user_modification_requests
    - ignore_user_cancellation
