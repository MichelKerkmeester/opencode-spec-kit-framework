# ─────────────────────────────────────────────────────────────────
# SMART SPECKIT: IMPLEMENT WORKFLOW (INTERACTIVE MODE)
# ─────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for interactive implementation
purpose: Spec-driven implementation with step-by-step user approval
action: Execute from task breakdown to completion with user checkpoints

# ─────────────────────────────────────────────────────────────────
# OPERATING MODE
# ─────────────────────────────────────────────────────────────────
operating_mode:
  workflow: sequential
  compliance: MANDATORY
  execution: interactive
  approvals: step_by_step
  tracking: progressive_task_checklists
  validation: checkpoint_based

# ─────────────────────────────────────────────────────────────────
# GATE 3 COMPLIANCE
# ─────────────────────────────────────────────────────────────────
gate_3_compliance:
  status: ENFORCED_VIA_PHASES
  mechanism: "Phase 1-3 blocking gates in implement.md"
  standard_question: "Spec Folder (required): A) Existing | B) New | C) Update related | D) Skip | E) Phase folder"
  first_message_protocol: "If FIRST message requests implementation, ask spec folder FIRST"
  failure_pattern_19:
    triggers: ["comprehensive", "fix all", "15 agents", "implement everything"]
    action: "STOP → Ask spec folder question → Wait for A/B/C/D/E"
  self_verification: |
    □ File modification detected? Did I ask spec folder question?
    □ Did I wait for user's A/B/C/D/E response before using project tools?

implementation_philosophy:
  principle: "Correctness first, elegance second"
  approach: "Systematic execution with user validation at checkpoints"
  mandate: "Build incrementally, review with user, deliver confidently"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS
# ─────────────────────────────────────────────────────────────────
user_inputs:
  spec_folder: "[SPEC_FOLDER] - Spec folder path. REQUIRED for implement workflow."
  context: "[CONTEXT] - Background info, constraints, existing docs."
  issues: "[ISSUES] - Known issues or concerns."
  request: "[REQUEST] - Implementation scope. Default: comprehensive review."
  environment: "[STAGING LINK] - Staging/production URL for browser testing."
  scope: "[FILES] - Files/folders to work with."

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "specs/{NNN}, specs/{NNN-name}, or specs/{NNN-parent}/{NNN-phase} (phase child — use parent NNN as spec_id)"
    fallback: "numeric portion or timestamp"
  defaults: { spec_folder_empty: "REQUIRED", context_empty: "Infer from REQUEST + codebase", issues_empty: "Use planning phase issues", environment_empty: "Skip browser testing", scope_empty: "specs/**" }
  phase_folder_awareness:
    note: "[SPEC_FOLDER] may be a phase child path (e.g., specs/003-name/001-phase/). When Option E is selected or --phase-folder is provided, spec_id derives from the parent folder NNN, not the child NNN. Also load parent spec.md for cross-reference context."
    path_pattern: "specs/{NNN-parent}/{NNN-phase}/"
  scope_policy: { default: "specs/**", rule: "Limit file operations to scope when provided" }

# ─────────────────────────────────────────────────────────────────
# REQUEST HANDLING
# ─────────────────────────────────────────────────────────────────
request_handling:
  default: "Conduct a comprehensive review of the spec folder and carry out its implementation with user approval at each step."
  override: "Use [REQUEST] if provided, else use default above"

# ─────────────────────────────────────────────────────────────────
# DOCUMENTATION LEVELS
# ─────────────────────────────────────────────────────────────────
documentation_levels:
  level_1_baseline:
    name: "Level 1 (Baseline)"
    required_files: [spec.md, plan.md, tasks.md]
    loc_guidance: "<100"
    use_case: "Simple changes, bug fixes"
  level_2_verification:
    name: "Level 2 (Verification)"
    required_files: [spec.md, plan.md, tasks.md, checklist.md]
    loc_guidance: "100-499"
    use_case: "Medium features, refactoring"
  level_3_full:
    name: "Level 3 (Full)"
    required_files: [spec.md, plan.md, tasks.md, checklist.md, decision-record.md]
    loc_guidance: ">=500"
    use_case: "Complex features, architecture changes"
  level_selection:
    note: "LOC thresholds are SOFT GUIDANCE - choose level based on complexity and risk"
    default: "Level 1 for simple tasks, escalate based on analysis"

# ─────────────────────────────────────────────────────────────────
# PREREQUISITES
# ─────────────────────────────────────────────────────────────────
prerequisites:
  level_1_required: ["[SPEC_FOLDER]/spec.md", "[SPEC_FOLDER]/plan.md", "[SPEC_FOLDER]/tasks.md"]
  level_2_required: ["[SPEC_FOLDER]/checklist.md"]
  level_3_required: ["[SPEC_FOLDER]/decision-record.md"]
  optional_artifacts: ["[SPEC_FOLDER]/research.md"]
  verification: MUST EXIST BEFORE PROCEEDING
  note: This workflow assumes planning completed via /spec_kit:plan

# ─────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ─────────────────────────────────────────────────────────────────
available_templates:
  default_level: level_2
  level_1:
    tasks: .opencode/skill/system-spec-kit/templates/level_1/tasks.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_1/implementation-summary.md
  level_2:
    tasks: .opencode/skill/system-spec-kit/templates/level_2/tasks.md
    checklist: .opencode/skill/system-spec-kit/templates/level_2/checklist.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_2/implementation-summary.md
  level_3:
    tasks: .opencode/skill/system-spec-kit/templates/level_3/tasks.md
    checklist: .opencode/skill/system-spec-kit/templates/level_3/checklist.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_3/implementation-summary.md
  level_3_plus:
    tasks: .opencode/skill/system-spec-kit/templates/level_3+/tasks.md
    checklist: .opencode/skill/system-spec-kit/templates/level_3+/checklist.md
    implementation_summary: .opencode/skill/system-spec-kit/templates/level_3+/implementation-summary.md
  shared:
    handover: .opencode/skill/system-spec-kit/templates/handover.md
    debug_delegation: .opencode/skill/system-spec-kit/templates/debug-delegation.md

# ─────────────────────────────────────────────────────────────────
# PARALLEL DISPATCH CONFIGURATION
# ─────────────────────────────────────────────────────────────────
parallel_dispatch_config:
  enabled: true
  scoring: { domain_count: 0.35, file_count: 0.25, loc_estimate: 0.15, parallel_opportunity: 0.20, task_type: 0.05 }
  thresholds: { direct_max: 20, ask_min: 20, min_domains: 2 }
  session_preference_s: 3600
  override_phrases:
    direct: [ "proceed directly", "handle directly", "skip parallel", "skip agents" ]
    parallel: [ "use parallel", "dispatch agents", "parallelize", "use agents" ]
    auto: [ "auto-decide", "auto mode", "decide for me" ]
  eligible_phases: [step_6_development]

# ─────────────────────────────────────────────────────────────────
# MULTI-AGENT DISPATCH CONFIGURATION
# ─────────────────────────────────────────────────────────────────
multi_agent_config:
  enabled: true
  dispatch_modes:
    single: { id: A, label: "Single Agent", agents: 1, model: opus }
    multi_small:
      id: B
      label: "Multi-Agent (1+2)"
      orchestrator: { model: opus, role: coordinator }
      workers:
        - { role: implementation_agent, focus: "Core Implementation", step: 6 }
        - { role: test_agent, focus: "Test Implementation", step: 6 }
    multi_large:
      id: C
      label: "Multi-Agent (1+3)"
      orchestrator: { model: opus, role: coordinator }
      workers:
        - { role: implementation_agent, focus: "Core Implementation", step: 6 }
        - { role: test_agent, focus: "Test Implementation", step: 6 }
        - { role: integration_agent, focus: "Integration and Polish", step: 6 }
  fallback: { timeout_s: 60, on_timeout: "continue with available", on_all_fail: "single-agent mode" }

# ─── AGENT AVAILABILITY (conditional — not instructions) ──────────
# These entries define WHICH agent to use IF a workflow step calls for it.
# Do NOT dispatch agents based on reading this section.
# Agents are activated ONLY when their designated step is executing.
agent_availability:
  review:
    available_at_step: 7
    condition: "ONLY dispatch when Step 7 is actively executing and all prior steps are completed"
    agent_file: "[runtime_agent_path]/review.md"
    standards_contract:
      baseline: "sk-code--review"
      overlay: "Auto-detect one overlay: sk-code--opencode | sk-code--web | sk-code--full-stack"
      precedence: "Overlay style/process/build/test conventions override generic baseline guidance; baseline security/correctness minimums remain mandatory."
    fallback: "general"
    blocking: true
    on_block: "P0 items incomplete. Address before completion."
    dual_phase:
      phase_a: { mode: 2, name: "Pre-Commit code review (sk-code--review + overlay)", blocking: false }
      phase_b: { mode: 4, name: "Gate Validation", blocking: true }
    not_for: "reviewing this workflow prompt, reviewing the command, or any pre-step validation"
  debug:
    available_at_step: 6
    condition: "ONLY dispatch when failure_count >= 3 during Step 6 development"
    agent_file: "[runtime_agent_path]/debug.md"
    fallback: "general-purpose"
    failure_tracking: { counter: "task_failure_count", reset_on: "new_task", threshold: 3 }
    on_threshold: "Suggest: A) Dispatch debug B) Continue manually C) Skip task D) Pause"
    not_for: "proactive debugging, pre-step investigation, or reviewing this workflow"
  handover:
    available_at_step: 9
    condition: "ONLY dispatch when user explicitly requests handover at Step 9"
    agent_file: "[runtime_agent_path]/handover.md"
    fallback: "general"
    not_for: "automatic handover, pre-step context saving, or premature session ending"

# ─────────────────────────────────────────────────────────────────
# QUALITY GATES
# ─────────────────────────────────────────────────────────────────
quality_gates:
  enabled: true
  pre_implementation:
    location: "Before Step 6"
    threshold: 70
    blocking: hard
    checks:
      - { id: prerequisites_complete, points: 30 }
      - { id: plan_clarity, points: 25 }
      - { id: task_breakdown_quality, points: 25 }
      - { id: checklist_verified, points: 20 }
    on_fail: "PRE-IMPLEMENTATION GATE FAILED ({score}/100). Fix issues before coding."
  post_implementation:
    location: "After Step 7"
    threshold: 70
    blocking: hard
    checks:
      - { id: all_tasks_complete, points: 30 }
      - { id: tests_pass, points: 25 }
      - { id: summary_exists, points: 25 }
      - { id: checklist_verified, points: 20 }
    on_fail: "POST-IMPLEMENTATION GATE FAILED ({score}/100). Fix blocking issues."

# ─────────────────────────────────────────────────────────────────
# CIRCUIT BREAKER
# ─────────────────────────────────────────────────────────────────
circuit_breaker:
  enabled: true
  thresholds: { failures: 3, recovery_s: 60, success_to_close: 1 }
  states: { CLOSED: normal_operation, OPEN: skip_affected_step, HALF_OPEN: test_single }
  step_overrides: { step_7: "critical - must complete or fail explicitly" }

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with cited evidence" }
    medium: { range: "40-79%", action: "Proceed with caution, document assumptions" }
    low: { range: "0-39%", action: "STOP - Ask A/B/C clarification" }
  scoring_weights: { pattern_alignment: 0.30, side_effect_awareness: 0.25, implementation_clarity: 0.25, test_coverage: 0.20 }
  reply_format: ["Confidence: NN%", "Top factors: 2-3 bullets", "Next action"]
  escalation: { timebox_minutes: 10, failed_threshold: 2 }
  interactive_integration: "Confidence checks surfaced at user checkpoints"

# ─────────────────────────────────────────────────────────────────
# REQUEST ANALYSIS FRAMEWORK
# ─────────────────────────────────────────────────────────────────
request_analysis_framework:
  pre_implementation_validation: [plan_understood, tasks_clear, patterns_identified, confidence_80_plus, scope_bounded]
  citation_requirement: "Reference task ID in commits, cite pattern sources, use [DEVIATION: reason] for plan departures"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT
# ─────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false
  prerequisites_gate:
    location: "Before Step 1"
    requirements: ["spec.md exists in SPEC_FOLDER", "plan.md exists in SPEC_FOLDER"]
    action_if_failed: "STOP - run /spec_kit:plan first"
  step_completion_rule: "Execute ALL activities → Verify ALL outputs → Present checkpoint for approval → Mark step complete after approval → THEN proceed. NEVER skip steps, NEVER proceed without user approval, NEVER jump to coding before Step 5."
  critical_steps:
    step_6: { enforcement: "MUST mark tasks [x] in tasks.md", verification: "Count [x] vs [ ] — all must be [x]" }
    step_7: { enforcement: "MUST create implementation-summary.md", verification: "File must exist in spec folder" }

checkpoint_options:
  standard:
    - { label: "Approve", description: "Approve and proceed to next step" }
    - { label: "Review Details", description: "Show more details" }
    - { label: "Modify", description: "Request changes before proceeding" }
    - { label: "Skip", description: "Skip this step (if optional)" }
  code_review:
    - { label: "Approve Code", description: "Code looks good, proceed" }
    - { label: "Show Diff", description: "Show code changes in detail" }
    - { label: "Request Changes", description: "Request modifications" }
    - { label: "Run Tests", description: "Execute test suite first" }

# ─────────────────────────────────────────────────────────────────
# CONTEXT LOADING
# ─────────────────────────────────────────────────────────────────
context_loading:
  trigger: "At workflow START, before Step 1"
  purpose: "Load prior context from planning phase"
  mcp_integration:
    tool: memory_search
    note: "Call MCP tools directly - NEVER through Code Mode"
    parameters: { query: "planning context for {spec_folder_name}", specFolder: "{spec_folder_path}", anchors: [summary, decisions, state, implementation] }
  command_reference: "/memory:context"
  when_to_skip: ["User says 'skip context' or 'fresh start'"]
  behavior:
    if_context_found: "Present planning context to user for confirmation"
    if_no_context: "Proceed to Step 1 — rely on spec.md and plan.md"
  checkpoint:
    question: "Prior planning context found. Load this context?"
    options:
      - { label: "Yes - Load context", description: "Use planning decisions and prior state" }
      - { label: "No - Use artifacts only", description: "Proceed with spec.md and plan.md only" }
      - { label: "Review - Show context first", description: "Display context before deciding" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_review_plan_and_spec:
    purpose: Review spec and planning artifacts
    activities:
    - Run check-prerequisites.sh --json --require-tasks
    - Verify spec.md and plan.md exist
    - Load and review all planning artifacts
    - Understand requirements, analyze approach, identify dependencies, note constraints
    required_documents: ["[SPEC_FOLDER]/spec.md", "[SPEC_FOLDER]/plan.md"]
    optional_documents: [research.md, "decision-record-*.md"]
    validation: planning_artifacts_understood
    checkpoint:
      question: "Step 1 Complete: Plan and spec reviewed. How would you like to proceed?"
      options:
        - { label: "Proceed", description: "Plan is clear, proceed to task breakdown" }
        - { label: "Review Plan", description: "Show plan.md for detailed review" }
        - { label: "Review Spec", description: "Show spec.md for reference" }

  step_2_task_breakdown:
    purpose: Create or validate tasks.md (Level 1+ requirement)
    activities:
    - Load plan.md for tech stack and architecture
    - Load spec.md for user stories and priorities
    - Generate tasks organized by user story with dependency graph
    - Mark parallel-executable tasks with [P], define phases, generate estimates
    - Create/validate tasks.md
    outputs: [tasks.md]
    template: .opencode/skill/system-spec-kit/templates/level_2/tasks.md
    validation: tasks_documented
    checkpoint:
      question: "Step 2 Complete: Tasks defined. Review tasks.md?"
      options:
        - { label: "Approve Tasks", description: "Task breakdown looks good" }
        - { label: "Review Tasks", description: "Show tasks.md for review" }
        - { label: "Modify Tasks", description: "Request changes to task breakdown" }

  step_3_analysis:
    purpose: Verify consistency across all artifacts
    activities: [Build requirements inventory, Build task coverage mapping, Run consistency checks, Generate gap analysis]
    outputs: [consistency_report, coverage_verification]
    validation: consistency_verified
    checkpoint:
      question: "Step 3 Complete: Consistency verified. How would you like to proceed?"
      options: checkpoint_options.standard

  step_4_quality_checklist:
    purpose: Validate checklists AND USE THEM FOR VERIFICATION (Level 2+)
    activities:
    - Skip for Level 1, MANDATORY for Level 2+
    - Load and parse checklist.md items with priorities (P0/P1/P2)
    - "FOR EACH ITEM: verify condition, mark [x] with evidence, document blockers/deferrals"
    - Ensure ALL P0 complete (HARD BLOCKER), ALL P1 complete or approved deferral
    - Update checklist.md with verification marks
    verification_protocol: { p0: "BLOCKER", p1: "Required or user-approved deferral", p2: "Optional, can defer with reason" }
    outputs: { checklist_status: pass_or_fail, p0_status: "all_complete or blocked" }
    validation: checklist_verified_and_marked
    checkpoint:
      question: "Step 4 Complete: Checklists verified. Ready to implement?"
      options:
        - { label: "Start Implementation", description: "Begin development phase" }
        - { label: "Review Verification", description: "Show checklist verification details" }
        - { label: "Address Blockers", description: "Fix P0/P1 blockers first" }

  step_5_implementation_check:
    purpose: Verify all prerequisites for implementation
    activities: [Verify environment ready, Check API endpoints, Verify dependencies, Confirm no blockers]
    checks: { prerequisites: verified, blockers: none, environment: ready }
    validation: prerequisites_verified
    checkpoint:
      question: "Step 5 Complete: Environment ready. Proceed with development?"
      options:
        - { label: "Start Coding", description: "Begin implementation" }
        - { label: "Check Environment", description: "Show environment status" }
        - { label: "Hold", description: "Wait before proceeding" }

  step_5_5_preflight:
    purpose: Capture epistemic baseline for learning measurement
    optional: true
    skip_if: ["Quick fix (<10 LOC)", "Continuation with existing PREFLIGHT"]
    activities: [Capture knowledge level, Record codebase understanding, Document uncertainty, Establish context quality baseline]
    scores:
      knowledge: { range: "0-10", default: 5 }
      uncertainty: { range: "0-10", default: 5 }
      context: { range: "0-10", default: 5 }
    output_format: |
      ## PREFLIGHT Baseline - [timestamp]
      ### Epistemic State
      - Knowledge: [0-10] - [explanation]
      - Uncertainty: [0-10] - [what's unclear]
      - Context: [0-10] - [context quality]
      ### Focus Areas
      - [area 1] / [area 2]
    validation: preflight_captured
    checkpoint:
      question: "Step 5.5: PREFLIGHT baseline captured. Proceed to development?"
      options:
        - { label: "Proceed", description: "Start development phase" }
        - { label: "Adjust Baseline", description: "Modify PREFLIGHT values" }
        - { label: "Skip", description: "Skip PREFLIGHT (not recommended)" }

  step_6_development:
    purpose: Execute implementation following task plan
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, testing]
      complexity_boost: 15
      decision_logic: "Check override phrases → session preference → sequential deps → calculate complexity → <20% direct, >=20%+2 domains → ask user"
      on_parallel_dispatch:
        agents:
          - { name: "implementation_agent", focus: "Core implementation tasks from tasks.md" }
          - { name: "test_agent", focus: "Test implementation and validation" }
        dispatch_note: "Spawn agents in SINGLE message for parallel execution"
        warning: "Development tasks may have dependencies - verify task order"
      fallback: "Proceed with activities below if dispatch fails or user chooses direct"
    activities:
    - Parse tasks.md, execute phase by phase
    - Setup first (structure, dependencies, config)
    - Follow TDD where applicable
    - Core development (models, services, endpoints)
    - Integration (database, middleware, logging)
    - Update task checklist progressively (mark [X])
    - Log progress after each task
    debug_delegation:
      trigger: "Same error 3+ times after fix attempts"
      enforcement: MANDATORY
      action: "STOP → suggest /spec_kit:debug → wait for user decision"
    approach: incremental_implementation_with_reviews
    requirements: { follow: "Check skills folder for coding standards", update: task_checklist_progressively, test: before_commit, validate: continuously }
    confidence_checkpoint:
      evaluate_at: "Before each significant code change"
      per_task_assessment:
        scoring_factors:
          - { factor: "Implementation clarity", weight: 0.35 }
          - { factor: "Pattern alignment", weight: 0.30 }
          - { factor: "Risk awareness", weight: 0.35 }
        thresholds:
          high_80_plus: "Implement task, mark [x]"
          medium_40_79: "Implement with extra validation, add comments"
          low_below_40: "STOP — A) Research B) Simplify C) Skip"
      citation_requirement: "Reference task ID in commits, cite pattern sources, use [DEVIATION: reason]"
    validation: development_complete
    checkpoint:
      question: "Step 6 Complete: Development finished. Review implementation?"
      options: checkpoint_options.code_review

  step_6_5_checkpoint_development:
    purpose: Save context checkpoint after development phase
    checkpoint: true
    memory_action: save
    activities: [Save checkpoint via system-spec-kit skill, Record development milestone, Preserve decisions/changes/insights]
    tool_invocation:
      command: Read(".opencode/skill/system-spec-kit/SKILL.md")
      note: "Intermediate checkpoint - development phase complete"
    outputs: ["[SPEC_FOLDER]/memory/checkpoint__development_complete.md"]
    validation: checkpoint_saved

  step_7_completion:
    purpose: Generate implementation summary
    level_requirement: "Level 2+ (MANDATORY - do not skip)"
    enforcement_note: "MANDATORY for Level 2+. implementation-summary.md is a required file. Strongly recommended for Level 1."
    activities: [Run validation on spec folder, Verify all tasks completed, Validate tests pass, Confirm plan followed, Generate implementation-summary.md, Update all task status]
    pre_completion_validation:
      enforcement: MANDATORY
      outcomes: { pass: "continue", warnings: "continue with caution", errors: "STOP and fix" }
    summary_document:
      location: "[SPEC_FOLDER]/implementation-summary.md"
      required_sections: [files_modified_created, verification_steps_taken, deviations_from_plan, skill_updates, recommended_next_steps, browser_testing_results]
    verification_summary:
      checklist_verification:
        required: true
        must_include: [Total items verified, P0 status (all complete), P1 status (complete or deferred), Deferred P2 with reasons, Link to checklist.md]
    validation: implementation_complete
    completion_checkpoint:
      enforcement: HARD_BLOCK
      before_marking_complete: "Verify implementation-summary.md exists with all required sections. If missing, CREATE before proceeding."
      required_file: "[SPEC_FOLDER]/implementation-summary.md"
    checkpoint:
      question: "Step 7 Complete: Implementation summary generated. Review?"
      options:
        - { label: "Approve Summary", description: "Summary is complete" }
        - { label: "View Summary", description: "Show implementation-summary.md" }
        - { label: "Add Details", description: "Add more to summary" }

  step_7_5_postflight:
    purpose: Capture learning delta and calculate improvement
    optional: true
    skip_if: ["Quick fix (<10 LOC)", "No PREFLIGHT captured"]
    activities: [Capture post-implementation knowledge, Record new understanding, Document reduced uncertainty, Calculate learning index]
    scores:
      knowledge: { range: "0-10", default: 7 }
      uncertainty: { range: "0-10", default: 3 }
      context: { range: "0-10", default: 8 }
    learning_index_calculation: "Knowledge Delta + Uncertainty Reduction + Context Improvement / 3"
    output_format: |
      ## POSTFLIGHT Delta - [timestamp]
      ### Epistemic State (Final)
      - Knowledge: [0-10] - [learned]
      - Uncertainty: [0-10] - [clarified]
      - Context: [0-10] - [improved]
      ### Learning Index
      - Knowledge/Uncertainty/Context Deltas → **Learning Index: [X.X]/10**
      ### Key Insights
      - [insight 1] / [insight 2]
    validation: postflight_captured
    checkpoint:
      question: "Step 7.5: POSTFLIGHT captured. Learning Index calculated. Proceed to save context?"
      options:
        - { label: "Proceed", description: "Continue to save context" }
        - { label: "Review Delta", description: "View learning delta details" }
        - { label: "Adjust Values", description: "Modify POSTFLIGHT scores" }

  step_8_save_context:
    purpose: Save conversation context
    activities: [Invoke system-spec-kit skill, Preserve decisions/insights/changes, Index memory file for search]
    tool_invocation:
      command: Read(".opencode/skill/system-spec-kit/SKILL.md")
      note: "Activate context saving"
    outputs: ["[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__implementation_session.md"]
    validation: context_saved_successfully
    checkpoint:
      question: "Step 8 Complete: Implementation workflow finished!"
      options:
        - { label: "Done", description: "Complete the workflow" }
        - { label: "View Final Summary", description: "Show complete implementation summary" }
    memory_creation:
      enforcement: HARD_BLOCK
      method: "MUST use generate-context.js script"
      command: "node .opencode/skill/system-spec-kit/scripts/dist/memory/generate-context.js [spec-folder-path]"
      forbidden: ["Write tool on memory/ paths", "Edit tool on memory/ paths"]
      violation_recovery: "DELETE manually created file, re-run via script"
    post_save_indexing:
      mcp_tool: memory_save
      invocation: 'spec_kit_memory_memory_save({ filePath: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__implementation_session.md" })'
      critical_note: "Call semantic memory MCP DIRECTLY - NEVER through Code Mode"
      when: "Immediately after memory file written to disk"
    anchor_requirements:
      enforcement: MANDATORY
      minimum_anchors: 2
      pattern: "[context-type]-[keywords]-[spec-number]"
      format: "<!-- ANCHOR:ID --> content <!-- /ANCHOR:ID -->"
      required_sections:
        - { type: "general", section: "Session summary", id: "GENERAL-SESSION-SUMMARY-{spec#}" }
        - { type: "decision", section: "Key decisions", id: "DECISION-{topic}-{spec#}" }
      optional_sections:
        - { type: "implementation", id: "IMPLEMENTATION-{feature}-{spec#}" }
        - { type: "files", id: "FILES-{spec#}" }
      benefit: "93% token savings on anchor-based retrieval"
    importance_tier:
      assign: important
      rationale: "Implementation sessions contain significant code decisions"
      tier_reference: "constitutional > critical > important > normal > temporary > deprecated"

  step_9_session_handover_check:
    purpose: Prompt user for session handover before completing
    enforcement: MANDATORY_CHECK
    activities: [Display handover prompt, Wait for response, "If accepted: run /spec_kit:handover", "If declined: proceed to termination"]
    handover_prompt:
      display: "Implementation complete. Create a handover document? Run: /spec_kit:handover. Recommended if continuing later, another dev picks up, or nuances worth documenting."
      options:
        - { label: "Create Handover", action: "Run /spec_kit:handover" }
        - { label: "Skip", action: "Proceed to termination" }
    behavior: { user_accepts: "Execute /spec_kit:handover", user_declines: "Proceed to termination" }
    validation: handover_check_complete
    checkpoint:
      question: "Would you like to create a handover document?"
      options:
        - { label: "Create Handover", description: "Run /spec_kit:handover for session continuity" }
        - { label: "Skip", description: "Complete workflow without handover" }

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 9
  message: "Implementation phase completed. Workflow terminated after step 9."
  next_steps: [Review implementation-summary.md, Verify changes in staging, Prepare for code review and PR]

# ─────────────────────────────────────────────────────────────────
# INTERACTIVE EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
interactive_execution:
  principle: "Execute with user approval at each checkpoint"
  checkpoint_behavior: [Complete activities, Present results summary, Present options for approval, Wait for response, Process feedback, Proceed or modify]
  code_review_behavior: [Show change summary, Offer diff view, Run tests on request, Accept modifications]
  user_feedback_handling: { approve: "Proceed to next step", review: "Show detailed output", modify: "Accept changes and re-execute", skip: "Skip optional step" }

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  step_validation_fails: "Review requirements, ask clarifying questions, retry"
  user_rejects_approach: "Present alternatives, modify code, document decision"
  tests_fail: "Debug, fix, re-run before marking complete"
  prerequisites_insufficient: "Return to /spec_kit:plan or ask user"
  environment_unavailable: "Skip browser testing, document limitation"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - follow_workflow_sequence
  - document_all_changes
  - validate_before_completion
  - update_task_checklist_progressively
  - pause_at_checkpoints_for_approval
  - respect_user_feedback
  - test_incrementally
  - use_checklist_for_verification_level_2_plus
  - mark_checklist_items_with_evidence
  - complete_all_p0_items_before_done
  - get_user_approval_for_p1_deferrals
  NEVER:
  - skip_workflow_steps
  - ignore_blockers
  - submit_without_validation
  - expand_scope_beyond_spec
  - proceed_without_user_approval
  - ignore_user_modification_requests
  - claim_completion_without_checklist_verification_level_2_plus
  - skip_p0_checklist_items
  - defer_p1_items_without_user_approval
