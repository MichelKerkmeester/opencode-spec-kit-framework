# ─────────────────────────────────────────────────────────────────
# OPENCODE CREATE: REFERENCE FILE CREATION WORKFLOW (AUTO MODE)
# ─────────────────────────────────────────────────────────────────
# Mode: autonomous (no user approval gates)
# Note: This workflow executes all steps sequentially with
#       continuous self-validation. Pauses only if confidence < 40%.
# ───────────────────────────────────────────────────────────────────
role: Expert Reference Creator using sk-documentation skill
purpose: Create reference files for existing skills (Level 3 progressive disclosure)
action: Generate workflow, patterns, debugging, or tool integration documentation

# ─────────────────────────────────────────────────────────────────
# PREREQUISITE: @write AGENT VERIFICATION
# ─────────────────────────────────────────────────────────────────
# This workflow REQUIRES the @write agent for:
#   • Template-first workflow (loads templates before creating)
#   • DQI scoring (target: 75+ Good)
#   • sk-documentation skill integration
#
# STANDALONE MODE: PHASE 0 in the command markdown verifies @write
# agent BEFORE this YAML workflow loads.
#
# CHAINED MODE: When invoked from /create:skill Step 8, @write
# verification was already performed by the parent command.
# The --chained flag indicates this is a chained invocation.
#
# To invoke correctly:
#   Standalone: @write /create:skill_reference [skill-name] [type]
#   Chained: /create:skill_reference [skill-name] [type] --chained
# ─────────────────────────────────────────────────────────────────

operating_mode:
  workflow: sequential_6_step
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: none
  tracking: progressive_task_checklists
  validation: continuous_self_validation
  chained_support: true # Can be invoked from parent workflows (skill.md Step 8)

development_philosophy:
  principle: "Reference files provide deep technical guidance loaded on-demand"
  approach: "Analyze → Plan → Load → Create → Validate"
  mandate: "Every reference must include explicit reasoning and named validation checkpoints"

# ─────────────────────────────────────────────────────────────────
# CONFIDENCE & CLARIFICATION FRAMEWORK
# ─────────────────────────────────────────────────────────────────
confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with citable source" }
    medium: { range: "40-79%", action: "Proceed with caution, document assumptions" }
    low: { range: "0-39%", action: "STOP - Ask clarification with A/B/C options" }

  scoring_weights:
    task_purpose_clarity: 0.30
    content_planning: 0.25
    template_adherence: 0.25
    validation_readiness: 0.20

  clarification_format: |
    "I need clarity (confidence: [NN%]). Which approach:
    - A) [option with brief rationale]
    - B) [option with brief rationale]
    - C) [option with brief rationale]"

  escalation:
    timebox_minutes: 10
    failed_attempts_threshold: 2
    action: "Present options to user with current findings"

# ─────────────────────────────────────────────────────────────────
# REQUEST ANALYSIS FRAMEWORK
# ─────────────────────────────────────────────────────────────────
request_analysis_framework:
  solution_flow:
  - "Parse carefully: What is ACTUALLY requested?"
  - "Gather Context: Read files, check skills folder"
  - "Identify Approach: SIMPLEST solution that works"
  - "Validate Choice: Follow patterns, maintainable"
  - "Clarify If Needed: If <80% confidence, ask"
  - "Scope Check: Solving ONLY what was asked?"
  - "Execute: Implement with minimal complexity"

  pre_change_validation:
    items:
    - "Skill exists and has SKILL.md?"
    - "Reference type valid? (workflow/patterns/debugging/tools/quick_ref)"
    - "Content scope defined?"
    - "Template patterns identified?"
    - "Confidence >=80%? (if not: ask)"
    stop_conditions: [ "Any item unchecked", "Skill not found" ]
    stop_action: "STOP and address before proceeding"

# ─────────────────────────────────────────────────────────────────
# USER INPUTS (From gate outputs)
# ─────────────────────────────────────────────────────────────────
user_inputs:
  skill_name: |
    [SKILL_NAME]
    Target skill to add reference to.
    FROM UNIFIED SETUP PHASE (Q0 or command argument).

  reference_type: |
    [REFERENCE_TYPE]
    Type: workflow | patterns | debugging | tools | quick_ref
    FROM UNIFIED SETUP PHASE (Q1).

  skill_path: |
    [SKILL_PATH]
    Verified path to the skill.
    FROM UNIFIED SETUP PHASE (automatic resolution).

  skill_verified: |
    [SKILL_VERIFIED]
    Whether skill exists and has SKILL.md.
    FROM UNIFIED SETUP PHASE (automatic verification).

# ─────────────────────────────────────────────────────────────────
# REFERENCE TYPES
# ─────────────────────────────────────────────────────────────────
reference_types:
  workflow:
    directory: "references/"
    naming: "[workflow_name].md"
    purpose: "Multi-phase processes with validation checkpoints"
    size_target: "500-1500 lines"
    key_features:
    - "Core Principle statement"
    - "Phased structure with checkpoints"
    - "Named validation gates"
    - "Sequential dependencies"
    structure:
    - "Introduction & Purpose with Core Principle"
    - "Phase overview (N phases listed)"
    - "Each phase: Purpose, Actions, Validation checkpoint"
    - "Quick Reference summary"

  patterns:
    directory: "references/"
    naming: "[topic]_patterns.md"
    purpose: "Code patterns with before/after examples"
    size_target: "300-800 lines"
    key_features:
    - "Before/after comparisons"
    - "'Why better' explanations"
    - "Pattern comparison tables"
    structure:
    - "Introduction with purpose"
    - "Each pattern: BEFORE, AFTER, Why better"
    - "Quick lookup table"

  debugging:
    directory: "references/"
    naming: "[topic]_debugging.md"
    purpose: "Systematic troubleshooting guides"
    size_target: "600-1200 lines"
    key_features:
    - "Root cause analysis flow"
    - "Common error patterns"
    - "Step-by-step diagnosis"
    structure:
    - "Symptom categories"
    - "Diagnostic decision tree"
    - "Fix procedures for each error"
    - "Prevention checklist"

  tools:
    directory: "references/"
    naming: "[tool]_guide.md"
    purpose: "External tool integration (MCP, CLI)"
    size_target: "200-600 lines"
    key_features:
    - "Tool usage patterns"
    - "Expected outputs"
    - "Common commands"
    structure:
    - "Tool overview"
    - "Configuration"
    - "Usage patterns with examples"
    - "Error handling"

  quick_ref:
    directory: "references/"
    naming: "quick_reference.md"
    purpose: "Commands, shortcuts, checklists"
    size_target: "200-400 lines"
    key_features:
    - "Table format"
    - "Checklists"
    - "Command reference"
    structure:
    - "Quick lookup tables"
    - "Command cheatsheet"
    - "Common tasks checklist"

# ─────────────────────────────────────────────────────────────────
# CHECKPOINT OPTIONS
# ─────────────────────────────────────────────────────────────────
checkpoint_options:
  standard:
  - label: "Approve"
    description: "Approve and continue to next step"
  - label: "Review"
    description: "Show more details"
  - label: "Modify"
    description: "Make changes before proceeding"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT (CRITICAL)
# ─────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false

  critical_steps:
    step_2_planning:
      enforcement: "MUST define content structure based on reference type"
      verification: "Cannot proceed without clear section plan"
    step_4_content:
      enforcement: "MUST follow template structure patterns"
      verification: "All sections written with examples, no placeholders"
    step_5_validation:
      enforcement: "MUST update SKILL.md integration"
      verification: "Navigation Guide and SMART ROUTING updated"

# ─────────────────────────────────────────────────────────────────
# CIRCUIT BREAKER
# ─────────────────────────────────────────────────────────────────
circuit_breaker:
  consecutive_failure_threshold: 3
  states:
    closed: "Normal operation"
    open: "3+ failures — pause and report to user"
    half_open: "Test with single retry before resuming"
  on_open:
    action: "Report failures to user with summary"
    suggest: "Review inputs and try again, or escalate"

# ─────────────────────────────────────────────────────────────────
# AUTONOMOUS EXECUTION
# ─────────────────────────────────────────────────────────────────
autonomous_execution:
  principle: "Execute workflow steps sequentially without user approval gates"
  decision_making: "Use confidence framework to self-assess at each step"
  uncertainty_handling: "If confidence < 40%, pause and report to user"
  progress_tracking: "Log step completion with validation status"
  completion_criteria: "All steps validated, DQI >= 75, all files created"

# ─────────────────────────────────────────────────────────────────
# QUALITY STANDARDS
# ─────────────────────────────────────────────────────────────────
quality_standards:
  dqi_minimum: 75
  dqi_enforcement: HARD_BLOCK
  validation_pipeline:
    stage_1: "python3 .opencode/skill/sk-documentation/scripts/validate_document.py [file]"
    stage_2: "python3 .opencode/skill/sk-documentation/scripts/extract_structure.py [file]"
  template_adherence: required
  core_standards_reference: ".opencode/skill/sk-documentation/references/core_standards.md"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW (6 STEPS WITH CHECKPOINTS)
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_request_analysis:
    purpose: Verify UNIFIED SETUP PHASE outputs and confirm reference creation
    activities:
    - Confirm skill_name from UNIFIED SETUP PHASE
    - Confirm reference_type from UNIFIED SETUP PHASE
    - Confirm skill_path from UNIFIED SETUP PHASE
    - Confirm skill_verified from UNIFIED SETUP PHASE
    - Validate reference_type is one of: workflow, patterns, debugging, tools, quick_ref
    type_reference:
      workflow: "Multi-phase processes - 500-1500 lines - Phased steps, checkpoints"
      patterns: "Code patterns library - 300-800 lines - Before/after examples"
      debugging: "Troubleshooting guide - 600-1200 lines - Root cause analysis"
      tools: "External tool integration - 200-600 lines - MCP/CLI usage"
      quick_ref: "Commands/shortcuts - 200-400 lines - Checklists, tables"
    outputs:
    - skill_confirmed
    - type_confirmed
    - path_confirmed

  step_2_reference_planning:
    purpose: Define reference content and structure
    activities:
    - Ask what technical guidance this reference should provide
    - Determine content scope (workflows, patterns, troubleshooting)
    - Plan sections based on reference type
    - Identify if phased workflows, code examples, or checkpoints needed
    questions:
    - "What technical guidance should this reference provide?"
    - "What workflows or processes?"
    - "What patterns or examples?"
    - "What troubleshooting scenarios?"
    prompt_template: |
      ┌────────────────────────────────────────────────────────────┐
      │ "What technical guidance should this reference provide?"   │
      │                                                            │
      │ - What workflows or processes?                              │
      │ - What patterns or examples?                               │
      │ - What troubleshooting scenarios?                          │
      └────────────────────────────────────────────────────────────┘
    reference_spec_format:
      filename: "[topic]_[type].md"
      purpose: "[what this reference provides]"
      key_sections:
      - "[Section with purpose]"
      phased_workflows: "[yes/no]"
      code_examples: "[yes/no]"
      validation_checkpoints: "[yes/no]"
    outputs:
    - spec_defined
    - sections_planned
    - features_identified

  step_3_template_loading:
    purpose: Load skill_reference_template.md and extract type-specific patterns
    activities:
    - Read skill_reference_template.md from sk-documentation skill
    - Extract patterns based on reference_type
    - Note formatting requirements (checkpoints, code blocks)
    template_path: .opencode/skill/sk-documentation/assets/opencode/skill_reference_template.md
    type_specific_patterns:
      workflow:
      - "Core Principle Statements"
      - "Phased Workflows with Validation"
      - "Named validation checkpoints"
      patterns:
      - "Before/After Code Examples"
      - "'Why better' explanations"
      debugging:
      - "Root cause analysis flow"
      - "Common error patterns"
      - "Fix procedures"
    structure_requirements:
    - "Explicit reasoning throughout"
    - "Named validation checkpoints"
    - "Before/after comparisons"
    - "Links to scripts and assets"
    outputs:
    - template_loaded
    - patterns_extracted
    - requirements_noted

  step_4_content_creation:
    purpose: Generate reference file based on type
    activities:
    - Apply type-specific template structure
    - Write core principle (for workflows)
    - Create phased structure with checkpoints (for workflows)
    - Write before/after examples
    - Create diagnostic flows (for debugging)
    - Include explicit reasoning throughout
    - Add named validation checkpoints
    - Write to skill's references directory
    type_templates:
      workflow: |
        # [Workflow Name]

        [One-line description]

        **Prerequisites:** [Required standards/context]

        ---

        ## 1. INTRODUCTION & PURPOSE

        ### Core Principle

        [Single powerful statement capturing essence]

        ### The [N] Phases

        You MUST complete each phase before proceeding to the next.

        ---

        ## 2. PHASE 1: [PHASE NAME]

        **Purpose**: [What this phase accomplishes]

        **Actions**:
        1. [Action 1]
        2. [Action 2]

        **Validation**: `checkpoint_name`
        - [Validation question 1]
        - [Validation question 2]

        ---

        ## N. QUICK REFERENCE

        [Summary checklist]

      patterns: |
        # [Pattern Library Name]

        ---

        ## 1. INTRODUCTION

        ### Purpose

        [What patterns this file provides]

        ---

        ## 2. PATTERN: [NAME]

        **BEFORE**: [Problem]
        ```[language]
        // Bad code
        ```

        **AFTER**: [Solution]
        ```[language]
        // Good code
        ```

        **Why better**: [Explanation]

        ---
    output_path: "[skill-path]/references/[filename].md"
    outputs:
    - reference_file_created
    - sections_count: number
    - checkpoints_count: number
    - examples_count: number

  step_5_validation:
    purpose: Quality check and SKILL.md integration
    activities:
    - Structure validation (core principle, phases, checkpoints)
    - Content validation (explicit reasoning, named checkpoints, links)
      - Integration (update SKILL.md Navigation Guide, SMART ROUTING)
    validation_checklist:
      structure:
      - "Core principle present (for workflows)"
      - "Phased structure with checkpoints"
      - "Before/after examples present"
      - "All code blocks specify language"
      content:
      - "Explicit reasoning throughout"
      - "Named checkpoints referenced"
      - "Links to related resources work"
      integration:
      - "Referenced from HOW IT WORKS if relevant"
    quality_gates:
      structure_complete: true
      checkpoints_named: true
      skill_md_updated: true
    outputs:
    - validation_passed: boolean
    - checklist_results: object
    - skill_md_updated: boolean

  step_5b_quality_validation:
    purpose: Quality-validate the created reference artifact
    agent_availability:
      agent_file: "[runtime_agent_path]/write.md"
      template_contract:
        source: "sk-documentation"
        validators: "validate_document.py + extract_structure.py"
        precedence: "Template compliance and DQI quality checks are mandatory before completion."
      rule_reference: "AGENTS.md §3 — sk-documentation template alignment and quality validation"
      condition: "ONLY when this step is actively executing"
      blocking: false
      not_for: "reviewing this workflow prompt or any pre-step activity"
    activities:
    - "Run @write quality validation to score the created reference file"
    - "Validation checks: template adherence, content quality, SKILL.md integration"
    - "Score against 100-point rubric (Accuracy 40%, Completeness 35%, Consistency 25%)"
    on_low_score:
      threshold: 70
      action: "Log warnings and suggest improvements; do not block workflow"
    outputs:
    - quality_score: number
    - validation_findings: list
    - improvement_suggestions: list (if score < 70)

  step_6_save_context:
    purpose: Preserve workflow decisions and context
    activities:
    - Invoke system-spec-kit skill
    - Document reference creation decisions
    - Record technical guidance and patterns
    - Save validation results
    - Create memory file with timestamp
    - Index memory file for immediate search availability
    tool_invocation:
      command: 'Read(".opencode/skill/system-spec-kit/SKILL.md")'
      note: "Activate context saving via memory skill"
    memory_content:
      include:
      - Skill name and reference type
      - Technical guidance captured
      - Patterns or workflows documented
      - SKILL.md integration updates
      - Any challenges or decisions made
    outputs:
    - memory_file: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__reference_creation_session.md"
    validation: context_saved

    # ── SEMANTIC MEMORY INTEGRATION ─────────────────────────────────
    post_save_indexing:
      purpose: "Index memory file immediately for search availability"
      mcp_tool: memory_save
      invocation: |
        spec_kit_memory_memory_save({
          filePath: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__reference_creation_session.md"
        })
      critical_note: "Call semantic memory MCP DIRECTLY - NEVER through Code Mode"
      when: "Immediately after memory file is written to disk"

    anchor_requirements:
      enforcement: MANDATORY
      minimum_anchors: 2
      # Note: Anchor IDs support prefix matching — 'summary' matches 'summary-049', etc.
      pattern: "[context-type]-[keywords]-[spec-number]"
      format: "<!-- ANCHOR:ID --> content <!-- /ANCHOR:ID -->"
      case: "UPPERCASE recommended for visibility"
      required_sections:
      - context_type: "general"
        section: "Session summary with reference creation outcomes"
        example_id: "GENERAL-SESSION-SUMMARY-{spec#}"
        example: |
          <!-- ANCHOR:GENERAL-SESSION-SUMMARY-{spec#} -->
          ## Session Summary
          Created [type] reference for [skill]...
          <!-- /ANCHOR:GENERAL-SESSION-SUMMARY-{spec#} -->
      - context_type: "decision"
        section: "Key decisions made during reference creation"
        example_id: "DECISION-REFERENCE-STRUCTURE-{spec#}"
        example: |
          <!-- ANCHOR:DECISION-REFERENCE-STRUCTURE-{spec#} -->
          ## Key Decisions
          - Chose workflow structure because...
          <!-- /ANCHOR:DECISION-REFERENCE-STRUCTURE-{spec#} -->
      optional_sections:
      - context_type: "implementation"
        section: "Patterns or workflows documented"
        example_id: "IMPLEMENTATION-PATTERNS-{spec#}"
      - context_type: "implementation"
        section: "SKILL.md integration changes"
        example_id: "IMPLEMENTATION-INTEGRATION-{spec#}"
      benefit: "93% token savings on anchor-based retrieval"
      reference: "See /memory:save Step 3 for full anchor documentation"

    importance_tier:
      assign: important
      rationale: "Technical references are high-value documentation that informs future decisions"
      promotion_note: "Use memory_update() to promote to 'critical' if reference becomes foundational"
      tier_reference: |
        constitutional: Core project rules (auto-surface always)
        critical: Foundational decisions (high priority in search)
        important: Significant work like technical references (this workflow)
        normal: Standard context (default)
        temporary: Short-term notes
        deprecated: Outdated but retained

# ─────────────────────────────────────────────────────────────────
# COMPLETION REPORT TEMPLATE
# ─────────────────────────────────────────────────────────────────
completion_report:
  template: |
    ✅ Reference Created

    Skill: [skill-name]
    Reference: [filename]
    Location: [full-path]
    Type: [workflow|patterns|debugging|tools|quick_ref]

    Content:
    - Sections: [N]
    - Phased Workflows: [Y/N]
    - Code Examples: [N pairs]
    - Checkpoints: [N named]

    SKILL.md Updated:
    - Navigation Guide: [Y/N]
    - SMART ROUTING: [Y/N]

    Next Steps:
    - Test reference in skill context
    - Add more examples if needed
    - Validate skill: quick_validate.py [skill-path]

    STATUS=OK PATH=[reference-path]

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  template_not_found:
    action: "Report template path, verify sk-documentation skill exists"
    fallback: "Use minimal structure based on reference type"
  skill_not_found:
    action: "List available skills, prompt for selection"
    options: [ "List skills", "Provide path", "Cancel" ]
  invalid_reference_type:
    action: "Show valid types"
    options: [ "workflow", "patterns", "debugging", "tools", "quick_ref" ]
  reference_exists:
    action: "Offer to update or rename"
    options: [ "Update existing", "Create with new name", "Cancel" ]
  no_references_dir:
    action: "Create directory automatically"
    command: "mkdir -p [skill-path]/references/"
  validation_failure:
    action: "Show specific errors, guide fixes, re-validate"
    loop: true
  file_write_failure:
    action: "Check permissions, verify path exists"
    fallback: "Report error and halt"
  user_rejects_approach:
    action: "Return to planning step, gather new requirements"
    reset_to: step_2_planning

# ─────────────────────────────────────────────────────────────────
# REFERENCE TEMPLATES
# ─────────────────────────────────────────────────────────────────
reference_templates:
  skill_reference: .opencode/skill/sk-documentation/assets/opencode/skill_reference_template.md
  core_standards: .opencode/skill/sk-documentation/references/core_standards.md

# ─────────────────────────────────────────────────────────────────
# TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: step_6_save_context
  message: "Reference creation workflow complete."
  next_steps:
    - condition: "Skill needs more references"
      action: "Run /create:skill_reference [skill-name] [type]"
    - condition: "Skill needs asset files"
      action: "Run /create:skill_asset [skill-name] [type]"
    - condition: "Want to validate complete skill"
      action: "Run quick_validate.py [skill-path]"
    - condition: "Context should be saved"
      action: "Run /memory:save"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - "Self-validate at each step before proceeding"
  - "Copy templates from canonical paths, never create from memory"
  - "Run validation before claiming completion"
  - "Include explicit reasoning in reference content"
  - "Name all validation checkpoints"
  - "Update SKILL.md routing after reference creation"
  - "Report progress at key milestones"

  NEVER:
  - "Prompt user for approval at checkpoints"
  - "Skip validation steps"
  - "Create documents without loading templates first"
  - "Leave placeholder text in final output"
  - "Create references for non-existent skills"
