# ─────────────────────────────────────────────────────────────────
# OPENCODE CREATE: VISUAL HTML WORKFLOW (CONFIRM MODE)
# ─────────────────────────────────────────────────────────────────
# Mode: interactive (step-by-step approval with checkpoints)
# Note: This workflow pauses at key checkpoints for user approval.
#
# This command is intentionally GENERAL-AGENT based.
# It does not require @write agent routing.
# ───────────────────────────────────────────────────────────────────
role: Expert Visual HTML Orchestrator using sk-visual-explainer
purpose: Generate or verify visual HTML artifacts with explicit user checkpoints
action: Route broad user intent into mode-specific flows and deliver validated visual outputs

operating_mode:
  workflow: sequential_6_step
  workflow_compliance: MANDATORY
  workflow_execution: interactive
  approvals: step_by_step
  validation: checkpoint_based

development_philosophy:
  principle: "One command surface, multiple deterministic visual workflows"
  approach: "Resolve intent → Derive mode → Load references → Build/verify → Validate → Deliver"
  mandate: "Keep outputs self-contained, traceable, and artifact-aware"

confidence_framework:
  thresholds:
    high: { range: "80-100%", action: "Proceed with citable source" }
    medium: { range: "40-79%", action: "Proceed with caution, document assumptions" }
    low: { range: "0-39%", action: "STOP - Ask clarification with A/B/C options" }

  scoring_weights:
    intent_resolution: 0.30
    input_clarity: 0.25
    source_availability: 0.25
    validation_readiness: 0.20

checkpoint_options:
  standard:
    - label: "Approve"
      description: "Approve and continue to next step"
    - label: "Review"
      description: "Show details before continuing"
    - label: "Modify"
      description: "Adjust inputs or assumptions"

user_inputs:
  target_input: |
    [TARGET_INPUT]
    Topic, path, git target, time window, or html file path.
    FROM UNIFIED SETUP PHASE.

  operation_intent: |
    [OPERATION_INTENT]
    One of: auto | create | analyze | verify | custom
    FROM UNIFIED SETUP PHASE or --mode flag.

  output_behavior: |
    [OUTPUT_BEHAVIOR]
    create_new | overwrite
    FROM UNIFIED SETUP PHASE.

intent_router:
  supported_intents: [auto, create, analyze, verify, custom]
  legacy_aliases:
    generate: create
    plan-review: analyze
    diff-review: analyze
    recap: analyze
    fact-check: verify
  resolution_rules:
    - "verify -> fact-check"
    - "create -> generate"
    - "analyze + branch/commit/PR# or --include-doc-impact -> diff-review"
    - "analyze + time-window or --include-doc-health -> recap"
    - "analyze + source-doc/artifact/default -> plan-review"
    - "auto/custom -> infer from target_input and flags; ask clarification if ambiguous"

mode_profiles:
  generate:
    description: "Create new visual from topic or source document"
    output_pattern: ".opencode/output/visual/generate-{descriptor}-{timestamp}.html"
    action: create
    default_style: blueprint

  plan-review:
    description: "Create visual analysis for docs/artifacts"
    output_pattern: ".opencode/output/visual/plan-review-{descriptor}-{timestamp}.html"
    action: create
    default_style: data-dense

  diff-review:
    description: "Create visual change review for branch/commit/PR"
    output_pattern: ".opencode/output/visual/diff-review-{descriptor}-{timestamp}.html"
    action: create
    default_style: blueprint

  recap:
    description: "Create visual recap for selected time window"
    output_pattern: ".opencode/output/visual/recap-{descriptor}-{timestamp}.html"
    action: create
    default_style: data-dense

  fact-check:
    description: "Verify and correct an existing visual HTML file"
    output_pattern: ".opencode/output/visual/{descriptor}-verified.html"
    action: verify
    default_style: preserve_existing

spec_metadata_contract:
  required_when_artifact_aware: true
  tags:
    - "ve-artifact-type"
    - "ve-source-doc"
    - "ve-speckit-level"
    - "ve-view-mode"

reference_loading:
  always:
    - ".opencode/skill/sk-visual-explainer/SKILL.md"
    - ".opencode/skill/sk-visual-explainer/references/quick_reference.md"
    - ".opencode/skill/sk-visual-explainer/references/css_patterns.md"
    - ".opencode/skill/sk-visual-explainer/references/quality_checklist.md"
  conditional:
    plan-review:
      - ".opencode/skill/sk-visual-explainer/references/artifact_profiles.md"
      - ".opencode/skill/sk-visual-explainer/references/user_guide_profiles.md"
    generate:
      - ".opencode/skill/sk-visual-explainer/references/library_guide.md"
    diff-review:
      - ".opencode/skill/sk-visual-explainer/references/navigation_patterns.md"
    recap:
      - ".opencode/skill/sk-visual-explainer/references/navigation_patterns.md"
    fact-check:
      - ".opencode/skill/sk-visual-explainer/references/artifact_profiles.md"
      - ".opencode/skill/sk-visual-explainer/references/user_guide_profiles.md"

workflow:
  step_1_request_analysis:
    purpose: Resolve setup outputs, intent, and command flags
    activities:
      - "Validate operation_intent is supported (including legacy aliases)"
      - "Resolve target_input and optional flags"
      - "Derive internal_mode via intent_router"
      - "Resolve output strategy from output_behavior"
    outputs:
      - intent_resolved
      - internal_mode_resolved
      - target_resolved
      - output_strategy_resolved
    checkpoint:
      question: "Run create:visual_html with [operation_intent] intent and resolved target/output behavior?"
      options:
        - label: "A) Approve"
          description: "Proceed with these settings"
        - label: "B) Modify"
          description: "Adjust intent/target/behavior"

  step_2_mode_routing:
    purpose: Route derived internal mode to mode-specific logic
    activities:
      - "Load profile for internal_mode"
      - "Apply default style/type only when not explicitly provided"
      - "Determine create vs verify action"
    outputs:
      - mode_profile_loaded
      - action_resolved
    checkpoint:
      question: "Mode profile resolved. Continue to data collection?"
      options:
        - label: "A) Continue"
          description: "Proceed with this profile"
        - label: "B) Review"
          description: "Inspect profile details"

  step_3_evidence_and_context:
    purpose: Collect mode-specific inputs and source-of-truth evidence
    activities:
      - "Read source docs/files if provided"
      - "Collect git data when internal_mode is diff-review"
      - "Resolve time-window when internal_mode is recap"
      - "Resolve source mapping when internal_mode is fact-check"
    outputs:
      - evidence_collected
      - source_mapping_resolved
    checkpoint:
      question: "Evidence collection complete. Continue to render/verify?"
      options:
        - label: "A) Continue"
          description: "Proceed"
        - label: "B) Modify"
          description: "Adjust evidence scope"

  step_4_render_or_verify:
    purpose: Execute HTML generation or verification
    activities:
      - "Generate HTML from selected internal_mode pipeline"
      - "For internal_mode=fact-check, produce corrected verified output"
      - "Apply metadata contract when artifact-aware"
    outputs:
      - html_output_ready
      - metadata_applied
    checkpoint:
      question: "Draft output ready. Continue to validation?"
      options:
        - label: "A) Validate"
          description: "Run quality checks"
        - label: "B) Modify"
          description: "Update output first"

  step_5_validation:
    purpose: Enforce quality and structural checks
    activities:
      - "Run quality checklist checks"
      - "Verify no placeholder leakage"
      - "Verify metadata contract completeness when required"
      - "Verify links and source references are coherent"
    quality_gates:
      placeholders_absent: true
      html_self_contained: true
      metadata_contract_valid: true
    outputs:
      - validation_passed
      - validation_report
    checkpoint:
      question: "Validation passed. Publish output file?"
      options:
        - label: "A) Publish"
          description: "Write final output"
        - label: "B) Fix"
          description: "Address validation issues first"

  step_6_delivery:
    purpose: Save output and emit structured status
    activities:
      - "Write output file using mode profile naming pattern"
      - "Open output in browser when available"
      - "Return STATUS line with action and path"
    completion_report:
      success: |
        STATUS=OK ACTION={create_or_verify} PATH={output_path}
        SUMMARY="Unified visual_html workflow completed with validated output"
      failure: |
        STATUS=FAIL ERROR="{error_message}"

error_handling:
  invalid_intent:
    action: "Return STATUS=FAIL with supported intents and legacy alias guidance"
  missing_target:
    action: "Return STATUS=FAIL ERROR='Missing target input'"
  unreadable_source:
    action: "Return STATUS=FAIL with unreadable path details"
  git_data_unavailable:
    action: "Return STATUS=FAIL with diff/PR command context"
  validation_failure:
    action: "Return STATUS=FAIL with failing quality gate"
