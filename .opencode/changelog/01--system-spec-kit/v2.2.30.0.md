# v2.2.30.0

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**2.2.30.0**] - 2026-02-21

**Fix MCP Server "no such table" Errors in `/memory:manage`** -- Eliminated SQLite "no such table" errors (memory_index, checkpoints) that occurred when the LLM fell back to raw `sqlite3` Bash commands against uninitialized databases. Four-layer fix: removed Bash from manage.md allowed-tools, added missing `checkDatabaseUpdated()` guard to health handler, extracted idempotent `ensureCompanionTables()` for schema resilience, and improved error messages with actionable recovery instructions. Code review pass: normalized all snake_case locals to camelCase, consolidated `toErrorMessage` usage in checkpoints.ts, fixed stale section references in manage.md, and updated health table list.

---

## Highlights

### Category: Bug Fixes

- **Removed Bash fallback path**: Removed `Bash` from `manage.md` allowed-tools to prevent the LLM from running raw `sqlite3` commands against uninitialized DB files. Added explicit tool enforcement block prohibiting direct database access.
- **Health handler guard**: Added `await checkDatabaseUpdated()` to `handleMemoryHealth()` â€” the only handler missing this standard guard call. Added `no such table` detection that returns `E_SCHEMA_MISSING` with recovery instructions instead of silently reporting "degraded" status.
- **Companion table resilience**: Extracted `ensureCompanionTables()` function containing idempotent `CREATE TABLE IF NOT EXISTS` statements for `memory_history`, `checkpoints`, and `memory_conflicts` plus their indexes. Called from both the existing-DB early-return path and the new-DB path of `create_schema()`, ensuring companion tables are always created even if `memory_index` already exists.
- **Actionable error messages**: Improved and aligned error messages in `requireDb()`, `checkpoints.getDatabase()`, `handleMemoryList()`, and `handleMemoryStats()` null-db responses to suggest specific recovery actions (restart MCP server, run `memory_index_scan()`).

### Category: Code Quality

- **camelCase normalization**: Renamed all snake_case local variables in `handleMemoryDelete`, `handleMemoryUpdate`, `handleMemoryList`, and `handleMemoryStats` to camelCase (`spec_folder` -> `specFolder`, `checkpoint_name` -> `checkpointName`, `allow_partial_update` -> `allowPartialUpdate`, etc.)
- **`toErrorMessage` consolidation**: Imported and applied `toErrorMessage()` from `db-helpers.ts` across all 8 inline `error instanceof Error ? error.message : String(error)` patterns in `checkpoints.ts`
- **`NonNullable<>` type**: Replaced `& {}` intersection trick in `requireDb()` return type with standard `NonNullable<>` utility type
- **Property shorthand**: Applied ES2015 shorthand for `embeddingModelReady` and `memoryCount` in health handler response
- **Migration note**: Added removal guidance comment to backward-compatible snake_case alias block

### Category: Documentation

- **Error handling table**: Added two new rows to manage.md error handling table: "MCP tool unavailable" and "Database not initialized" with actionable guidance
- **Section references**: Fixed 7 stale section number references in manage.md routing tree (Section 5 -> 7, etc.)
- **Health table list**: Updated health check output template to include `memory_history`, `checkpoints`, and `memory_conflicts` tables; removed `session_state` (managed by session-manager, not companion tables)

## Files Changed

| File | Change |
|------|--------|
| `.opencode/command/memory/manage.md` | Removed `Bash` from allowed-tools, added tool enforcement block, added error recovery rows, fixed section references, updated health table list |
| `.opencode/skill/system-spec-kit/mcp_server/handlers/memory-crud.ts` | Added `checkDatabaseUpdated()` to health handler, `no such table` detection, camelCase normalization across all handlers, property shorthand, alias migration note |
| `.opencode/skill/system-spec-kit/mcp_server/lib/search/vector-index-impl.ts` | Extracted `ensureCompanionTables()` with TSDoc, called from both paths of `create_schema()` |
| `.opencode/skill/system-spec-kit/mcp_server/utils/db-helpers.ts` | Improved `requireDb()` error message, `NonNullable<>` return type |
| `.opencode/skill/system-spec-kit/mcp_server/lib/storage/checkpoints.ts` | Improved `getDatabase()` error message, removed module prefix from throw, imported and applied `toErrorMessage` across 8 inline patterns |

## Upgrade

Restart the MCP server after updating to apply schema changes. On next startup, `ensure_companion_tables()` will auto-create any missing companion tables. No manual migration needed.
