# v2.2.16.0

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**2.2.16.0**] - 2026-02-15

**System-wide audit of upgrade-level.sh** — 2 P0 fail-fast fixes, 7 P1 hardening patches, automatic rollback on failure, and a 14-test regression suite.

> Spec folder: `specs/003-system-spec-kit/125-codex-system-wide-audit/` (Level 3+)

---

## Highlights

### Bug Fixes
- **Fail-fast guard for shell-common.sh sourcing** — upgrade-level.sh now exits immediately if the shared library cannot be sourced (lines 29-33)
- **Recursive backup for memory/ subdirectories** — backup logic now preserves nested directory structures instead of silently skipping them (lines 303-338)
- **Comment header leak** — upgrade_plan() and upgrade_checklist() no longer inject stray comment lines into generated output
- **OPEN QUESTIONS warning** — now emitted to stderr so it surfaces visibly during upgrades

### Hardening
- **Dead code removed** — SED_INPLACE_FLAG variable eliminated
- **Multi-Agent detection regex** — anchored to table row pattern to prevent false positives
- **Complexity flag exit pattern** — tightened to avoid partial matches
- **Iteration guard in find_insert_point()** — capped at 200 iterations to prevent infinite loops
- **Level detection pattern** — anchored to line start for reliable matching

### Features
- **Automatic rollback on upgrade failure** — new restore_from_backup() function (lines 345-373) triggers at line 1488 when upgrade fails, restoring the spec folder to its pre-upgrade state

### Testing
- **14-test regression suite** — new test-upgrade-level.sh covering shell-common guard, input validation, level detection, dry-run mode, already-at-target, and missing spec.md scenarios

### Maintenance
- **Spec 121 orphan memory cleanup** — deleted junk constitutional memory #1346, regenerated as #1361
- **Cross-spec lineage audit** — resolved contradictions across the 121→123→124 chain
- **Full Level 3+ documentation** — evidence-cited checklist with complete traceability

## Files Changed
- `.opencode/skill/system-spec-kit/scripts/spec/upgrade-level.sh`
- `.opencode/skill/system-spec-kit/scripts/tests/test-upgrade-level.sh` (new)
- `specs/003-system-spec-kit/125-codex-system-wide-audit/` (all documentation files)

## Upgrade
No action required.
