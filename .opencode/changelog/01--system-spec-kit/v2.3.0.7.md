# v2.3.0.7

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**2.3.0.7**] - 2026-02-23

**Two critical MCP server bugs fixed: tool schema rejection and vec_memories UNIQUE constraint** - Claude API tool calls were blocked by a top-level `oneOf` in the `memory_delete` schema, and `memory_save` with `force: true` failed on orphaned vector entries from prior incomplete deletions.

---

## Highlights

### Category: Bug Fixes

- **Tool schema API rejection fixed**: Removed `oneOf` from `memory_delete` input schema. The Claude API rejects `oneOf`, `allOf`, and `anyOf` at the top level of tool schemas, which blocked ALL MCP tool calls including subagent dispatch.
- **vec_memories UNIQUE constraint fixed**: Added defensive DELETE before INSERT in the `index_memory` creation path. Without `AUTOINCREMENT` on `memory_index`, SQLite can reuse rowids of deleted rows whose `vec_memories` counterpart was not cleaned up, causing UNIQUE constraint failures on `memory_save`.

### Category: Validation

- **Schema structural meta-test added**: New test verifies zero `oneOf`/`allOf`/`anyOf` across all 22 tool schemas to prevent future regressions.
- **Test suite expanded**: `tool-input-schema.vitest.ts` expanded from 5 to 15 tests covering schema integrity, `memory_delete` argument permutations, and type validation.
- **Full regression suite passed**: 4,605/4,606 tests pass (1 pre-existing modularization failure, unrelated).
- **Alignment verifier passed**: 288 files scanned, 0 findings.

## Files Changed

| File | Change |
|------|--------|
| `.opencode/skill/system-spec-kit/mcp_server/tool-schemas.ts` | Removed `oneOf` from `memoryDelete` schema; constraint documented in description |
| `.opencode/skill/system-spec-kit/mcp_server/lib/search/vector-index-impl.ts` | Defensive DELETE before vec_memories INSERT to prevent orphaned rowid conflicts |
| `.opencode/skill/system-spec-kit/mcp_server/tests/tool-input-schema.vitest.ts` | Expanded from 5 to 15 tests: structural integrity + exhaustive memory_delete coverage |

## Upgrade

No migration required. Both fixes are backward-compatible. The `memory_delete` handler already validated the either/or constraint server-side; the schema change only affects Claude API compatibility. The defensive DELETE is a no-op when no orphaned vector exists.
