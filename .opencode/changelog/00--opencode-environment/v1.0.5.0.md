# v1.0.5.0

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**1.0.5.0**] - 2026-01-17

**Memory Command Separation, Dynamic Templates & Composite Ranking** — Major feature release introducing Memory Command Separation, Dynamic Complexity-Based Templates, and Composite Folder Ranking with ~3,000+ new lines of code, 300+ tests, and comprehensive performance optimizations.

> Spec folder: 068-072

---

## Highlights

### Memory Command Separation

- **`/memory:database` Command** — New dedicated command for database management with 9 modes: `stats`, `scan`, `cleanup`, `tier`, `triggers`, `validate`, `delete`, `health`
- **Safety Gates for Destructive Operations** — Hard block confirmations for cleanup and delete operations
- **Automatic Checkpoint Creation** — Pre-cleanup checkpoint created before bulk deletions

### Dynamic Complexity-Based Templates

- **5-Dimension Complexity Detection** — Analyzes task descriptions across weighted dimensions (Scope 25%, Risk 25%, Research 20%, Multi-Agent 15%, Coordination 15%)
- **Level Classification System** — Maps complexity scores to documentation levels: Level 1 (0-25), Level 2 (26-55), Level 3 (56-79), Level 3+ (80-100)
- **Level-Specific Template Folders** — Pre-expanded templates in `templates/level_1/`, `level_2/`, `level_3/`, `level_3+/`
- **New CLI Tools** — `detect-complexity.js` and `expand-template.js` with comprehensive flag support
- **171 Tests** — Comprehensive test suite with 100% coverage across 5 test suites

### Composite Folder Ranking

- **Composite Ranking Algorithm** — Multi-factor scoring replacing simple count-based ranking: `(recency × 0.40) + (importance × 0.30) + (activity × 0.20) + (validation × 0.10)`
- **Archive Detection & Filtering** — Automatic deprioritization of archived folders (z_archive/ 0.1×, scratch/test- 0.2×)
- **Recency Decay System** — Time-based score decay with 10-day half-life
- **Constitutional Tier Decay Exemption** — Constitutional memories never decay (always 1.0)
- **New `memory_stats()` Parameters** — folderRanking, excludePatterns, includeScores, includeArchived
- **61 Tests** — All passing for folder scoring system

### Memory Search Refactoring

- **`/memory:search` Now Read-Only** — Removed cleanup, tier, triggers, and validate operations (moved to `/memory:database`)
- **Simplified Actions** — Memory detail view shows only read operations: related, load anchor, search, back, quit

### Template System Updates

- **Scripts Use Level Folders** — `create-spec-folder.sh` and `expand-template.js` now copy from level-specific folders
- **COMPLEXITY_GATE Markers Deprecated** — Replaced with pre-expanded templates per level (markers still functional for backward compatibility)
- **18 Documentation Files Updated** — All copy commands reference `templates/level_N/` paths

### Performance Optimizations

- **Async File Reading** — `safe_read_file_async()` with `Promise.all()` for parallel I/O
- **RRF Fusion O(1) Lookups** — Map-based lookups replacing O(n×m) linear search
- **Checkpoint Restore Batch Deduplication** — O(n) query approach replacing O(n²)
- **Unified Recency Scoring** — Single implementation in `folder-scoring.js` imported by all consumers
- **MCP Library Reorganization** — Organized into `cognitive/`, `parsing/`, `providers/`, `scoring/`, `search/`, `storage/`, `utils/`

### Infrastructure

- **Barrel Export Namespace Prefixes** — 58 explicit named exports replacing spread operators to prevent collision
- **Database Reinitialization Mutex** — Promise-based mutex preventing race conditions
- **Constitutional Memory Double-Fetch Prevention** — Conditional check before redundant queries

## Fixed

### Critical Fixes

- **Barrel Export Collision Risk** — Spread operators silently overwrote functions; replaced with namespace prefixes
- **Database Reinitialization Race Condition** — Added mutex with finally-block release
- **Sequential File Reads Blocking Event Loop** — Added async file reading with Promise.all()
- **RRF Fusion O(n×m) Complexity** — Map-based O(1) lookups
- **~400 Lines Duplicate Scoring Code** — `rank-memories.js` now imports from `folder-scoring.js`
- **Checkpoint Restore O(n²) Deduplication** — Batch query approach with composite keys

### Validation System Fixes

- **`check-section-counts.sh`** — Grep output sanitization for comparison operators
- **4 Validation Rules Rewritten** — check-complexity, check-section-counts, check-ai-protocols, check-level-match now implement `run_check()` interface
- **Constitutional `gate-enforcement.md`** — Now indexed with `constitutional` tier (was `normal`)

### Template Fixes

- **`level_2/checklist.md`** — Removed 6 orphaned COMPLEXITY_GATE markers
- **36 Path References** — Updated from `scripts/generate-context.js` to `scripts/memory/generate-context.js`

## Files Changed

- Memory command system (`/memory:database`, `/memory:search`)
- Complexity detection system (detect-complexity.js, expand-template.js)
- Folder ranking algorithm (folder-scoring.js)
- Template system (18 documentation files, 4 template folders)
- MCP library organization (7 reorganized modules)
- Validation rules (4 rules rewritten)

## Upgrade

- **Restart Required** — Restart OpenCode to load updated MCP server with new ranking and search features
- **New Commands Available** — `/memory:database` provides management operations; `/memory:search` is now read-only
- **Template Level Selection** — Use `--level N` flag with `create-spec-folder.sh` for level-appropriate templates
- **No Breaking Changes** — All existing APIs maintain backward compatibility
