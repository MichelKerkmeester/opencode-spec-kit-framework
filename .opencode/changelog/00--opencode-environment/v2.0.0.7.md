# v2.0.0.7

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**2.0.0.7**] - 2026-02-12

**Spec Kit Script Refactoring — Architectural Improvements** — Implemented 6 deferred architectural items from spec 109: dynamic template composition, POSIX shell portability, code quality hardening, workflow.ts module extraction, JSONC parser consolidation, and create.sh modularization. Total: ~1,200 LOC reduced across shell and TypeScript, 19 code quality fixes, 12 structured logging conversions.

> Spec folder: `anobel.com/.opencode/specs/003-memory-and-spec-kit/110-spec-kit-script-refactoring/` (Level 3)

---

## Highlights

### Architecture & Modularization

- **`compose.sh` Dynamic Templates** — Replaced all 12 hardcoded L3/L3+ heredoc composition paths with dynamic fragment assembly from `templates/addenda/`. 1030→750 LOC (-27%). Zero heredocs remain. `compose.sh --verify` validates all fragment paths at runtime
- **`create.sh` Modularization** — Extracted 3 shell libraries (`shell-common.sh`, `git-branch.sh`, `template-utils.sh`) + 5 externalized sharded templates. 928→566 LOC (-39%). `validate.sh` also wired to shared libs
- **`workflow.ts` Module Extraction** — Extracted 4 focused modules: `quality-scorer.ts` (122 LOC), `topic-extractor.ts` (88 LOC), `file-writer.ts` (33 LOC), `memory-indexer.ts` (159 LOC). 865→495 LOC (-43%)
- **Structured Logging Migration** — 12 library-internal `console.warn` calls converted to `structuredLog` across 5 files (`config.ts`, `content-filter.ts`, `decision-tree-generator.ts`, `message-utils.ts`, `template-renderer.ts`). CLI/pipeline scripts intentionally kept as `console.*` (correct for user-facing output)

### New Modules & Utilities

- **`shared/utils/jsonc-strip.ts`** — Shared JSONC comment-stripping utility (95 LOC). `config.ts` and `content-filter.ts` now use shared utility instead of inline regex. Fixed latent bug in `content-filter.ts` naive regex that could corrupt strings containing `//`
- **Shell Libraries** — `scripts/lib/shell-common.sh` (54 LOC), `scripts/lib/git-branch.sh` (134 LOC), `scripts/lib/template-utils.sh` (80 LOC)
- **Template Fragments** — 5 addenda fragments (`level3-arch/` prefix/suffix/guidance, `level3plus-govern/` suffix/guidance) and 5 sharded templates (`spec-index.md`, `01-overview.md`, `02-requirements.md`, `03-architecture.md`, `04-testing.md`)

### Bug Fixes & Hardening

- **sed/grep POSIX Portability** — 5 GNU-specific fixes: 3 `sed 's/-\+/-/g'` → `sed 's/--*/-/g'` (BSD treats `\+` as literal), 1 fragile `sed i\` rewrite to printf+sed, 1 `grep -P '\b'` → `grep -w` (POSIX compliant)
- **Code Quality Hardening** — 11 untyped `catch (e)` → `catch (e: unknown)` with proper `instanceof Error` guards, 8 non-null assertions (`!`) replaced with explicit null checks across 10 files
- **`isMemoryFile` README Bug** — `isSkillReadme` check in `memory-parser.ts` incorrectly matched `README.md` files inside `constitutional/` directories. Added `!normalizedPath.includes('/constitutional/')` guard

---

## Files Changed

`scripts/core/workflow.ts` · `scripts/core/quality-scorer.ts` (new) · `scripts/core/topic-extractor.ts` (new) · `scripts/core/file-writer.ts` (new) · `scripts/core/memory-indexer.ts` (new) · `scripts/core/config.ts` · `scripts/templates/compose.sh` · `scripts/spec/create.sh` · `scripts/spec/validate.sh` · `scripts/lib/shell-common.sh` (new) · `scripts/lib/git-branch.sh` (new) · `scripts/lib/template-utils.sh` (new) · `scripts/lib/content-filter.ts` · `scripts/lib/decision-tree-generator.ts` · `scripts/lib/semantic-summarizer.ts` · `scripts/utils/message-utils.ts` · `scripts/utils/input-normalizer.ts` · `scripts/renderers/template-renderer.ts` · `shared/utils/jsonc-strip.ts` (new) · `shared/index.ts` · `mcp_server/lib/parsing/memory-parser.ts` · `templates/addenda/` (5 fragments) · `templates/sharded/` (5 templates) · 10 files with catch/assertion fixes

---

## Verification

**Build:** `tsc --build --force` PASS (0 errors)
**Tests:** 3,872 passing, 0 failures
**Shell:** All scripts pass `bash -n` syntax check

---
