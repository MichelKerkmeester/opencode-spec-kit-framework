# v1.0.4.0

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**1.0.4.0**] - 2026-01-15

**Major Architecture & Quality Release** — Modular MCP server (88% reduction), Anchor System for targeted memory retrieval (61–93% token savings), Voyage 4 embeddings, 231 infrastructure fixes, and comprehensive documentation updates.

---

## Highlights

### New

- **Anchor System for Targeted Memory Retrieval** — The `memory_search` tool now accepts an `anchors` parameter enabling retrieval of specific memory sections (e.g., "summary", "decisions") instead of full file content. Verified savings: 73% for summary-only, 87% for decisions-only, 61% for summary+decisions. Response metadata includes `tokenMetrics` with savings calculations.
- **Modular MCP Server Architecture** — Decomposed `context-server.js` into 19 focused modules across 5 directories:
  - `core/` (3 files, 507 lines) — Server configuration, database state management
  - `handlers/` (7 files, 1,395 lines) — Tool handlers for search, triggers, CRUD, checkpoints
  - `formatters/` (3 files, 353 lines) — Search results and token metrics formatting
  - `utils/` (4 files, 478 lines) — Validators, JSON helpers, batch processing
  - `hooks/` (2 files, 223 lines) — SK-004 auto memory surfacing
- **Voyage 4 Embedding Support** — Added `voyage-4`, `voyage-4-large`, and `voyage-4-lite` to supported models with automatic database separation per model (existing `voyage-3.5` embeddings preserved)

### Changed

- **Default Embedding Model** — Changed from `voyage-3.5` to `voyage-4` for Spec Kit Memory MCP. Narsil retains `voyage-code-2` until a code-specific Voyage 4 model is released.
- **Entry Point Reduction** — `context-server.js` reduced from 2,703 lines to 319 lines (88% reduction)
- **Documentation Accuracy** — ANCHOR system documentation updated from "93% token savings" claim to verified metrics. Debug delegation threshold standardized to "3+ failed attempts" across all documentation.
- **Attention Decay Documentation** — Corrected to reflect actual turn-based implementation (not time-based as previously documented)
- **MCP Tool Documentation** — Expanded from 7 to 14 documented tools. Added `searchBoost` multipliers for importance tiers

### Fixed

- **Critical: Missing `await` in memory_search** — Fixed `formatSearchResults()` calls returning Promise objects instead of resolved results when `includeContent=true`
- **Critical: Undefined E429 Error Code** — Added definition to `errors.js` and documented in troubleshooting guide
- **Critical: Embedding API Rate Limiting** — Added `BATCH_DELAY_MS` (100ms default) to prevent provider throttling
- **Critical: vec_memories Cleanup Order** — Fixed deletion order to prevent orphaned vector rows
- **Race Conditions** — Added mutex protection for embedding warmup; fixed constitutional cache clearing; fixed trigger cache invalidation after bulk indexing
- **Memory Leaks** — Implemented LRU cache for regex objects in `trigger-matcher.js`; added timer cleanup in `errors.js`
- **Null Safety** — Added null checks throughout codebase for database query results
- **Cross-Platform Compatibility** — Replaced hardcoded macOS paths with `os.homedir()` and `os.tmpdir()`
- **Config System Cleanup** — Deleted unused `config-loader.js` and reduced `search-weights.json` to actively used sections only
- **parseInt Radix** — Added explicit radix parameter to all `parseInt()` calls

## Files Changed

- `context-server.js` → 19 modular files across core/, handlers/, formatters/, utils/, hooks/ (REFACTORED)
- `embeddings.js` (MODIFIED)
- `errors.js` (MODIFIED)
- `trigger-matcher.js` (MODIFIED)
- `search-weights.json` (MODIFIED)
- Documentation updates across MCP tools and architecture guides (MODIFIED)

## Upgrade

**Restart Required** — Restart OpenCode to load the updated Spec Kit Memory MCP server with Voyage 4 support.

- **Automatic Database Migration** — System creates new database file (`context-index__voyage__voyage-4__1024.sqlite`) when switching to Voyage 4. Existing memories preserved.
- **Optional Re-indexing** — Run `memory_index_scan({ force: true })` to bulk re-index existing memory files.
- **No Breaking Changes** — All 14 MCP tools maintain identical interfaces.
