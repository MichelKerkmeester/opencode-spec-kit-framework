# v2.0.4.0

> Part of [OpenCode Dev Environment](https://github.com/MichelKerkmeester/opencode-spec-kit-framework)

---

## [**2.0.4.0**] - 2026-02-17

**Plan-to-Implementation Gate Enforcement** -- Fixed a behavioral defect where the AI agent skipped all mandatory gates (Gate 1-3) when transitioning from a `/spec_kit:plan` workflow to implementation via free-text request. Three compounding root causes addressed: missing phase boundary in Gate 3, over-generalized Memory Save Rule carry-over, and suggestion-only plan termination.

> Spec folder: `.opencode/specs/003-system-spec-kit/134-command-adherence/` (Level 3)

---

## Highlights

### Problem

When `/spec_kit:plan` completes and the user says "Implement the following plan:" as free text (not via `/spec_kit:implement`), the agent:
1. Skipped Gate 3 (spec folder question) -- assumed it was already answered during planning
2. Skipped Gate 2 (skill routing) -- no re-evaluation at phase boundary
3. Began writing code immediately without documentation or approval gates

### Root Cause (3 compounding factors)

1. **No phase boundary concept in Gate 3** -- Once answered during planning, Gate 3 was considered permanently satisfied for the rest of the conversation
2. **Memory Save Rule over-generalization** -- The "do NOT re-ask the user" instruction (intended for memory saves only) was generalized to all post-plan actions
3. **Plan termination was suggestion-only** -- `next_steps` in YAML merely suggested `/spec_kit:implement` without enforcing it

### Fix A: AGENTS.md Gate 3 Phase Boundary Rule

Added `PHASE BOUNDARY` clause to Gate 3 definition:
- Gate 3 answers apply ONLY within the current workflow phase
- Plan-to-implement transition MUST re-evaluate Gate 3
- Free-text implement requests must route through `/spec_kit:implement`
- Exception: Memory Save Rule carry-over remains valid

### Fix B: AGENTS.md Memory Save Rule Scoping

Scoped the "do NOT re-ask" instruction explicitly to memory saves:
- Changed "USE IT as the folder argument" to "USE IT as the folder argument for memory saves"
- Added explicit NOTE: "This carry-over applies ONLY to memory saves"

### Fix C: Plan YAML Termination Enforcement

Added `enforcement:` block to both `spec_kit_plan_auto.yaml` and `spec_kit_plan_confirm.yaml`:
- CRITICAL directive requiring `/spec_kit:implement` routing for free-text requests
- Gate 3 re-evaluation requirement for implementation phase
- Explicit statement that plan and implementation are separate gate-checked workflows

### Fix D: plan.md Command Enforcement Note

Added enforcement blockquote after the termination statement:
- Routes free-text implement requests through the command system
- States plan and implementation are separate gate-checked phases

## Files Changed

| File | Change |
|------|--------|
| `AGENTS.md` (Gate 3, lines ~147) | Added PHASE BOUNDARY rule (5 lines) |
| `AGENTS.md` (Memory Save Rule, lines ~184) | Scoped carry-over to memory saves only (2 lines changed) |
| `.opencode/command/spec_kit/plan.md` (line 121) | Added enforcement blockquote (3 lines) |
| `.opencode/command/spec_kit/assets/spec_kit_plan_auto.yaml` (line 428) | Added `enforcement:` block (7 lines) |
| `.opencode/command/spec_kit/assets/spec_kit_plan_confirm.yaml` (line 480) | Added `enforcement:` block (7 lines) |

## Upgrade

No action required beyond pulling latest. Changes are instruction-text only (no code, no config). Active sessions should be restarted to pick up the updated AGENTS.md gate definitions.
